<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ì—°ë™ í…ŒìŠ¤íŠ¸ - ë§ˆì´ë°ì´í„° íˆ¬ì ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .api-test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #22c55e; }
        .status-error { background: #ef4444; }
        .status-loading { background: #f59e0b; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="api-test-container">
        <header class="header">
            <h1>ğŸ§ª API ì—°ë™ í…ŒìŠ¤íŠ¸</h1>
            <div class="naverpay-logo">
                <div class="logo-placeholder">Npay ì—°ë™ í…ŒìŠ¤íŠ¸</div>
            </div>
        </header>

        <!-- ì„œë²„ í—¬ìŠ¤ì²´í¬ -->
        <section class="test-section">
            <h2>ğŸš€ ì„œë²„ ìƒíƒœ í™•ì¸</h2>
            <button class="btn primary" onclick="testServerHealth()">ì„œë²„ í—¬ìŠ¤ì²´í¬</button>
            <div class="test-result" id="health-result">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>
        </section>

        <!-- Gemini AI API í…ŒìŠ¤íŠ¸ -->
        <section class="test-section">
            <h2>ğŸ¤– Gemini AI ì—°ë™ í…ŒìŠ¤íŠ¸</h2>
            <div class="form-group">
                <label for="gemini-api-key">Gemini API Key:</label>
                <input type="password" id="gemini-api-key" placeholder="ì‹¤ì œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <small>ë³´ì•ˆì„ ìœ„í•´ ì„ì‹œë¡œë§Œ ì‚¬ìš©ë˜ë©° ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
            </div>
            <button class="btn primary" onclick="testGeminiAPI()">Gemini AI í…ŒìŠ¤íŠ¸</button>
            <div class="test-result" id="gemini-result">API í‚¤ë¥¼ ì…ë ¥í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>
        </section>

        <!-- ì‹œì¥ ë°ì´í„° API í…ŒìŠ¤íŠ¸ -->
        <section class="test-section">
            <h2>ğŸ“Š ì‹œì¥ ë°ì´í„° ì—°ë™ í…ŒìŠ¤íŠ¸</h2>
            <div class="market-controls">
                <button class="btn secondary" onclick="testYahooFinance()">ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ í…ŒìŠ¤íŠ¸</button>
                <button class="btn secondary" onclick="testKISAPI()">KIS API í…ŒìŠ¤íŠ¸</button>
            </div>
            <div class="test-result" id="market-result">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>
        </section>

        <!-- í†µí•© íˆ¬ì ì œì•ˆ í…ŒìŠ¤íŠ¸ -->
        <section class="test-section">
            <h2>ğŸ¯ í†µí•© íˆ¬ì ì œì•ˆ í…ŒìŠ¤íŠ¸</h2>
            <div class="form-group">
                <label>í…ŒìŠ¤íŠ¸ í¬íŠ¸í´ë¦¬ì˜¤:</label>
                <textarea id="test-portfolio" readonly>ì‚¼ì„±ì „ì 10ì£¼, ì¹´ì¹´ì˜¤ 5ì£¼, ë„¤ì´ë²„ 3ì£¼</textarea>
            </div>
            <div class="form-group">
                <label>íˆ¬ìê¸ˆì•¡:</label>
                <input type="number" id="test-amount" value="10000000" readonly>
            </div>
            <button class="btn primary" onclick="testFullInvestmentAdvice()">í†µí•© íˆ¬ì ì œì•ˆ í…ŒìŠ¤íŠ¸</button>
            <div class="test-result" id="investment-result">Gemini API í‚¤ê°€ ì„¤ì •ëœ í›„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </section>

        <!-- ë„¤ì´ë²„í˜ì´ ì—°ë™ ì‹œë®¬ë ˆì´ì…˜ -->
        <section class="test-section">
            <h2>ğŸ’³ ë„¤ì´ë²„í˜ì´ ì—°ë™ ì‹œë®¬ë ˆì´ì…˜</h2>
            <div class="benefit-badge">
                <span class="badge-text">Npay ê²°ì œ ì‹œ ìµœëŒ€ 2% ì ë¦½</span>
            </div>
            <button class="btn npay-button" onclick="simulateNpayIntegration()">
                <span class="npay-logo">N</span>
                ë„¤ì´ë²„í˜ì´ ì—°ë™ ì‹œë®¬ë ˆì´ì…˜
            </button>
            <div class="test-result" id="npay-result">ë„¤ì´ë²„í˜ì´ ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</div>
        </section>

        <!-- ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ -->
        <section class="test-section">
            <h2>ğŸ”„ ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸</h2>
            <button class="btn primary" onclick="runFullSystemTest()" style="font-size: 16px; padding: 15px 30px;">
                ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            </button>
            <div class="test-result" id="system-result">ëª¨ë“  ê°œë³„ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œ í›„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>
        </section>
    </div>

    <script>
        let currentGeminiKey = '';
        const SERVER_URL = 'http://localhost:3001';

        // ìƒíƒœ í‘œì‹œ í—¬í¼
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClass = status === 'loading' ? 'status-loading' : 
                               status === 'success' ? 'status-success' : 'status-error';
            
            element.innerHTML = `<span class="status-indicator ${statusClass}"></span>${message}`;
        }

        // 1. ì„œë²„ í—¬ìŠ¤ì²´í¬
        async function testServerHealth() {
            updateStatus('health-result', 'loading', 'ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...');
            
            try {
                const response = await fetch(`${SERVER_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('health-result', 'success', 
                        `ì„œë²„ ì •ìƒ ë™ì‘ í™•ì¸!\n\nì‘ë‹µ ë°ì´í„°:\n${JSON.stringify(data, null, 2)}`);
                } else {
                    updateStatus('health-result', 'error', `ì„œë²„ ì˜¤ë¥˜: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('health-result', 'error', 
                    `ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}\n\nì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš” (í¬íŠ¸ 3001)`);
            }
        }

        // 2. Gemini AI API í…ŒìŠ¤íŠ¸
        async function testGeminiAPI() {
            const apiKey = document.getElementById('gemini-api-key').value.trim();
            
            if (!apiKey) {
                updateStatus('gemini-result', 'error', 'Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            currentGeminiKey = apiKey;
            updateStatus('gemini-result', 'loading', 'Gemini AI ì—°ë™ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘...');

            try {
                const testPrompt = `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë§ˆì´ë°ì´í„° íˆ¬ì ì œì•ˆ ì‹œìŠ¤í…œì˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. 
ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. "ì—°ê²° ì„±ê³µ"ì´ë¼ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.`;

                const response = await fetch(`${SERVER_URL}/api/investment-advice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        portfolio: { "í…ŒìŠ¤íŠ¸": { "shares": 1, "price": 1000 } },
                        riskLevel: 'moderate',
                        targetReturn: 5,
                        testPrompt: testPrompt
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    updateStatus('gemini-result', 'success', 
                        `Gemini AI ì—°ë™ ì„±ê³µ!\n\nAI ì‘ë‹µ:\n${data.advice}\n\nì£¼ì˜ì‚¬í•­: ${data.riskWarning}`);
                } else {
                    updateStatus('gemini-result', 'error', 
                        `Gemini AI ì—°ë™ ì‹¤íŒ¨:\n${data.error || data.message || 'Unknown error'}\n\nAPI í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                }
            } catch (error) {
                updateStatus('gemini-result', 'error', 
                    `Gemini AI í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}\n\në„¤íŠ¸ì›Œí¬ ì—°ê²° ë˜ëŠ” API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            }
        }

        // 3. ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ í…ŒìŠ¤íŠ¸
        async function testYahooFinance() {
            updateStatus('market-result', 'loading', 'ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ API í…ŒìŠ¤íŠ¸ ì¤‘...');

            try {
                const response = await fetch(`${SERVER_URL}/api/yahoo-finance/005930.KS`);
                const data = await response.json();

                if (response.ok) {
                    updateStatus('market-result', 'success', 
                        `ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ ì—°ë™ ì„±ê³µ!\n\nì‚¼ì„±ì „ì ë°ì´í„°:\n${JSON.stringify(data, null, 2)}`);
                } else {
                    updateStatus('market-result', 'error', `ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ ì˜¤ë¥˜: ${data.error}`);
                }
            } catch (error) {
                updateStatus('market-result', 'error', 
                    `ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}\n\nCORS ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            }
        }

        // 4. KIS API í…ŒìŠ¤íŠ¸
        async function testKISAPI() {
            updateStatus('market-result', 'loading', 'KIS API í…ŒìŠ¤íŠ¸ ì¤‘...');

            try {
                const response = await fetch(`${SERVER_URL}/api/kis-token`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateStatus('market-result', 'success', 
                        `KIS API í† í° ë°œê¸‰ ì„±ê³µ!\n\ní† í° ì •ë³´:\n${JSON.stringify(data, null, 2)}`);
                } else {
                    updateStatus('market-result', 'error', 
                        `KIS API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\n${data.error}\n\nKIS API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                }
            } catch (error) {
                updateStatus('market-result', 'error', `KIS API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // 5. í†µí•© íˆ¬ì ì œì•ˆ í…ŒìŠ¤íŠ¸
        async function testFullInvestmentAdvice() {
            if (!currentGeminiKey) {
                updateStatus('investment-result', 'error', 'ë¨¼ì € Gemini API í…ŒìŠ¤íŠ¸ë¥¼ ì„±ê³µí•´ì£¼ì„¸ìš”.');
                return;
            }

            updateStatus('investment-result', 'loading', 'í†µí•© íˆ¬ì ì œì•ˆì„ ìƒì„±í•˜ëŠ” ì¤‘...');

            try {
                const portfolio = {
                    "ì‚¼ì„±ì „ì": { "shares": 10, "price": 71900 },
                    "ì¹´ì¹´ì˜¤": { "shares": 5, "price": 54200 },
                    "ë„¤ì´ë²„": { "shares": 3, "price": 195000 }
                };

                const marketData = {
                    "ì‚¼ì„±ì „ì": { "price": 71900, "change": 1100, "changePercent": 1.55 },
                    "ì¹´ì¹´ì˜¤": { "price": 54200, "change": -800, "changePercent": -1.45 },
                    "ë„¤ì´ë²„": { "price": 195000, "change": 2500, "changePercent": 1.30 }
                };

                const response = await fetch(`${SERVER_URL}/api/investment-advice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': currentGeminiKey
                    },
                    body: JSON.stringify({
                        portfolio: portfolio,
                        riskLevel: 'moderate',
                        targetReturn: 8,
                        marketData: marketData
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    updateStatus('investment-result', 'success', 
                        `í†µí•© íˆ¬ì ì œì•ˆ ì„±ê³µ!\n\nAI ì œì•ˆ:\n${data.advice}\n\nìœ„í—˜ ê³ ì§€: ${data.riskWarning}`);
                } else {
                    updateStatus('investment-result', 'error', 
                        `í†µí•© íˆ¬ì ì œì•ˆ ì‹¤íŒ¨:\n${data.error || data.message}`);
                }
            } catch (error) {
                updateStatus('investment-result', 'error', 
                    `í†µí•© íˆ¬ì ì œì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // 6. ë„¤ì´ë²„í˜ì´ ì—°ë™ ì‹œë®¬ë ˆì´ì…˜
        function simulateNpayIntegration() {
            updateStatus('npay-result', 'loading', 'ë„¤ì´ë²„í˜ì´ ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ ê²€ì¦ ì¤‘...');

            setTimeout(() => {
                const brandChecklist = [
                    'âœ… Npay Green (#03C75A) ìƒ‰ìƒ ì ìš© í™•ì¸',
                    'âœ… ì‹œê·¸ë‹ˆì²˜ ë¡œê³  ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜',
                    'âœ… í˜œíƒ ë°°ì§€ ì˜¬ë°”ë¥¸ í‘œì‹œ',
                    'âœ… ë²„íŠ¼ ë””ìì¸ ë¸Œëœë“œ ê°€ì´ë“œ ì¤€ìˆ˜',
                    'âœ… ì´ìš©ì•½ê´€ ë° ë©´ì±…ì¡°í•­ í¬í•¨',
                    'âœ… ë°˜ì‘í˜• ë””ìì¸ ì ìš©',
                    '',
                    'ğŸ¯ ë„¤ì´ë²„í˜ì´ ì—°ë™ ì¤€ë¹„ ì™„ë£Œ!',
                    'ì‹¤ì œ ì„œë¹„ìŠ¤ ì‹œ ê°€ì… ì‹¬ì‚¬ ë° ê²°ì œ ì„œë¹„ìŠ¤ ì—°ë™ í•„ìš”'
                ];

                updateStatus('npay-result', 'success', brandChecklist.join('\n'));
            }, 1500);
        }

        // 7. ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸
        async function runFullSystemTest() {
            updateStatus('system-result', 'loading', 'ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ì¤‘...\n\në‹¨ê³„ë³„ ì§„í–‰ìƒí™©:');

            const tests = [
                { name: 'ì„œë²„ í—¬ìŠ¤ì²´í¬', func: testServerHealth },
                { name: 'Gemini AI ì—°ë™', func: testGeminiAPI },
                { name: 'ì‹œì¥ ë°ì´í„° ì—°ë™', func: testYahooFinance },
                { name: 'ë„¤ì´ë²„í˜ì´ ì‹œë®¬ë ˆì´ì…˜', func: simulateNpayIntegration }
            ];

            let results = [];
            let allPassed = true;

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                updateStatus('system-result', 'loading', 
                    `ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...\n\n[${i + 1}/${tests.length}] ${test.name} ì‹¤í–‰ ì¤‘...`);
                
                try {
                    await test.func();
                    results.push(`âœ… ${test.name}: ì„±ê³µ`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    results.push(`âŒ ${test.name}: ì‹¤íŒ¨ - ${error.message}`);
                    allPassed = false;
                }
            }

            const finalResult = allPassed ? 
                `ğŸ‰ ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\n${results.join('\n')}\n\nâœ¨ ë§ˆì´ë°ì´í„° íˆ¬ì ì œì•ˆ ì‹œìŠ¤í…œì´ ì™„ì „íˆ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!` :
                `âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n\n${results.join('\n')}\n\nì‹¤íŒ¨í•œ í•­ëª©ì„ ê°œë³„ì ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”.`;

            updateStatus('system-result', allPassed ? 'success' : 'error', finalResult);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì„œë²„ ì²´í¬
        window.addEventListener('load', () => {
            setTimeout(testServerHealth, 1000);
        });
    </script>
</body>
</html>
