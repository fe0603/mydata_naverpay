<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버페이 마이데이터 AI 투자분석 - 맞춤형 포트폴리오 제안</title>
    
    <!-- 개발 중 캐시 방지 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="0">
    <meta http-equiv="If-Modified-Since" content="0">
    
    <!-- PWA 메타 태그 -->
    <meta name="description" content="네이버페이 연동 AI 기반 실시간 투자 리밸런싱 서비스">
    <meta name="theme-color" content="#03C75A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="마이데이터 투자">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA 매니페스트 (아이콘 오류 방지를 위해 임시 비활성화) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    
    <!-- 파비콘 및 아이콘 (기본 파비콘 사용) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>">
    
    <!-- 스타일시트 (캐시 방지) -->
    <link rel="stylesheet" href="style.css" id="main-css">
    
    <!-- 외부 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas 라이브러리 (HTML을 이미지로 변환) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- jsPDF 라이브러리 (PDF 생성용) - 개선된 로딩 시스템 -->
    <script>
        // jsPDF 라이브러리 동적 로딩 함수
        function loadJsPDFLibrary() {
            return new Promise((resolve, reject) => {
                console.log('📄 jsPDF 라이브러리 로딩 시작...');
                
                // 이미 로드되어 있는지 확인
                if (window.jsPDF) {
                    console.log('✅ jsPDF 이미 로드됨');
                    resolve(window.jsPDF);
                    return;
                }
                
                // CDN 목록 (더 안정적인 CDN들로 업데이트)
                const cdnList = [
                    // UMD 버전들 (가장 안정적)
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    // 구버전 (더 안정적)
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js',
                    'https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js',
                    // JSDelivr CDN
                    'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'https://cdn.jsdelivr.net/npm/jspdf@1.5.3/dist/jspdf.min.js',
                    // 최신 버전들 (마지막 시도)
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.min.js',
                    'https://unpkg.com/jspdf@latest/dist/jspdf.min.js'
                ];
                
                let cdnIndex = 0;
                
                function tryLoadCDN() {
                    if (cdnIndex >= cdnList.length) {
                        console.error('❌ 모든 jsPDF CDN 로딩 실패');
                        reject(new Error('모든 jsPDF CDN에서 로딩 실패'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[cdnIndex];
                    
                    script.onload = function() {
                        // 로딩 완료 후 여러 방법으로 jsPDF 확인
                        setTimeout(() => {
                            let jsPDFInstance = null;
                            
                            // 1. window.jsPDF 직접 확인
                            if (window.jsPDF) {
                                jsPDFInstance = window.jsPDF;
                                console.log(`✅ jsPDF CDN ${cdnIndex + 1} 로딩 성공 (window.jsPDF):`, cdnList[cdnIndex]);
                            }
                            // 2. window.jspdf 소문자 확인
                            else if (window.jspdf) {
                                jsPDFInstance = window.jspdf;
                                window.jsPDF = window.jspdf; // 대문자로 복사
                                console.log(`✅ jsPDF CDN ${cdnIndex + 1} 로딩 성공 (window.jspdf):`, cdnList[cdnIndex]);
                            }
                            // 3. 전역 네임스페이스에서 찾기
                            else if (typeof jsPDF !== 'undefined') {
                                jsPDFInstance = jsPDF;
                                window.jsPDF = jsPDF;
                                console.log(`✅ jsPDF CDN ${cdnIndex + 1} 로딩 성공 (global jsPDF):`, cdnList[cdnIndex]);
                            }
                            // 4. require 방식 시도
                            else if (typeof require !== 'undefined') {
                                try {
                                    jsPDFInstance = require('jspdf');
                                    window.jsPDF = jsPDFInstance;
                                    console.log(`✅ jsPDF CDN ${cdnIndex + 1} 로딩 성공 (require):`, cdnList[cdnIndex]);
                                } catch (e) {
                                    // require 실패
                                }
                            }
                            
                            if (jsPDFInstance) {
                                resolve(jsPDFInstance);
                            } else {
                                console.warn(`⚠️ CDN ${cdnIndex + 1} 스크립트 로드됐지만 jsPDF 정의되지 않음`);
                                console.log('   전역 객체들:', Object.keys(window).filter(key => key.toLowerCase().includes('pdf')));
                                cdnIndex++;
                                document.head.removeChild(script);
                                tryLoadCDN();
                            }
                        }, 200); // 지연시간 증가
                    };
                    
                    script.onerror = function() {
                        console.warn(`⚠️ jsPDF CDN ${cdnIndex + 1} 실패:`, cdnList[cdnIndex]);
                        document.head.removeChild(script);
                        cdnIndex++;
                        tryLoadCDN();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoadCDN();
            });
        }
        
        // 페이지 로드 완료 후 jsPDF 로딩
        window.addEventListener('DOMContentLoaded', function() {
            loadJsPDFLibrary()
                .then(() => {
                    console.log('🎉 jsPDF 라이브러리 초기화 완료');
                    window.jsPDFReady = true;
                })
                .catch(error => {
                    console.error('❌ jsPDF 라이브러리 로딩 실패:', error);
                    window.jsPDFReady = false;
                });
        });
        
        // 전역 jsPDF 로딩 함수 (필요시 재시도용)
        window.ensureJsPDFLoaded = loadJsPDFLibrary;
        
        // 종목 검색 기능
        async function searchStocks(query) {
            try {
                console.log(`🔍 종목 검색: ${query}`);
                const response = await fetch(`/api/naver-search/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    showSearchSuggestions(data.results);
                    return data.results;
                } else {
                    hideSearchSuggestions();
                    showQuickNotification(`"${query}" 검색 결과가 없습니다.`, 'warning');
                    return [];
                }
            } catch (error) {
                console.error('종목 검색 오류:', error);
                hideSearchSuggestions();
                showQuickNotification('종목 검색 중 오류가 발생했습니다.', 'error');
                return [];
            }
        }
        
        function showSearchSuggestions(results) {
            const suggestionsDiv = document.getElementById('search-suggestions');
            
            if (results.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            suggestionsDiv.innerHTML = results.map(stock => `
                <div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s;" 
                     onclick="selectStock('${stock.name}', '${stock.code}')"
                     onmouseover="this.style.backgroundColor='#f8f9fa'"
                     onmouseout="this.style.backgroundColor='white'">
                    <span style="font-weight: bold; color: #333;">${stock.name}</span>
                    <span style="font-size: 0.9em; color: #666; margin-left: 10px;">${stock.code}</span>
                    <span style="font-size: 0.8em; color: #999; margin-left: 10px;">${stock.market}</span>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        function hideSearchSuggestions() {
            const suggestionsDiv = document.getElementById('search-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function selectStock(name, code) {
            const portfolioInput = document.getElementById('current-portfolio');
            const currentValue = portfolioInput.value.trim();
            
            // 종목명과 기본 수량 추가
            const newStock = currentValue ? `, ${name} 1주` : `${name} 1주`;
            portfolioInput.value = currentValue + newStock;
            
            hideSearchSuggestions();
            portfolioInput.focus();
            
            showQuickNotification(`${name} (${code})이 추가되었습니다.`, 'success');
        }
        
        async function searchStockPrompt() {
            const query = prompt('검색할 종목명을 입력하세요:', '');
            if (query && query.trim()) {
                await searchStocks(query.trim());
            }
        }
    </script>
    <!-- 성능 최적화 (캐시 방지) -->
    <script src="optimize.js" id="optimize-js"></script>
    
    <!-- 개발 중 자동 캐시 방지 스크립트 -->
    <script>
        // 페이지 로드 시 CSS와 JS 파일에 타임스탬프 추가
        (function() {
            const timestamp = Date.now();
            
            // CSS 파일 캐시 방지
            const cssLink = document.getElementById('main-css');
            if (cssLink) {
                cssLink.href = `style.css?v=${timestamp}`;
            }
            
            // JS 파일 캐시 방지
            const jsScript = document.getElementById('optimize-js');
            if (jsScript) {
                jsScript.src = `optimize.js?v=${timestamp}`;
            }
            
            console.log(`🔄 캐시 방지 타임스탬프: ${timestamp}`);
        })();
    </script>
</head>
<body>
    <div class="container">
        <header class="header" style="background: linear-gradient(135deg, #03C75A 0%, #00B04F 100%); color: white; text-align: center;">
            <div class="naverpay-brand-header" style="padding: 30px 20px;">
                <!-- 네이버페이 시그니처 로고 (브랜드 가이드라인 준수) -->
                <div class="npay-logo-section" style="margin-bottom: 20px;">
                    <span class="npay-signature-logo" style="font-size: 48px; font-weight: bold; letter-spacing: 2px;">
                        N<span style="color: #FFFFFF;">pay</span>
                    </span>
                    <span class="brand-divider" style="margin: 0 15px; font-size: 24px; opacity: 0.8;">×</span>
                    <span class="service-name" style="font-size: 24px; font-weight: 500;">마이데이터</span>
                </div>
                
                <h1 style="margin: 0; font-size: 32px; font-weight: 700;">🚀 AI 투자 제안 시스템</h1>
                <p style="margin: 15px 0; font-size: 18px; opacity: 0.9;">네이버페이 마이데이터 기반 개인화 포트폴리오 분석 및 리밸런싱 서비스</p>
                
                <!-- 네이버페이 혜택 배지 (브랜드 가이드라인 적용) -->
                <div class="benefit-badges" style="margin-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <div class="benefit-badge primary" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.3);">
                        <span style="font-size: 16px;">💳 네이버페이 연결 시 <strong>최대 2% 적립</strong></span>
                    </div>
                    <div class="benefit-badge secondary" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2);">
                        <span style="font-size: 16px;">🔒 마이데이터 <strong>안전한 금융정보 관리</strong></span>
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- 1단계: 현재 포트폴리오 입력 -->
            <section class="section" id="portfolio-section">
                <h2>📊 현재 포트폴리오</h2>
                <div class="portfolio-form">
                    <div class="form-group">
                        <label for="current-portfolio">보유 종목 입력:</label>
                        <div class="portfolio-input-wrapper" style="position: relative;">
                            <textarea id="current-portfolio" placeholder="예시: 삼성전자 10주, 카카오 5, 네이버3 (주 단위 생략 가능)"></textarea>
                            <div class="search-suggestions" id="search-suggestions" 
                                style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <div class="input-helper" style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                            <button type="button" id="search-stocks-btn" onclick="searchStockPrompt()" 
                                style="background: #03C75A; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                🔍 종목 검색
                            </button>
                            <span style="font-size: 0.85em; color: #666;">모든 상장 종목을 검색할 수 있습니다</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="investment-amount">총 투자금액:</label>
                        <input type="number" id="investment-amount" placeholder="10000000" min="0">
                        <span class="unit">원</span>
                    </div>
                    <button class="btn primary" onclick="analyzePortfolioSimple()">포트폴리오 분석</button>
                </div>
            </section>

            <!-- 금융 면책조항 (중요 고지사항) -->
            <section class="section" id="disclaimer-section" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 15px; margin: 30px 0;">
                <div style="padding: 25px;">
                    <h2 style="color: #856404; margin-bottom: 20px; text-align: center;">⚠️ 투자 위험 고지 및 면책조항</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; border-left: 5px solid #dc3545;">
                            <h3 style="color: #721c24; margin-bottom: 15px;">🚨 필수 확인사항</h3>
                            <ul style="color: #721c24; line-height: 1.8; margin: 0; padding-left: 20px;">
                                <li><strong>원금 손실 위험:</strong> 모든 투자에는 원금 손실의 위험이 있으며, 투자 원금이 보장되지 않습니다.</li>
                                <li><strong>과거 성과 ≠ 미래 수익:</strong> 과거의 투자 성과가 미래의 수익률을 보장하지 않습니다.</li>
                                <li><strong>개인 책임:</strong> 최종 투자 결정은 투자자 본인의 판단과 책임으로 이루어져야 합니다.</li>
                                <li><strong>전문 상담 권고:</strong> 투자 전 반드시 금융 전문가와 상담하시기 바랍니다.</li>
                            </ul>
                        </div>
                        
                        <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 5px solid #17a2b8;">
                            <h3 style="color: #0c5460; margin-bottom: 15px;">📋 서비스 이용 안내</h3>
                            <ul style="color: #0c5460; line-height: 1.8; margin: 0; padding-left: 20px;">
                                <li>본 서비스는 <strong>투자 참고 정보</strong> 제공 목적이며, 투자 권유나 매매 지시가 아닙니다.</li>
                                <li>금융위원회의 승인 없이 실제 투자 권유를 하지 않습니다.</li>
                                <li>마이데이터 서비스는 금융위원회 규정 및 개인정보보호법에 따라 운영됩니다.</li>
                                <li>AI 분석 결과는 참고용이며, 시장 변동성을 완전히 예측할 수 없습니다.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: #e2e3e5; border-radius: 8px;">
                        <p style="margin: 0; font-size: 14px; color: #495057;">
                            <strong>🏛️ 규제기관:</strong> 금융위원회 | <strong>📞 금융소비자보호:</strong> 1332 | 
                            <strong>📅 고지일:</strong> <span id="disclaimer-date"></span> | 
                            <strong>🔒 서비스:</strong> 마이데이터 투자분석시스템
                        </p>
                    </div>
                </div>
            </section>

            <!-- 2단계: 실시간 시장 데이터 -->
            <section class="section" id="market-section">
                <h2>📈 실시간 시장 데이터</h2>
                <div class="market-controls">
                    <!-- 네이버 금융 데이터가 자동으로 로딩되므로 버튼 제거 -->
                </div>
                
                <div class="market-data" id="market-data">
                    <div class="loading" id="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>시장 데이터를 가져오는 중...</p>
                    </div>
                    
                    <div class="stock-grid" id="stock-grid">
                        <!-- 동적으로 생성될 주식 데이터 -->
                    </div>
                </div>
            </section>

            <!-- 3단계: 리밸런싱 제안 -->
            <section class="section" id="rebalancing-section">
                <h2>⚖️ 리밸런싱 제안</h2>
                
                <!-- 네이버페이 혜택 배지 -->
                <div class="benefit-badge">
                    <span class="badge-text">Npay 결제 시 최대 2% 적립</span>
                </div>
                
                <div class="rebalancing-controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="risk-level">위험 수준:</label>
                            <select id="risk-level">
                                <option value="conservative">안정형 (Conservative)</option>
                                <option value="moderate" selected>균형형 (Moderate)</option>
                                <option value="aggressive">공격형 (Aggressive)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="target-return">목표 수익률:</label>
                            <div class="input-with-unit">
                                <input type="number" id="target-return" placeholder="8" min="1" max="30">
                                <span class="unit">%</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn primary" onclick="generateRebalancingAdvice()">AI 리밸런싱 제안</button>
                </div>
                
                <div class="rebalancing-result" id="rebalancing-result">
                    <!-- AI 생성 리밸런싱 제안이 여기에 표시됩니다 -->
                </div>
                
                <!-- 차트 영역 -->
                <div class="chart-container">
                    <canvas id="portfolioChart" width="800" height="400"></canvas>
                </div>
            </section>

            <!-- 성능 모니터링 섹션 제거: 고객용 인터페이스에서는 불필요 -->

            <!-- 4단계: AI 투자 상담 챗봇 -->
            <section class="section" id="chatbot-section">
                <h2>💬 AI 투자 상담 챗봇</h2>
                <div class="chatbot-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; overflow: hidden; border: 1px solid #dee2e6;">
                    
                    <!-- 챗봇 헤더 -->
                    <div class="chatbot-header" style="background: linear-gradient(135deg, #03C75A 0%, #028a47 100%); padding: 20px; color: white;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="font-size: 24px;">🤖</span>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 18px;">AI 투자 상담사</h3>
                                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">투자 고민을 자연스럽게 상담해보세요</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="clearChatHistory()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    🗑️ 대화 초기화
                                </button>
                                <button onclick="toggleChatbot()" id="chatbot-toggle" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ➖ 최소화
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 챗봇 본문 -->
                    <div class="chatbot-body" id="chatbot-body" style="height: 400px; overflow-y: auto; padding: 20px; background: white;">
                        <div class="chat-messages" id="chat-messages">
                            <!-- AI 첫 인사말 -->
                            <div class="message ai-message" style="margin-bottom: 15px;">
                                <div style="display: flex; align-items: flex-start; gap: 10px;">
                                    <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                                        🤖
                                    </div>
                                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                                        안녕하세요! 저는 마이데이터 네이버페이 AI 투자 상담사입니다. 🎯<br><br>
                                        투자 목표, 위험 성향, 포트폴리오 구성 등 어떤 것이든 편하게 물어보세요!<br><br>
                                        <strong>예시 질문:</strong><br>
                                        💡 "안전한 투자 방법이 뭐가 있을까요?"<br>
                                        💡 "월 100만원 적금 vs 주식 투자 어떤게 좋을까요?"<br>
                                        💡 "삼성전자 주가 전망은 어떤가요?"
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 챗봇 입력창 -->
                    <div class="chatbot-input" style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6;">
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1; position: relative;">
                                <textarea 
                                    id="chat-input" 
                                    placeholder="투자 관련 질문을 입력하세요..." 
                                    style="width: 100%; min-height: 45px; max-height: 120px; padding: 12px 50px 12px 15px; border: 2px solid #dee2e6; border-radius: 25px; resize: none; font-size: 14px; line-height: 1.4; box-sizing: border-box; outline: none; transition: border-color 0.3s;"
                                    onkeypress="handleChatKeyPress(event)"
                                    onfocus="this.style.borderColor='#03C75A'"
                                    onblur="this.style.borderColor='#dee2e6'"
                                ></textarea>
                                <button 
                                    onclick="sendChatMessage()" 
                                    id="send-button"
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #03C75A; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: background-color 0.3s;"
                                    onmouseover="this.style.backgroundColor='#028a47'"
                                    onmouseout="this.style.backgroundColor='#03C75A'"
                                >
                                    ➤
                                </button>
                            </div>
                        </div>
                        
                        <!-- 빠른 질문 버튼들 -->
                        <div class="quick-questions" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="sendQuickQuestion('초보자 투자 가이드 알려주세요')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                💡 초보자 가이드
                            </button>
                            <button onclick="sendQuickQuestion('안전한 투자처 추천해주세요')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                🛡️ 안전 투자처
                            </button>
                            <button onclick="sendQuickQuestion('포트폴리오 리밸런싱 방법')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                ⚖️ 리밸런싱
                            </button>
                            <button onclick="sendQuickQuestion('ETF와 개별주식 차이점')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                📊 ETF vs 개별주식
                            </button>
                            <button onclick="sendQuickQuestion('월 적금 100만원 vs 주식 투자')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                💰 적금 vs 주식
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5단계: 액션 플랜 -->
            <section class="section" id="action-section">
                <h2>📋 실행 계획</h2>
                <div class="action-plan" id="action-plan">
                    <!-- 구체적인 매매 제안이 여기에 표시됩니다 -->
                </div>
                
                <div class="export-options">
                    <button class="btn secondary" onclick="exportToPDF()">📄 PDF 다운로드</button>
                    <button class="btn secondary" onclick="saveToLocalStorage()">📁 JSON 파일 저장</button>
                    <button class="btn primary npay-button" onclick="connectNpay()" style="background: linear-gradient(135deg, #03C75A 0%, #00B04F 100%); border: none; padding: 15px 30px; font-size: 16px; font-weight: 600; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                        <span class="npay-logo" style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 18px;">N</span>
                        <span>네이버페이 연결하기</span>
                        <span style="font-size: 12px; opacity: 0.8;">최대 2% 적립</span>
                    </button>
                </div>
            </section>
        </main>

        <!-- 면책조항 -->
        <footer class="disclaimer">
            <p>⚠️ <strong>투자 위험 고지:</strong> 모든 투자에는 원금 손실의 위험이 있습니다. 이 제안은 참고용이며, 실제 투자 결정은 신중히 하시기 바랍니다.</p>
            <p>📜 금융투자업법에 따라 투자 권유가 아닌 정보 제공 목적입니다.</p>
        </footer>
    </div>

    <!-- 모든 기능을 여기에 통합 -->
    <script>
        // 간단한 포트폴리오 분석 함수 (실시간 데이터)
        async function analyzePortfolioSimple() {
            console.log('🔍 실시간 포트폴리오 분석 시작');
            
            let portfolioText, investmentAmount;
            
            try {
                portfolioText = document.getElementById('current-portfolio').value;
                investmentAmount = document.getElementById('investment-amount').value;
                
                console.log('📊 입력값:', { portfolioText, investmentAmount });
                
                if (!portfolioText || !investmentAmount) {
                    alert('포트폴리오와 투자금액을 모두 입력해주세요.');
                    return;
                }
                
                // 로딩 표시
                showQuickNotification('실시간 주가 정보를 조회하고 있습니다...', 'info');
                
                // 실시간 포트폴리오 파싱
                const portfolio = await parsePortfolioQuick(portfolioText);
                const amount = parseInt(investmentAmount);
                
                console.log('📊 실시간 포트폴리오 데이터:', portfolio);
                
                // 결과 표시
                displayAnalysisResult(portfolio, amount);
                
                // 차트 생성
                createPortfolioChart(portfolio, amount);
                
                // 자동으로 시장 데이터 표시 (네이버 금융)
                console.log('📊 네이버 금융 시장 데이터 자동 로딩 시작');
                await fetchMarketData('naver');
                
                // 실행 계획 생성
                generateActionPlan(portfolio, amount);
                
                // 실시간 데이터 사용 여부 표시
                const realTimeCount = Object.values(portfolio).filter(stock => stock.isRealTime).length;
                const totalCount = Object.keys(portfolio).length;
                
                if (realTimeCount === totalCount) {
                    showQuickNotification(`✅ 분석 완료! (실시간 데이터 ${realTimeCount}/${totalCount})`, 'success');
                } else if (realTimeCount > 0) {
                    showQuickNotification(`⚠️ 분석 완료! (실시간 ${realTimeCount}/${totalCount}, 나머지는 추정가)`, 'warning');
                } else {
                    showQuickNotification('⚠️ 분석 완료! (추정 데이터 사용)', 'warning');
                }
                
                
            } catch (error) {
                console.error('❌ 포트폴리오 분석 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
                return;
            }
        }
        
        // AI 리밸런싱 제안 함수 (실제 Gemini API)
        async function generateRebalancingAdvice() {
            console.log('🤖 실제 AI 리밸런싱 제안 시작');
            
            try {
                // 요소 존재 확인 및 데이터 수집
                const riskElement = document.getElementById('risk-level');
                const targetReturnElement = document.getElementById('target-return');
                const portfolioElement = document.getElementById('current-portfolio');
                const investmentAmountElement = document.getElementById('investment-amount');
                
                if (!riskElement || !targetReturnElement || !portfolioElement || !investmentAmountElement) {
                    alert('필수 입력 항목이 누락되었습니다.');
                    return;
                }
                
                const riskTolerance = riskElement.value;
                const targetReturn = targetReturnElement.value;
                const portfolioText = portfolioElement.value;
                const investmentAmount = investmentAmountElement.value;
                
                console.log('📊 입력 데이터:', { riskTolerance, targetReturn, portfolioText, investmentAmount });
                
                if (!riskTolerance || !targetReturn || !portfolioText || !investmentAmount) {
                    alert('모든 필드를 입력해주세요.');
                    return;
                }
                
                // 로딩 표시
                const resultDiv = document.getElementById('rebalancing-result');
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p>🤖 AI가 최적의 리밸런싱 전략을 분석하고 있습니다...</p>
                        <p style="font-size: 0.9em; color: #666;">실시간 시장 데이터와 포트폴리오를 분석 중입니다.</p>
                        <div style="margin-top: 15px; font-size: 0.8em; color: #999;">
                            <span id="loading-dots">●</span>
                        </div>
                    </div>
                `;
                
                // 로딩 애니메이션
                let dotCount = 1;
                const loadingInterval = setInterval(() => {
                    const dots = '●'.repeat(dotCount % 4);
                    const dotsElement = document.getElementById('loading-dots');
                    if (dotsElement) {
                        dotsElement.textContent = dots;
                    }
                    dotCount++;
                }, 500);
                
                // 현재 포트폴리오 파싱 (실시간 데이터 포함)
                const portfolio = await parsePortfolioQuick(portfolioText);
                
                // Gemini AI API 호출 (실제 연동) - 서버 API 형식에 맞춤
                const requestData = {
                    userMessage: `포트폴리오 리밸런싱 조언을 요청합니다. 위험 성향: ${riskTolerance}, 목표 수익률: ${targetReturn}%, 총 투자금액: ${parseInt(investmentAmount).toLocaleString()}원`,
                    portfolioContext: {
                        hasPortfolio: true,
                        holdings: Object.entries(portfolio).map(([stock, data]) => ({
                            name: stock,
                            quantity: data.shares,
                            currentPrice: data.currentPrice,
                            totalValue: data.shares * data.currentPrice
                        })),
                        riskTolerance: riskTolerance,
                        targetReturn: parseFloat(targetReturn),
                        investmentAmount: parseInt(investmentAmount),
                        portfolioText: portfolioText
                    },
                    chatHistory: [],
                    timestamp: new Date().toISOString()
                };
                
                console.log('🤖 Gemini AI API 호출 중... (실제 API 키 사용)');
                console.log('📊 요청 데이터:', requestData);
                
                const response = await fetch('/api/investment-advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ AI 리밸런싱 제안 완료');
                    
                    // 로딩 애니메이션 정리
                    clearInterval(loadingInterval);
                    
                    // AI 제안 결과 표시
                    resultDiv.innerHTML = `
                        <div class="ai-advice-container">
                            <h3 style="color: #03C75A; margin-bottom: 20px;">🤖 AI 리밸런싱 제안</h3>
                            <div class="advice-content" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; line-height: 1.6;">
                                ${markdownToHtml(result.advice)}
                            </div>
                            <div class="risk-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <strong>⚠️ 투자 위험 고지:</strong><br>
                                ${result.riskWarning}
                            </div>
                            <div class="api-info" style="font-size: 0.8em; color: #666; margin-top: 10px; text-align: right;">
                                생성 시간: ${new Date(result.timestamp).toLocaleString()}<br>
                                모델: ${result.apiUsage?.model || 'Gemini AI'} | 응답 길이: ${result.apiUsage?.responseLength || 'N/A'}자
                            </div>
                        </div>
                    `;
                    
                    showQuickNotification('✅ AI 리밸런싱 제안이 완료되었습니다!', 'success');
                } else {
                    console.error('❌ AI 제안 실패:', result.error);
                    
                    // 로딩 애니메이션 정리
                    clearInterval(loadingInterval);
                    
                    if (result.error.includes('API 키')) {
                        // API 키 없을 때 데모 제안 표시
                        showDemoRebalancingAdvice(riskTolerance);
                        showQuickNotification('⚠️ 데모 모드: 실제 API 키가 필요합니다', 'warning');
                    } else {
                        resultDiv.innerHTML = `
                            <div style="color: #dc3545; padding: 20px; text-align: center;">
                                <h4>❌ AI 제안 생성 실패</h4>
                                <p>${result.error}</p>
                                <button class="btn secondary" onclick="showDemoRebalancingAdvice('${riskTolerance}')">데모 제안 보기</button>
                            </div>
                        `;
                        showQuickNotification('❌ AI 제안 생성에 실패했습니다', 'error');
                    }
                }
                
            } catch (error) {
                console.error('AI 리밸런싱 제안 오류:', error);
                
                // 로딩 애니메이션 정리
                clearInterval(loadingInterval);
                
                const resultDiv = document.getElementById('rebalancing-result');
                resultDiv.innerHTML = `
                    <div style="color: #dc3545; padding: 20px; text-align: center;">
                        <h4>❌ 네트워크 오류</h4>
                        <p>AI 서비스에 연결할 수 없습니다: ${error.message}</p>
                        <button class="btn secondary" onclick="generateRebalancingAdvice()">다시 시도</button>
                    </div>
                `;
                showQuickNotification('❌ 네트워크 오류가 발생했습니다', 'error');
            }
        }
        
        // 데모 리밸런싱 제안 (백업용)
        function showDemoRebalancingAdvice(riskTolerance) {
            const resultDiv = document.getElementById('rebalancing-result');
            console.log('📊 데모 리밸런싱 제안 표시:', riskTolerance);
            
            if (!riskTolerance) {
                alert('위험도를 선택해주세요.');
                return;
            }
            
            try {
                // 상세한 리밸런싱 조언 생성
                const advice = {
                    conservative: `
                        <strong>안정 중심 포트폴리오 권장:</strong><br>
                        • 한국 국고채권 30%, 회사채 20%<br>
                        • 대형 우량주 (삼성전자, LG화학) 30%<br>
                        • 배당주 및 리츠 20%<br>
                        • 예상 수익률: 연 4-6%, 변동성 낮음
                    `,
                    moderate: `
                        <strong>균형 잡힌 포트폴리오 권장:</strong><br>
                        • 국내 주식 40% (대형주 25%, 중소형주 15%)<br>
                        • 해외 주식 20% (미국 ETF 위주)<br>
                        • 채권 30% (국고채, 회사채 혼합)<br>
                        • 대안투자 10% (리츠, 원자재)<br>
                        • 예상 수익률: 연 6-8%, 적정 변동성
                    `,
                    aggressive: `
                        <strong>성장 중심 포트폴리오 권장:</strong><br>
                        • 국내 성장주 40% (기술주, 바이오 포함)<br>
                        • 해외 성장주 30% (나스닥 ETF, 신흥국)<br>
                        • 테마주 20% (AI, 반도체, 신재생에너지)<br>
                        • 현금 10% (기회 투자용)<br>
                        • 예상 수익률: 연 8-12%, 높은 변동성 감수
                    `
                };
                
                const result = advice[riskTolerance] || "위험도에 맞는 조언을 생성할 수 없습니다.";
                console.log('📊 생성된 조언:', result);
                
                // 결과 표시
                const resultContainer = document.getElementById('rebalancing-result');
                console.log('📊 결과 컨테이너 찾기:', resultContainer);
                
                if (resultContainer) {
                    resultContainer.innerHTML = `
                        <div class="ai-advice" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #03C75A;">
                            <h4 style="color: #03C75A; margin-bottom: 15px;">🤖 AI 리밸런싱 조언</h4>
                            <p style="margin-bottom: 10px;"><strong>선택한 위험도:</strong> ${riskTolerance}</p>
                            <div style="margin-bottom: 15px; font-size: 16px; line-height: 1.6;">${markdownToHtml(result)}</div>
                            <p style="color: #e74c3c; font-size: 0.9em; margin: 0;">⚠️ 이는 예시 조언입니다. 실제 투자 결정 시 전문가와 상담하세요.</p>
                        </div>
                    `;
                    resultContainer.style.display = 'block';
                    
                    // 결과 영역으로 스크롤
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    console.log('✅ 결과 표시 및 스크롤 완료');
                } else {
                    console.error('❌ rebalancing-result 요소를 찾을 수 없습니다');
                    alert('결과를 표시할 영역을 찾을 수 없습니다.');
                }
                
                showQuickNotification('🤖 AI 리밸런싱 조언이 생성되었습니다!', 'success');
                console.log('✅ AI 리밸런싱 함수 완료');
                
            } catch (error) {
                console.error('❌ AI 리밸런싱 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 포트폴리오 차트 생성
        let portfolioChart = null;
        
        function createPortfolioChart(portfolio, totalAmount) {
            console.log('📊 차트 생성 시작');
            
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) {
                console.error('❌ 차트 캔버스를 찾을 수 없습니다');
                return;
            }
            
            // 기존 차트 삭제
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            // 데이터 준비
            const labels = Object.keys(portfolio);
            const data = Object.values(portfolio).map(stock => stock.shares * stock.currentPrice);
            const colors = [
                '#03C75A', // 네이버페이 그린
                '#FF6B6B', // 레드
                '#4ECDC4', // 터콰이즈
                '#45B7D1', // 블루
                '#96CEB4', // 민트
                '#FFEAA7', // 옐로우
                '#DDA0DD', // 퍼플
                '#F7DC6F'  // 골드
            ];
            
            try {
                portfolioChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '포트폴리오 구성',
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '📊 포트폴리오 자산 구성',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / totalAmount) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${value.toLocaleString()}원 (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const percentage = ((value / totalAmount) * 100).toFixed(1);
                                        return `${label}: ${value.toLocaleString()}원 (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 1500
                        }
                    }
                });
                
                console.log('✅ 차트 생성 완료');
                
            } catch (error) {
                console.error('❌ 차트 생성 오류:', error);
                
                // 차트 생성 실패 시 대체 메시지 표시
                ctx.style.display = 'none';
                const container = ctx.parentElement;
                container.innerHTML = `
                    <div style="height: 400px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6c757d; flex-direction: column;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📊</div>
                        <div>차트를 표시할 수 없습니다</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">데이터는 위의 분석 결과에서 확인하세요</div>
                    </div>
                `;
            }
        }
        
        // 성능 리포트 표시
        function showDetailedReport() {
            console.log('📊 상세 성능 리포트 요청');
            
            if (typeof getPerformanceReport === 'function') {
                const report = getPerformanceReport();
                
                const reportHtml = `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #03C75A; margin-bottom: 15px;">📊 성능 분석 리포트</h3>
                        <div style="margin-bottom: 15px;">
                            <h4>현재 상태:</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li>📈 페이지 로딩: ${report.현재_상태?.페이지_로딩 || 'N/A'}</li>
                                <li>⚡ 평균 로딩: ${report.현재_상태?.평균_로딩 || 'N/A'}</li>
                                <li>🌐 API 호출수: ${report.현재_상태?.API_호출수 || 0}</li>
                                <li>💾 메모리 사용량: ${report.현재_상태?.메모리_사용량 || 'N/A'}</li>
                                <li>📶 네트워크: ${report.현재_상태?.네트워크 || 'N/A'}</li>
                            </ul>
                        </div>
                        <div>
                            <h4>권장사항:</h4>
                            <ul>
                                ${report.권장사항?.map(suggestion => `<li>${suggestion}</li>`).join('') || '<li>데이터 수집 중...</li>'}
                            </ul>
                        </div>
                        <button onclick="this.parentElement.style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
                    </div>
                `;
                
                const existingReport = document.querySelector('.performance-report');
                if (existingReport) {
                    existingReport.remove();
                }
                
                const reportDiv = document.createElement('div');
                reportDiv.className = 'performance-report';
                reportDiv.innerHTML = reportHtml;
                
                const performanceSection = document.getElementById('performance-section');
                performanceSection.appendChild(reportDiv);
                
                reportDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('성능 리포트 시스템이 아직 로딩 중입니다. 잠시 후 다시 시도해주세요.');
            }
        }
        
        // 실시간 성능 메트릭 업데이트
        function updatePerformanceMetrics() {
            // 페이지 로딩 시간 업데이트
            if (typeof performance !== 'undefined' && performance.timing) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                if (loadTime > 0) {
                    document.getElementById('page-load-time').textContent = `${loadTime}ms`;
                }
            }
            
            // 메모리 사용량 업데이트
            if (performance.memory) {
                const memoryUsage = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memory-usage').textContent = `${memoryUsage}MB`;
            }
            
            // 네트워크 상태 업데이트
            if (navigator.connection) {
                const connection = navigator.connection;
                const networkType = connection.effectiveType || 'unknown';
                document.getElementById('network-status').textContent = networkType;
            }
        }
        
        // 개선된 포트폴리오 파싱 (실시간 가격 조회)
        async function parsePortfolioQuick(text) {
            const portfolio = {};
            const lines = text.split(/[,\n]/);
            
            // 주식 이름과 주수를 먼저 파싱
            const stockList = [];
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    // 패턴 1: "삼성전자 10주" 형태
                    let match = trimmed.match(/(.+?)\s*(\d+)\s*주/);
                    
                    if (match) {
                        const stockName = match[1].trim();
                        const shares = parseInt(match[2]);
                        stockList.push({ stockName, shares });
                    } else {
                        // 패턴 2: "삼성전자 10" 형태 (주 없이 숫자만)
                        match = trimmed.match(/(.+?)\s+(\d+)$/);
                        
                        if (match) {
                            const stockName = match[1].trim();
                            const shares = parseInt(match[2]);
                            stockList.push({ stockName, shares });
                        } else {
                            // 패턴 3: "삼성전자10" 형태 (공백 없이)
                            match = trimmed.match(/^(.+?)(\d+)$/);
                            
                            if (match && match[1].length > 1) { // 종목명이 최소 2글자 이상
                                const stockName = match[1].trim();
                                const shares = parseInt(match[2]);
                                
                                // 종목명이 숫자로만 구성되지 않은 경우에만 추가
                                if (!/^\d+$/.test(stockName)) {
                                    stockList.push({ stockName, shares });
                                }
                            }
                        }
                    }
                }
            });
            
            // 실시간 가격 조회 (병렬 처리)
            console.log('📊 실시간 가격 조회 시작...');
            const pricePromises = stockList.map(async ({ stockName, shares }) => {
                const priceData = await getRealTimePrice(stockName);
                return {
                    stockName,
                    shares,
                    currentPrice: priceData.price,
                    marketData: priceData
                };
            });
            
            try {
                const results = await Promise.all(pricePromises);
                results.forEach(({ stockName, shares, currentPrice, marketData }) => {
                    portfolio[stockName] = { 
                        shares, 
                        currentPrice,
                        marketData,
                        isRealTime: !marketData.fallback
                    };
                });
                
                console.log('📊 실시간 가격 조회 완료:', portfolio);
            } catch (error) {
                console.error('❌ 실시간 가격 조회 중 오류:', error);
                // 오류 시 백업 데이터 사용
                stockList.forEach(({ stockName, shares }) => {
                    portfolio[stockName] = { 
                        shares, 
                        currentPrice: getEstimatedPrice(stockName),
                        isRealTime: false
                    };
                });
            }
            
            return portfolio;
        }
        
        // 숫자를 한국식 쉼표 표기로 변환
        function formatKoreanNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // 실제 주식 가격 조회 (네이버 금융 API)
        async function getRealTimePrice(stockName) {
            try {
                console.log(`📊 실시간 가격 조회: ${stockName}`);
                
                const response = await fetch(`/api/naver-finance/${encodeURIComponent(stockName)}`);
                const data = await response.json();
                
                if (data.success && data.price > 0) {
                    console.log(`✅ ${stockName} 실시간 가격: ${data.price}원`);
                    return {
                        price: data.price,
                        change: data.change,
                        changePercent: data.changePercent,
                        volume: data.volume,
                        marketState: data.marketState,
                        lastUpdate: data.lastUpdateTime
                    };
                } else {
                    console.warn(`⚠️ ${stockName} 실시간 데이터 조회 실패, 기본값 사용`);
                    return { price: getEstimatedPrice(stockName), fallback: true };
                }
            } catch (error) {
                console.error(`❌ ${stockName} 가격 조회 오류:`, error);
                return { price: getEstimatedPrice(stockName), fallback: true };
            }
        }
        
        // 예상 주가 (백업용)
        function getEstimatedPrice(stockName) {
            const prices = {
                '삼성전자': 71900,
                '카카오': 54200,
                '네이버': 195000,
                'SK하이닉스': 128500,
                'LG화학': 378000,
                'NAVER': 195000,
                'Kakao': 54200
            };
            return prices[stockName] || 50000;
        }
        
        // 분석 결과 표시 (한국식 쉼표 표기 적용)
        function displayAnalysisResult(portfolio, totalAmount) {
            const stockGrid = document.getElementById('stock-grid');
            if (!stockGrid) return;
            
            let html = '<h3>📊 포트폴리오 분석 결과</h3>';
            let portfolioValue = 0;
            
            Object.entries(portfolio).forEach(([name, data]) => {
                const value = data.shares * data.currentPrice;
                portfolioValue += value;
                
                html += `
                    <div class="stock-card">
                        <h4>${name}</h4>
                        <p>보유: ${formatKoreanNumber(data.shares)}주</p>
                        <p>현재가: ${formatKoreanNumber(data.currentPrice)}원</p>
                        <p>평가금액: ${formatKoreanNumber(value)}원</p>
                        <p>비중: ${((value / totalAmount) * 100).toFixed(1)}%</p>
                    </div>
                `;
            });
            
            html += `
                <div class="analysis-summary">
                    <h4>💡 분석 요약</h4>
                    <p>총 투자금액: ${formatKoreanNumber(totalAmount)}원</p>
                    <p>현재 평가금액: ${formatKoreanNumber(portfolioValue)}원</p>
                    <p>손익: ${formatKoreanNumber(portfolioValue - totalAmount)}원</p>
                    <p>수익률: ${(((portfolioValue - totalAmount) / totalAmount) * 100).toFixed(2)}%</p>
                </div>
                
                <div class="ai-advice">
                    <h4>🤖 AI 투자 조언</h4>
                    <p>현재 포트폴리오는 기술주 중심으로 구성되어 있습니다.</p>
                    <p>적절한 분산투자가 이루어져 있으나, 섹터 집중도가 높습니다.</p>
                    <p>정기적인 리밸런싱을 통해 위험을 관리하시기 바랍니다.</p>
                    <p style="color: #e74c3c;">⚠️ 투자에는 원금 손실 위험이 있습니다.</p>
                </div>
            `;
            
            stockGrid.innerHTML = html;
            stockGrid.style.display = 'block';
        }
        
        // 빠른 알림 (타입별 색상 지원)
        function showQuickNotification(message, type = 'success') {
            const notification = document.createElement('div');
            
            // 타입별 색상 설정
            const colors = {
                success: '#03C75A',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            const backgroundColor = colors[type] || colors.success;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${backgroundColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                max-width: 300px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 애니메이션 효과
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 자동 제거
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // 포트폴리오 텍스트에서 종목명 추출 함수
        function extractStockNamesFromPortfolio(portfolioText) {
            const stockNames = [];
            if (!portfolioText) return stockNames;
            
            const lines = portfolioText.split(/[,\n]/);
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    // 패턴 1: "삼성전자 10주" 형태
                    let match = trimmed.match(/(.+?)\s*(\d+)\s*주/);
                    
                    if (match) {
                        const stockName = match[1].trim();
                        if (!stockNames.includes(stockName)) {
                            stockNames.push(stockName);
                        }
                    } else {
                        // 패턴 2: "삼성전자 10" 형태 (주 없이 숫자만)
                        match = trimmed.match(/(.+?)\s+(\d+)$/);
                        
                        if (match) {
                            const stockName = match[1].trim();
                            if (!stockNames.includes(stockName)) {
                                stockNames.push(stockName);
                            }
                        } else {
                            // 패턴 3: "삼성전자10" 형태 (공백 없이)
                            match = trimmed.match(/^(.+?)(\d+)$/);
                            
                            if (match && match[1].length > 1) { // 종목명이 최소 2글자 이상
                                const stockName = match[1].trim();
                                
                                // 종목명이 숫자로만 구성되지 않은 경우에만 추가
                                if (!/^\d+$/.test(stockName) && !stockNames.includes(stockName)) {
                                    stockNames.push(stockName);
                                }
                            }
                        }
                    }
                }
            });
            
            return stockNames;
        }
        
        // 시장 데이터 가져오기 함수
        async function fetchMarketData(source) {
            console.log(`📊 시장 데이터 가져오기: ${source}`);
            
            try {
                const loadingDiv = document.getElementById('loading');
                const stockGrid = document.getElementById('stock-grid');
                
                // 로딩 표시
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (stockGrid) stockGrid.innerHTML = '';
                
                showQuickNotification(`${source} 데이터를 가져오는 중...`, 'info');
                
                // 사용자가 입력한 포트폴리오에서 종목 추출
                const portfolioText = document.getElementById('current-portfolio')?.value || '';
                const stockNames = extractStockNamesFromPortfolio(portfolioText);
                
                if (stockNames.length === 0) {
                    showQuickNotification('⚠️ 보유 종목을 먼저 입력해주세요', 'warning');
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    return;
                }
                
                console.log('📊 추출된 종목 리스트:', stockNames);
                let results = [];
                
                if (source === 'naver') {
                    // 네이버 금융 API 호출
                    for (const stockName of stockNames) {
                        const response = await fetch(`/api/naver-finance/${encodeURIComponent(stockName)}`);
                        const data = await response.json();
                        results.push({
                            name: stockName,
                            price: data.price || 0,
                            change: data.change || 0,
                            changePercent: data.changePercent || 0,
                            volume: data.volume || 0,
                            source: data.isRealTime ? '네이버 금융 (실시간)' : '네이버 금융 (지연)',
                            success: data.success,
                            isRealTime: data.isRealTime || false
                        });
                    }
                } else if (source === 'kis') {
                    // KIS API는 미구현이므로 샘플 데이터
                    showQuickNotification('KIS API는 준비 중입니다. 샘플 데이터를 표시합니다.', 'warning');
                    results = [
                        { name: '삼성전자', price: 71900, change: -800, changePercent: -1.1, volume: 12456789, source: 'KIS API (Demo)', success: true },
                        { name: '카카오', price: 54200, change: 600, changePercent: 1.12, volume: 8765432, source: 'KIS API (Demo)', success: true },
                        { name: '네이버', price: 195000, change: -2000, changePercent: -1.02, volume: 3456789, source: 'KIS API (Demo)', success: true }
                    ];
                } else if (source === 'sample') {
                    // 샘플 데이터
                    results = [
                        { name: '삼성전자', price: 72000, change: 100, changePercent: 0.14, volume: 10000000, source: '샘플 데이터', success: true },
                        { name: '카카오', price: 55000, change: -300, changePercent: -0.54, volume: 5000000, source: '샘플 데이터', success: true },
                        { name: '네이버', price: 200000, change: 3000, changePercent: 1.52, volume: 2000000, source: '샘플 데이터', success: true }
                    ];
                }
                
                // 결과 표시
                displayMarketData(results);
                
                // 로딩 숨기기
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                showQuickNotification(`${source} 데이터 로딩 완료!`, 'success');
                
            } catch (error) {
                console.error('❌ 시장 데이터 가져오기 오류:', error);
                showQuickNotification('시장 데이터 로딩 실패: ' + error.message, 'error');
                
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }
        
        // 시장 데이터 표시 함수
        function displayMarketData(results) {
            const stockGrid = document.getElementById('stock-grid');
            if (!stockGrid) return;
            
            let html = '';
            results.forEach(stock => {
                const changeColor = stock.change >= 0 ? '#03C75A' : '#dc3545';
                const changeIcon = stock.change >= 0 ? '▲' : '▼';
                
                html += `
                    <div class="stock-card" style="border: 1px solid #ddd; padding: 20px; margin: 10px; border-radius: 8px; background: white;">
                        <h4 style="color: #333; margin-bottom: 10px;">${stock.name}</h4>
                        <p style="font-size: 1.5em; font-weight: bold; color: #333; margin: 5px 0;">
                            ${formatKoreanNumber(stock.price)}원
                        </p>
                        <p style="color: ${changeColor}; margin: 5px 0;">
                            ${changeIcon} ${formatKoreanNumber(Math.abs(stock.change))}원 (${stock.changePercent}%)
                        </p>
                        <p style="color: #666; font-size: 0.9em; margin: 5px 0;">
                            거래량: ${formatKoreanNumber(stock.volume)}
                        </p>
                        <p style="color: #999; font-size: 0.8em; margin: 5px 0;">
                            출처: ${stock.source} ${stock.isRealTime ? '🟢 실시간' : '🟡 지연'}
                        </p>
                    </div>
                `;
            });
            
            stockGrid.innerHTML = html;
            stockGrid.style.display = 'grid';
        }
        
        // 실행 계획 생성 함수
        function generateActionPlan(portfolio, totalAmount) {
            console.log('📋 실행 계획 생성 시작');
            
            const actionPlanDiv = document.getElementById('action-plan');
            if (!actionPlanDiv) {
                console.error('❌ action-plan 요소를 찾을 수 없습니다');
                return;
            }
            
            // 포트폴리오 분석
            const stocks = Object.entries(portfolio);
            const totalValue = stocks.reduce((sum, [name, data]) => sum + (data.shares * data.currentPrice), 0);
            
            // 종목별 비중 계산
            const stockWeights = stocks.map(([name, data]) => ({
                name,
                shares: data.shares,
                value: data.shares * data.currentPrice,
                weight: ((data.shares * data.currentPrice) / totalValue * 100).toFixed(1),
                currentPrice: data.currentPrice
            })).sort((a, b) => b.value - a.value);
            
            let actionPlanHTML = `
                <div class="action-plan-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <div class="plan-header" style="margin-bottom: 20px;">
                        <h3 style="color: #03C75A; display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="background: #03C75A; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">📋</span>
                            구체적 실행 계획
                        </h3>
                        <p style="color: #6c757d; margin: 0; font-size: 14px;">현재 포트폴리오 분석 결과를 바탕으로 한 단계별 액션 플랜입니다.</p>
                    </div>
                    
                    <div class="current-analysis" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                        <h4 style="color: #17a2b8; margin-bottom: 15px;">📊 포트폴리오 현황 분석</h4>
                        <div class="stock-breakdown">
            `;
            
            // 종목별 상세 정보와 권장사항
            stockWeights.forEach((stock, index) => {
                const isOverweight = parseFloat(stock.weight) > 35;
                const isUnderweight = parseFloat(stock.weight) < 15;
                let recommendation = '✅ 적정 비중 유지';
                let actionColor = '#28a745';
                
                if (isOverweight) {
                    recommendation = '🔻 부분 매도 권장';
                    actionColor = '#dc3545';
                } else if (isUnderweight && parseFloat(stock.weight) > 5) {
                    recommendation = '🔺 추가 매수 고려';
                    actionColor = '#ffc107';
                }
                
                actionPlanHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f3f4;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${stock.name}</div>
                            <div style="font-size: 12px; color: #6c757d;">${stock.shares}주 @ ${formatKoreanNumber(stock.currentPrice)}원</div>
                        </div>
                        <div style="text-align: center; flex: 0 0 80px;">
                            <div style="font-size: 18px; font-weight: bold; color: #03C75A;">${stock.weight}%</div>
                        </div>
                        <div style="text-align: right; flex: 0 0 100px;">
                            <div style="font-weight: bold; margin-bottom: 4px;">${formatKoreanNumber(stock.value)}원</div>
                            <div style="font-size: 11px; color: ${actionColor}; font-weight: 500;">${recommendation}</div>
                        </div>
                    </div>
                `;
            });
            
            // 구체적인 액션 플랜 생성
            let actions = [];
            
            stockWeights.forEach(stock => {
                if (parseFloat(stock.weight) > 35) {
                    const reduceShares = Math.ceil(stock.shares * 0.25);
                    actions.push({
                        priority: 1,
                        type: 'SELL',
                        stock: stock.name,
                        shares: reduceShares,
                        amount: reduceShares * stock.currentPrice,
                        reason: `비중 ${stock.weight}% → 과도한 집중 리스크`
                    });
                }
                
                if (parseFloat(stock.weight) < 15 && parseFloat(stock.weight) > 5) {
                    const addShares = Math.ceil(stock.shares * 0.3);
                    actions.push({
                        priority: 2,
                        type: 'BUY',
                        stock: stock.name,
                        shares: addShares,
                        amount: addShares * stock.currentPrice,
                        reason: `비중 ${stock.weight}% → 균형 개선 필요`
                    });
                }
            });
            
            actionPlanHTML += `
                        </div>
                    </div>
                    
                    <div class="action-steps" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">🎯 실행 단계</h4>
            `;
            
            if (actions.length === 0) {
                actionPlanHTML += `
                    <div style="text-align: center; padding: 20px; color: #28a745;">
                        <div style="font-size: 48px; margin-bottom: 10px;">✅</div>
                        <h5 style="margin-bottom: 10px;">포트폴리오가 잘 균형잡혀 있습니다!</h5>
                        <p style="color: #6c757d; margin: 0;">현재 상태를 유지하시고 정기적으로 리밸런싱을 검토하세요.</p>
                    </div>
                `;
            } else {
                actions.sort((a, b) => a.priority - b.priority);
                
                actions.forEach((action, index) => {
                    const stepNum = index + 1;
                    const typeIcon = action.type === 'SELL' ? '📉' : '📈';
                    const typeColor = action.type === 'SELL' ? '#dc3545' : '#03C75A';
                    const actionText = action.type === 'SELL' ? '매도' : '매수';
                    
                    actionPlanHTML += `
                        <div class="action-step" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: flex-start;">
                            <div style="background: ${typeColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; flex-shrink: 0;">
                                ${stepNum}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${typeIcon} ${action.stock} ${action.shares}주 ${actionText}
                                </div>
                                <div style="font-size: 13px; color: #6c757d; margin-bottom: 5px;">
                                    💰 예상 금액: ${formatKoreanNumber(action.amount)}원
                                </div>
                                <div style="font-size: 12px; color: #856404; background: #fff3cd; padding: 5px 8px; border-radius: 4px; display: inline-block;">
                                    💡 ${action.reason}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            actionPlanHTML += `
                    </div>
                    
                    <div class="timeline" style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #6f42c1;">
                        <h4 style="color: #6f42c1; margin-bottom: 15px;">⏰ 실행 일정</h4>
                        <div class="timeline-item" style="margin-bottom: 15px; display: flex; align-items: center;">
                            <div style="background: #dc3545; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold;">오늘</div>
                            <div>
                                <strong>우선순위 매도 주문 실행</strong>
                                <div style="font-size: 12px; color: #6c757d;">시장 개장 후 1시간 이내 권장</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="margin-bottom: 15px; display: flex; align-items: center;">
                            <div style="background: #ffc107; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold;">+2일</div>
                            <div>
                                <strong>매도 대금 결제 후 재투자</strong>
                                <div style="font-size: 12px; color: #6c757d;">T+2일 결제 완료 후 매수 진행</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="display: flex; align-items: center;">
                            <div style="background: #28a745; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold;">+7일</div>
                            <div>
                                <strong>포트폴리오 재점검</strong>
                                <div style="font-size: 12px; color: #6c757d;">리밸런싱 효과 확인 및 추가 조정</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            actionPlanDiv.innerHTML = actionPlanHTML;
            console.log('✅ 구체적 실행 계획 생성 완료');
        }
        
        // PDF 디버깅 함수 제거됨 (사용자 인터페이스에 불필요)
        function debugPDFStatus_REMOVED() {
            console.log('🔍 PDF 라이브러리 디버깅 시작');
            console.log('1. window.jsPDF 존재 여부:', typeof window.jsPDF);
            console.log('2. window.jsPDF 내용:', window.jsPDF);
            console.log('3. window.jsPDFReady 상태:', window.jsPDFReady);
            
            showQuickNotification('🔍 PDF 디버깅 정보를 콘솔에서 확인하세요', 'info');
            
            if (window.jsPDF) {
                console.log('4. jsPDF 생성자 테스트 시도...');
                try {
                    let testPdf;
                    if (window.jsPDF.jsPDF) {
                        testPdf = new window.jsPDF.jsPDF();
                        console.log('5. ✅ UMD 형식으로 jsPDF 인스턴스 생성 성공');
                    } else if (typeof window.jsPDF === 'function') {
                        testPdf = new window.jsPDF();
                        console.log('5. ✅ 직접 생성자로 jsPDF 인스턴스 생성 성공');
                    }
                    
                    // 간단한 테스트 PDF 생성 시도
                    testPdf.text('Test PDF Generation - Success!', 20, 20);
                    testPdf.text('Generated at: ' + new Date().toLocaleString(), 20, 30);
                    console.log('6. ✅ 테스트 텍스트 추가 성공');
                    
                    // 실제 다운로드 테스트 (사용자 선택)
                    if (confirm('간단한 테스트 PDF를 다운로드하시겠습니까?\n(성공하면 실제 PDF 다운로드도 작동합니다)')) {
                        testPdf.save('마이데이터-jsPDF-테스트.pdf');
                        console.log('7. ✅ 테스트 PDF 다운로드 성공');
                        showQuickNotification('✅ 테스트 PDF 다운로드 성공! 실제 PDF 다운로드도 정상 작동합니다.', 'success');
                    }
                    
                    return true;
                } catch (error) {
                    console.log('5. ❌ jsPDF 인스턴스 생성 실패:', error);
                    showQuickNotification('❌ jsPDF 테스트 실패: ' + error.message, 'error');
                    return false;
                }
            } else {
                console.log('4. ❌ window.jsPDF가 정의되지 않음');
                
                // 자동 로딩 시도 옵션 제공
                const userChoice = confirm('jsPDF 라이브러리가 로드되지 않았습니다.\n\n옵션을 선택하세요:\n• 확인: 자동 로딩 재시도\n• 취소: 텍스트 파일 대안 사용');
                
                if (userChoice) {
                    showQuickNotification('⏳ jsPDF 자동 로딩 재시도 중...', 'info');
                    window.ensureJsPDFLoaded()
                        .then(() => {
                            showQuickNotification('✅ jsPDF 로딩 완료! 다시 디버깅해보세요.', 'success');
                            setTimeout(() => debugPDFStatus(), 500);
                        })
                        .catch(error => {
                            showQuickNotification('❌ jsPDF 자동 로딩 실패. 텍스트 파일 대안을 사용하세요.', 'error');
                            console.error('jsPDF 로딩 최종 실패:', error);
                        });
                } else {
                    showQuickNotification('💡 "📄 PDF 다운로드" 버튼을 누르면 텍스트 파일로 대신 다운로드됩니다.', 'info');
                }
            }
            
            // 로드된 스크립트 태그들 확인
            const scripts = document.querySelectorAll('script[src*="jspdf"]');
            console.log('8. 로드된 jsPDF 스크립트 개수:', scripts.length);
            scripts.forEach((script, index) => {
                console.log(`   스크립트 ${index + 1}:`, script.src, 'loaded:', !script.error);
            });
            
            return false;
        }
        
        // PDF 다운로드 함수 (한글 우선)
        function exportToPDF() {
            console.log('📄 PDF 내보내기 시작');
            
            // html2canvas와 jsPDF 확인
            if (typeof html2canvas === 'undefined') {
                console.error('❌ html2canvas 라이브러리 없음');
                showQuickNotification('❌ html2canvas 라이브러리가 로드되지 않았습니다.', 'error');
                return;
            }
            
            // jsPDF 라이브러리 확인 및 로딩
            if (!window.jsPDF) {
                console.log('⏳ jsPDF 라이브러리 로딩 중...');
                showQuickNotification('⏳ PDF 라이브러리 로딩 중...', 'info');
                
                window.ensureJsPDFLoaded()
                    .then(() => {
                        console.log('✅ PDF 라이브러리 로딩 완료, 한글 PDF 생성 시작');
                        generateKoreanPDF();
                    })
                    .catch(error => {
                        console.error('❌ PDF 라이브러리 로딩 실패:', error);
                        showQuickNotification('❌ PDF 라이브러리를 로드할 수 없습니다. 네트워크 연결을 확인해주세요.', 'error');
                    });
            } else {
                // 라이브러리가 이미 로드된 경우 - 한글 PDF 우선 시도
                console.log('✅ 라이브러리 확인됨, 한글 PDF 생성 시작');
                generateKoreanPDF()
                    .catch(error => {
                        console.error('❌ 한글 PDF 실패, 영문 PDF로 대체:', error);
                        showQuickNotification('❌ 한글 PDF 실패. 영문 PDF로 대체합니다.', 'warning');
                        generatePDF();
                    });
            }
        }
        
        // 동적 jsPDF 로딩 함수 (통합된 시스템 사용)
        function loadJsPDFDynamically() {
            showQuickNotification('⏳ PDF 라이브러리 재로딩 중...', 'info');
            
            // 기존 jsPDF 참조 제거
            window.jsPDF = undefined;
            window.jsPDFReady = false;
            
            // 기존 스크립트 제거
            const existingScripts = document.querySelectorAll('script[src*="jspdf"]');
            existingScripts.forEach(script => script.remove());
            
            // 통합된 로딩 시스템 사용
            window.ensureJsPDFLoaded()
                .then(() => {
                    console.log('✅ 재로딩 완료, PDF 생성 시작');
                    debugPDFStatus();
                    generatePDF();
                })
                .catch(error => {
                    console.error('❌ 재로딩 실패:', error);
                    showQuickNotification('❌ PDF 라이브러리 재로딩에 실패했습니다.', 'error');
                });
        }
        
        // 한글 지원 PDF 생성 함수 (HTML2Canvas 방식)
        function generateKoreanPDF() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('📄 한글 PDF 생성 시작 (HTML2Canvas 방식)');
                    showQuickNotification('📄 한글 PDF 생성 중... 잠시만 기다려주세요.', 'info');
                    
                    // 임시 PDF 콘텐츠 생성
                    const pdfContent = createPDFContent();
                    document.body.appendChild(pdfContent);
                    
                    // html2canvas로 이미지 변환 (폰트 오류 방지)
                    html2canvas(pdfContent, {
                        scale: 2, // 고해상도
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        width: 794, // A4 width (210mm at 96dpi * 3.78)
                        height: 1123, // A4 height (297mm at 96dpi * 3.78)
                        allowTaint: true,
                        foreignObjectRendering: false,
                        ignoreElements: function(element) {
                            // 폰트 로딩 문제가 있는 요소 무시
                            return element.tagName === 'LINK' && element.rel === 'stylesheet';
                        },
                        onclone: function(clonedDoc) {
                            // 클론된 문서에서 폰트 관련 스타일 정리
                            const style = clonedDoc.createElement('style');
                            style.textContent = `
                                * {
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif !important;
                                }
                                @font-face {
                                    font-family: 'NotoSansKR';
                                    src: local('Malgun Gothic'), local('Apple SD Gothic Neo'), local('Noto Sans CJK KR');
                                }
                            `;
                            clonedDoc.head.appendChild(style);
                        }
                    }).then(canvas => {
                        try {
                            // jsPDF로 PDF 생성 (다양한 방식 시도)
                            let pdf;
                            if (window.jsPDF && window.jsPDF.jsPDF) {
                                pdf = new window.jsPDF.jsPDF('p', 'mm', 'a4');
                            } else if (window.jsPDF && typeof window.jsPDF === 'function') {
                                pdf = new window.jsPDF('p', 'mm', 'a4');
                            } else {
                                throw new Error('jsPDF 생성자를 찾을 수 없습니다.');
                            }
                            
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 210; // A4 width in mm
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            let heightLeft = imgHeight;
                            let position = 0;
                            
                            // 첫 번째 페이지
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= 297; // A4 height
                            
                            // 추가 페이지가 필요한 경우
                            while (heightLeft >= 0) {
                                position = heightLeft - imgHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                                heightLeft -= 297;
                            }
                            
                            // 임시 콘텐츠 제거
                            document.body.removeChild(pdfContent);
                            
                            // PDF 저장
                            const fileName = `마이데이터_투자제안서_${new Date().toISOString().slice(0, 10)}.pdf`;
                            pdf.save(fileName);
                            
                            showQuickNotification('✅ 한글 PDF 다운로드 완료!', 'success');
                            console.log('✅ 한글 PDF 생성 완료:', fileName);
                            resolve();
                            
                        } catch (pdfError) {
                            document.body.removeChild(pdfContent);
                            throw pdfError;
                        }
                    }).catch(canvasError => {
                        document.body.removeChild(pdfContent);
                        throw canvasError;
                    });
                    
                } catch (error) {
                    console.error('❌ 한글 PDF 생성 오류:', error);
                    showQuickNotification('❌ 한글 PDF 생성 실패. 영문 PDF로 대체합니다.', 'error');
                    
                    // 영문 PDF로 대체
                    generatePDF().then(resolve).catch(reject);
                }
            });
        }
        
        // PDF 콘텐츠 HTML 생성 함수
        function createPDFContent() {
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: -9999px;
                left: -9999px;
                width: 794px;
                min-height: 1123px;
                background: white;
                padding: 40px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', '맑은 고딕', Arial, sans-serif;
                font-size: 14px;
                line-height: 1.6;
                color: #333;
                box-sizing: border-box;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            `;
            
            // 포트폴리오 정보 수집
            const portfolioText = document.getElementById('current-portfolio')?.value || '';
            const investmentAmount = document.getElementById('investment-amount')?.value || '';
            const targetReturn = document.getElementById('target-return')?.value || '';
            const riskLevel = document.getElementById('risk-level')?.value || '';
            const analysisResult = document.getElementById('analysis-result')?.innerText || '';
            const rebalancingResult = document.getElementById('rebalancing-result')?.innerText || '';
            const actionPlan = document.getElementById('action-plan')?.innerText || '';
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #03C75A; padding-bottom: 20px;">
                    <h1 style="color: #03C75A; margin: 0; font-size: 28px; font-weight: bold;">마이데이터 투자 제안서</h1>
                    <h2 style="color: #666; margin: 10px 0 0 0; font-size: 18px;">네이버페이 AI 투자 분석 시스템</h2>
                    <p style="margin: 10px 0 0 0; color: #999;">생성 일시: ${new Date().toLocaleString('ko-KR')}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #03C75A; border-bottom: 2px solid #03C75A; padding-bottom: 5px; margin-bottom: 15px;">📊 포트폴리오 현황</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>보유 종목:</strong> ${portfolioText || '미지정'}</p>
                        <p><strong>총 투자금액:</strong> ${investmentAmount ? Number(investmentAmount).toLocaleString() + '원' : '미지정'}</p>
                        <p><strong>목표 수익률:</strong> ${targetReturn || '미지정'}%</p>
                        <p><strong>위험 성향:</strong> ${riskLevel || '미지정'}</p>
                    </div>
                </div>
                
                ${analysisResult ? `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 15px;">📈 포트폴리오 분석 결과</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8;">
                        ${analysisResult}
                    </div>
                </div>
                ` : ''}
                
                ${rebalancingResult ? `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 5px; margin-bottom: 15px;">🤖 AI 리밸런싱 제안</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8;">
                        ${rebalancingResult}
                    </div>
                </div>
                ` : ''}
                
                ${actionPlan ? `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #6f42c1; border-bottom: 2px solid #6f42c1; padding-bottom: 5px; margin-bottom: 15px;">📋 실행 계획</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8;">
                        ${actionPlan}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 50px; border-top: 2px solid #dc3545; padding-top: 20px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">⚠️ 투자 위험 고지</h3>
                    <div style="font-size: 12px; line-height: 1.8; color: #666;">
                        <p><strong>• 모든 투자에는 원금 손실의 위험이 있습니다.</strong></p>
                        <p>• 이 제안은 참고용이며, 실제 투자 결정은 신중히 하시기 바랍니다.</p>
                        <p>• 금융투자업법에 따라 투자 권유가 아닌 정보 제공 목적입니다.</p>
                        <p>• 과거 수익률이 미래 수익률을 보장하지 않습니다.</p>
                        <p>• 투자 전 반드시 전문가와 상담하시기 바랍니다.</p>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <p><strong>📋 생성 정보</strong></p>
                            <p>• 생성 시스템: 마이데이터 네이버페이 투자 분석 시스템</p>
                            <p>• AI 모델: Gemini AI & 네이버 금융 API</p>
                            <p>• 생성 방식: HTML2Canvas + jsPDF (한글 완전 지원)</p>
                        </div>
                    </div>
                </div>
            `;
            
            return container;
        }
        
        // 기존 PDF 생성 함수 (영문 백업용)
        function generatePDF() {
            try {
                console.log('📄 PDF 생성 함수 시작');
                
                // jsPDF 라이브러리 확인
                if (!window.jsPDF) {
                    throw new Error('jsPDF 라이브러리가 로드되지 않았습니다.');
                }
                
                // jsPDF 생성자 확인 및 인스턴스 생성 (다양한 방식 시도)
                let pdf;
                
                // 1. UMD 형식 (jsPDF.jsPDF)
                if (window.jsPDF && window.jsPDF.jsPDF && typeof window.jsPDF.jsPDF === 'function') {
                    pdf = new window.jsPDF.jsPDF('p', 'mm', 'a4');
                    console.log('✅ UMD 형식 (jsPDF.jsPDF)으로 인스턴스 생성');
                }
                // 2. 직접 생성자 형식 (window.jsPDF가 함수)
                else if (window.jsPDF && typeof window.jsPDF === 'function') {
                    pdf = new window.jsPDF('p', 'mm', 'a4');
                    console.log('✅ 직접 생성자 (window.jsPDF)로 인스턴스 생성');
                }
                // 3. 기본 생성자 형식 (인자 없이)
                else if (window.jsPDF && typeof window.jsPDF === 'function') {
                    pdf = new window.jsPDF();
                    pdf.internal.pageSize.width = 210; // A4 width in mm
                    pdf.internal.pageSize.height = 297; // A4 height in mm
                    console.log('✅ 기본 생성자로 인스턴스 생성');
                }
                // 4. 전역 jsPDF 확인
                else if (typeof jsPDF !== 'undefined' && typeof jsPDF === 'function') {
                    pdf = new jsPDF('p', 'mm', 'a4');
                    console.log('✅ 전역 jsPDF로 인스턴스 생성');
                }
                // 5. 구버전 방식
                else if (window.jsPDF && window.jsPDF.API) {
                    pdf = new window.jsPDF.API('p', 'mm', 'a4');
                    console.log('✅ 구버전 API 방식으로 인스턴스 생성');
                }
                else {
                    throw new Error('jsPDF 생성자를 찾을 수 없습니다. 사용 가능한 형식: ' + 
                        Object.keys(window.jsPDF || {}).join(', '));
                }
                
                console.log('✅ jsPDF 인스턴스 생성 완료');
                
                // 한글 지원을 위해 기본 폰트를 helvetica로 설정하고, 
                // 한글 텍스트는 이미지나 간단한 형태로 처리
                pdf.setFont('helvetica');
                
                // 한글 텍스트를 영문 요약으로 변환하는 함수
                function generateEnglishSummary(koreanText) {
                    if (!koreanText) return 'No analysis data available.';
                    
                    // 한글 텍스트에서 숫자와 퍼센트, 원화 정보 추출
                    const numbers = koreanText.match(/[\d,]+/g) || [];
                    const percentages = koreanText.match(/\d+\.?\d*%/g) || [];
                    const amounts = koreanText.match(/[\d,]+원/g) || [];
                    
                    // 영문 요약 생성
                    let summary = 'PORTFOLIO ANALYSIS SUMMARY:\n\n';
                    
                    if (numbers.length > 0) {
                        summary += `Key Financial Figures: ${numbers.slice(0, 5).join(', ')}\n`;
                    }
                    
                    if (percentages.length > 0) {
                        summary += `Percentage Data: ${percentages.slice(0, 3).join(', ')}\n`;
                    }
                    
                    if (amounts.length > 0) {
                        summary += `Amount Data: ${amounts.slice(0, 3).join(', ')}\n`;
                    }
                    
                    // 기본 투자 조언 추가
                    summary += '\nRECOMMENDATIONS:\n';
                    summary += '• Consider portfolio diversification\n';
                    summary += '• Monitor market conditions regularly\n';
                    summary += '• Maintain risk management strategy\n';
                    summary += '• Review investment goals periodically\n';
                    
                    return summary;
                }
                
                // PDF 헤더 (완전 영문)
                pdf.setFontSize(20);
                pdf.setTextColor(3, 199, 90); // 네이버페이 그린
                pdf.text('MyData Investment Proposal Report', 20, 25);
                pdf.text('Naver Pay AI Investment Analysis System', 20, 32);
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Generated: ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}`, 20, 45);
                
                // 포트폴리오 분석 결과 추출 및 영문 변환
                const analysisResultDiv = document.getElementById('analysis-result');
                let yPosition = 60;
                
                console.log('📊 분석 결과 처리 시작');
                
                // 포트폴리오 정보 영문 요약 생성
                const portfolioText = document.getElementById('current-portfolio')?.value || '';
                const investmentAmount = document.getElementById('investment-amount')?.value || '';
                const targetReturn = document.getElementById('target-return')?.value || '';
                const riskLevel = document.getElementById('risk-level')?.value || '';
                
                // 1. Portfolio Summary Section
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.text('=== PORTFOLIO ANALYSIS SUMMARY ===', 20, yPosition);
                yPosition += 12;
                
                pdf.setFontSize(10);
                pdf.text(`Portfolio Holdings: ${portfolioText || 'Not specified'}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Investment Amount: ${investmentAmount ? investmentAmount.toLocaleString() + ' KRW' : 'Not specified'}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Target Return: ${targetReturn || 'Not specified'}%`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Risk Level: ${riskLevel || 'Not specified'}`, 20, yPosition);
                yPosition += 15;
                
                // 2. AI Analysis Results Section
                if (analysisResultDiv && analysisResultDiv.style.display !== 'none') {
                    pdf.setFontSize(14);
                    pdf.setTextColor(23, 162, 184);
                    pdf.text('=== AI ANALYSIS RESULTS ===', 20, yPosition);
                    yPosition += 12;
                    
                    const analysisText = analysisResultDiv.innerText || '';
                    const englishSummary = generateEnglishSummary(analysisText);
                    const summaryLines = englishSummary.split('\n');
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    
                    for (let line of summaryLines) {
                        if (line.trim() && yPosition < 250) {
                            const splitText = pdf.splitTextToSize(line.trim(), 170);
                            for (let textLine of splitText) {
                                pdf.text(textLine, 20, yPosition);
                                yPosition += 6;
                                if (yPosition > 250) break;
                            }
                        }
                    }
                    yPosition += 10;
                }
                
                if (analysisResultDiv && analysisResultDiv.style.display !== 'none') {
                    pdf.setFontSize(16);
                    pdf.setTextColor(23, 162, 184);
                    pdf.text('Portfolio Analysis Results', 20, yPosition);
                    yPosition += 15;
                    
                    // 분석 결과 텍스트 추출 및 변환 (한글 처리 개선)
                    const analysisText = extractTextFromHTML(analysisResultDiv.innerHTML);
                    console.log('📊 분석 텍스트 길이:', analysisText.length);
                    
                    if (analysisText && analysisText.trim()) {
                        const lines = analysisText.split('\n').filter(line => line.trim() !== '');
                        
                        pdf.setFontSize(10);
                        pdf.setTextColor(0, 0, 0);
                        
                        lines.forEach((line, index) => {
                            try {
                                if (yPosition > 270) { // 페이지 끝 근처에서 새 페이지
                                    pdf.addPage();
                                    yPosition = 20;
                                }
                                
                                // 한글 텍스트를 영문/숫자만 포함하도록 변환 (안전성을 위해)
                                const safeLine = convertToSafeText(line.trim());
                                if (safeLine) {
                                    // 긴 텍스트 줄바꿈 처리
                                    const maxWidth = 170;
                                    const splitText = pdf.splitTextToSize(safeLine, maxWidth);
                                    
                                    splitText.forEach(textLine => {
                                        pdf.text(textLine, 20, yPosition);
                                        yPosition += 5;
                                    });
                                    yPosition += 2;
                                }
                            } catch (lineError) {
                                console.warn('⚠️ 라인 처리 오류:', lineError, '라인:', line);
                            }
                        });
                    }
                }
                
                // AI 리밸런싱 제안 추가
                const rebalancingResultDiv = document.getElementById('rebalancing-result');
                if (rebalancingResultDiv && rebalancingResultDiv.style.display !== 'none') {
                    yPosition += 10;
                    
                    if (yPosition > 250) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(3, 199, 90);
                    pdf.text('AI 투자 조언', 20, yPosition);
                    yPosition += 15;
                    
                    const rebalancingText = rebalancingResultDiv.textContent || rebalancingResultDiv.innerText || '';
                    const rebalancingLines = rebalancingText.split('\n').filter(line => line.trim() !== '');
                    
                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    
                    rebalancingLines.forEach(line => {
                        if (yPosition > 270) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        
                        const maxWidth = 170;
                        const splitText = pdf.splitTextToSize(line.trim(), maxWidth);
                        
                        splitText.forEach(textLine => {
                            pdf.text(textLine, 20, yPosition);
                            yPosition += 4;
                        });
                        yPosition += 1;
                    });
                }
                
                // 실행 계획 추가
                const actionPlanDiv = document.getElementById('action-plan');
                if (actionPlanDiv && actionPlanDiv.innerHTML.trim() !== '') {
                    yPosition += 10;
                    
                    if (yPosition > 240) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(40, 167, 69);
                    pdf.text('실행 계획', 20, yPosition);
                    yPosition += 15;
                    
                    const actionText = actionPlanDiv.textContent || actionPlanDiv.innerText || '';
                    const actionLines = actionText.split('\n').filter(line => line.trim() !== '');
                    
                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    
                    actionLines.forEach(line => {
                        if (yPosition > 270) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        
                        const maxWidth = 170;
                        const splitText = pdf.splitTextToSize(line.trim(), maxWidth);
                        
                        splitText.forEach(textLine => {
                            pdf.text(textLine, 20, yPosition);
                            yPosition += 4;
                        });
                        yPosition += 1;
                    });
                }
                
                // 면책조항 추가 (영문)
                pdf.addPage();
                pdf.setFontSize(14);
                pdf.setTextColor(220, 53, 69);
                pdf.text('INVESTMENT RISK DISCLOSURE', 20, 25);
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                const disclaimerText = `
WARNING: Investment Risk Disclosure

• All investments carry the risk of principal loss.
• This proposal is for reference only; actual investment decisions should be made carefully.
• This is for informational purposes only, not investment solicitation per Financial Investment Services Act.
• Past performance does not guarantee future returns.
• Please consult with professionals before making investment decisions.

REPORT INFORMATION:
• Generated by: MyData Naver Pay AI Investment Analysis System
• Generated at: ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}
• AI Models: Gemini AI & Naver Finance API
• Report Language: English (Korean data converted)

TECHNICAL NOTES:
• Original Korean text converted to English summary for PDF compatibility
• All numerical data and percentages preserved from original analysis
• For full Korean content, please use the text file download option
                `;
                
                const disclaimerLines = disclaimerText.split('\n');
                let disclaimerY = 40;
                
                disclaimerLines.forEach(line => {
                    const splitText = pdf.splitTextToSize(line, 170);
                    splitText.forEach(textLine => {
                        pdf.text(textLine, 20, disclaimerY);
                        disclaimerY += 5;
                    });
                });
                
                // PDF 저장 (영문 파일명)
                const fileName = `MyData_Investment_Proposal_${new Date().toISOString().slice(0, 10)}.pdf`;
                pdf.save(fileName);
                
                showQuickNotification('✅ PDF 다운로드 완료!', 'success');
                console.log('✅ PDF 생성 및 다운로드 완료:', fileName);
                
            } catch (error) {
                console.error('❌ PDF 생성 오류:', error);
                showQuickNotification('❌ PDF 생성 실패. 텍스트 파일로 대체 다운로드를 시도합니다.', 'error');
                
                // PDF 실패 시 텍스트 파일 대안 제공
                fallbackTextDownload();
            }
        }
        
        // PDF 실패 시 텍스트 파일 대안 다운로드
        function fallbackTextDownload() {
            try {
                console.log('📄 텍스트 파일 대안 다운로드 시작');
                
                // 포트폴리오 분석 결과 수집
                const analysisResult = document.getElementById('analysis-result')?.innerText || '';
                const rebalancingResult = document.getElementById('rebalancing-result')?.innerText || '';
                const actionPlan = document.getElementById('action-plan')?.innerText || '';
                
                // 텍스트 파일 내용 생성
                const textContent = `
마이데이터 투자 제안서
생성 일시: ${new Date().toLocaleString('ko-KR')}
생성 시스템: 네이버페이 마이데이터 투자 분석 시스템

==================================================
📊 포트폴리오 분석 결과
==================================================
${analysisResult}

==================================================
🤖 AI 리밸런싱 제안
==================================================
${rebalancingResult}

==================================================
📋 실행 계획
==================================================
${actionPlan}

==================================================
⚠️ 면책조항
==================================================
• 이 투자 제안서는 AI 기반 분석 결과로 참고용입니다.
• 모든 투자에는 원금 손실의 위험이 있습니다.
• 투자 결정은 개인의 판단과 책임하에 이루어져야 합니다.
• 금융투자업법에 따라 투자 권유가 아닌 정보 제공 목적입니다.
• 과거 수익률이 미래 수익률을 보장하지 않습니다.
• 투자 전 반드시 전문가와 상담하시기 바랍니다.

생성 시스템: 마이데이터 네이버페이 투자 분석 시스템
AI 모델: Gemini AI & 네이버 금융 API
`;

                // 텍스트 파일 다운로드
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `마이데이터_투자제안서_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showQuickNotification('✅ 텍스트 파일 다운로드 완료! (PDF 대안)', 'success');
                console.log('✅ 텍스트 파일 대안 다운로드 완료');
                
            } catch (fallbackError) {
                console.error('❌ 텍스트 파일 대안도 실패:', fallbackError);
                showQuickNotification('❌ 모든 다운로드 방식이 실패했습니다. 브라우저 설정을 확인해주세요.', 'error');
            }
        }
        
        // 로컬 저장 함수 (JSON 파일 다운로드)
        function saveToLocalStorage() {
            console.log('💾 파일 저장 시작');
            
            try {
                showQuickNotification('📁 데이터 파일 생성 중...', 'info');
                
                const currentDate = new Date().toISOString();
                
                // 저장할 데이터 수집
                const portfolioData = {
                    timestamp: currentDate,
                    portfolio: document.getElementById('current-portfolio')?.value || '',
                    investmentAmount: document.getElementById('investment-amount')?.value || '',
                    targetReturn: document.getElementById('target-return')?.value || '',
                    riskLevel: document.getElementById('risk-level')?.value || '',
                    analysisResult: document.getElementById('analysis-result')?.innerHTML || '',
                    rebalancingResult: document.getElementById('rebalancing-result')?.innerHTML || '',
                    actionPlan: document.getElementById('action-plan')?.innerHTML || '',
                    marketData: document.getElementById('stock-grid')?.innerHTML || ''
                };
                
                // 바로 JSON 파일로 다운로드
                downloadAsJSONFile(portfolioData);
                
            } catch (error) {
                console.error('❌ 파일 저장 오류:', error);
                showQuickNotification('❌ 파일 저장 실패: ' + error.message, 'error');
            }
        }
        
        // JSON 파일로 다운로드 함수
        function downloadAsJSONFile(portfolioData) {
            try {
                console.log('📁 JSON 파일 다운로드 시작');
                
                // 사용자 친화적인 데이터 구조로 변환
                const exportData = {
                    exportInfo: {
                        title: '마이데이터 네이버페이 투자 분석 결과',
                        exportDate: new Date().toLocaleString('ko-KR'),
                        version: '1.0'
                    },
                    userInput: {
                        포트폴리오: portfolioData.portfolio,
                        투자금액: portfolioData.investmentAmount + '원',
                        목표수익률: portfolioData.targetReturn + '%',
                        위험성향: portfolioData.riskLevel
                    },
                    analysisResults: {
                        포트폴리오분석: extractTextFromHTML(portfolioData.analysisResult),
                        AI리밸런싱제안: extractTextFromHTML(portfolioData.rebalancingResult),
                        실행계획: extractTextFromHTML(portfolioData.actionPlan),
                        시장데이터: extractTextFromHTML(portfolioData.marketData)
                    },
                    metadata: {
                        저장시간: portfolioData.timestamp,
                        브라우저: navigator.userAgent,
                        시스템: '마이데이터 네이버페이 투자 분석 시스템'
                    }
                };
                
                // JSON 문자열로 변환 (보기 좋게 들여쓰기 적용)
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Blob 생성
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                
                // 다운로드 링크 생성
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // 파일명 생성 (날짜와 시간 포함)
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // HH-MM-SS
                const fileName = `마이데이터_투자분석_${dateStr}_${timeStr}.json`;
                
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                // 다운로드 실행
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URL 객체 정리
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                showQuickNotification(`📁 JSON 파일 다운로드 완료: ${fileName}`, 'success');
                console.log('✅ JSON 파일 다운로드 완료:', fileName);
                
            } catch (error) {
                console.error('❌ JSON 파일 다운로드 오류:', error);
                showQuickNotification('❌ JSON 파일 다운로드 실패: ' + error.message, 'error');
            }
        }
        
        // HTML에서 텍스트 추출 함수
        function extractTextFromHTML(htmlString) {
            if (!htmlString) return '';
            
            try {
                // 임시 div 요소 생성하여 HTML 파싱
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                
                // 텍스트만 추출하고 여러 공백을 하나로 정리
                const text = tempDiv.textContent || tempDiv.innerText || '';
                return text.replace(/\s+/g, ' ').trim();
                
            } catch (error) {
                console.error('❌ HTML 텍스트 추출 오류:', error);
                return htmlString; // 실패 시 원본 반환
            }
        }
        
        // PDF용 안전한 텍스트 변환 함수
        function convertToSafeText(text) {
            if (!text) return '';
            
            try {
                // 한글을 로마자로 변환하는 간단한 매핑
                const koreanMap = {
                    '포트폴리오': 'Portfolio',
                    '분석': 'Analysis', 
                    '결과': 'Result',
                    '투자': 'Investment',
                    '수익률': 'Return Rate',
                    '위험도': 'Risk Level',
                    '삼성전자': 'Samsung Electronics',
                    '네이버': 'Naver',
                    '카카오': 'Kakao',
                    '원': 'KRW',
                    '주': 'shares',
                    '매수': 'Buy',
                    '매도': 'Sell',
                    '보유': 'Hold',
                    '리밸런싱': 'Rebalancing',
                    '제안': 'Recommendation',
                    '현재가': 'Current Price',
                    '평가금액': 'Market Value',
                    '수익': 'Profit',
                    '손실': 'Loss',
                    '총': 'Total',
                    '평균': 'Average',
                    '비중': 'Weight',
                    '개': 'ea',
                    '안정형': 'Conservative',
                    '균형형': 'Moderate', 
                    '공격형': 'Aggressive'
                };
                
                let result = text;
                
                // 한글 단어를 영문으로 변환
                Object.keys(koreanMap).forEach(korean => {
                    const regex = new RegExp(korean, 'g');
                    result = result.replace(regex, koreanMap[korean]);
                });
                
                // 한글이 여전히 남아있으면 제거하거나 대체
                result = result.replace(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/g, '');
                
                // 연속된 공백 정리
                result = result.replace(/\s+/g, ' ').trim();
                
                // 빈 문자열이면 기본 텍스트 반환
                if (!result || result.length < 2) {
                    return '(Korean text - see JSON file for full content)';
                }
                
                return result;
                
            } catch (error) {
                console.error('❌ 텍스트 변환 오류:', error);
                return '(Text conversion error)';
            }
        }
        
        // 저장된 데이터 목록 표시 함수 (제거됨 - 파일 다운로드만 지원)
        /* function showSavedDataList() {
            try {
                const savedPortfolios = JSON.parse(localStorage.getItem('mydata_portfolios') || '[]');
                
                if (savedPortfolios.length === 0) {
                    showQuickNotification('💾 저장된 데이터가 없습니다', 'info');
                    return;
                }
                
                let listHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; max-width: 500px; max-height: 70vh; overflow-y: auto;">
                        <h4 style="color: #03C75A; margin-bottom: 20px; display: flex; align-items: center;">
                            <span style="margin-right: 10px;">💾</span>
                            저장된 분석 데이터 (${savedPortfolios.length}개)
                        </h4>
                        <div style="margin-bottom: 20px;">
                `;
                
                savedPortfolios.forEach((data, index) => {
                    const date = new Date(data.timestamp).toLocaleString('ko-KR');
                    const portfolioPreview = data.portfolio.substring(0, 30) + (data.portfolio.length > 30 ? '...' : '');
                    
                    listHTML += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #03C75A;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1; cursor: pointer;" onclick="loadSavedData(${index})">
                                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">${date}</div>
                                    <div style="font-size: 12px; color: #6c757d;">포트폴리오: ${portfolioPreview}</div>
                                    <div style="font-size: 12px; color: #6c757d;">투자금액: ${data.investmentAmount}원</div>
                                </div>
                                <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                    <button onclick="event.stopPropagation(); downloadSavedAsJSON(${index})" style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="JSON 파일로 다운로드">
                                        📁 JSON
                                    </button>
                                    <button onclick="event.stopPropagation(); loadSavedData(${index})" style="background: #03C75A; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="데이터 로드">
                                        📂 로드
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listHTML += `
                        </div>
                        <div style="text-align: center;">
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">닫기</button>
                            <button onclick="clearSavedData()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">전체 삭제</button>
                        </div>
                    </div>
                `;
                
                // 기존 모달 제거
                const existingModal = document.querySelector('[data-modal="saved-data"]');
                if (existingModal) existingModal.remove();
                
                // 새 모달 추가
                const modalDiv = document.createElement('div');
                modalDiv.setAttribute('data-modal', 'saved-data');
                modalDiv.innerHTML = listHTML;
                document.body.appendChild(modalDiv);
                
            } catch (error) {
                console.error('❌ 저장된 데이터 목록 표시 오류:', error);
                showQuickNotification('❌ 데이터 목록 로드 실패', 'error');
            }
        }*/
        
        // 저장된 데이터 로드 함수 (제거됨 - 파일 다운로드만 지원)
        /* function loadSavedData(index) {
            try {
                const savedPortfolios = JSON.parse(localStorage.getItem('mydata_portfolios') || '[]');
                const data = savedPortfolios[index];
                
                if (!data) {
                    showQuickNotification('❌ 데이터를 찾을 수 없습니다', 'error');
                    return;
                }
                
                // 폼 데이터 복원
                if (document.getElementById('current-portfolio')) {
                    document.getElementById('current-portfolio').value = data.portfolio;
                }
                if (document.getElementById('investment-amount')) {
                    document.getElementById('investment-amount').value = data.investmentAmount;
                }
                if (document.getElementById('target-return')) {
                    document.getElementById('target-return').value = data.targetReturn;
                }
                if (document.getElementById('risk-level')) {
                    document.getElementById('risk-level').value = data.riskLevel;
                }
                
                // 결과 데이터 복원
                if (data.analysisResult && document.getElementById('analysis-result')) {
                    document.getElementById('analysis-result').innerHTML = data.analysisResult;
                    document.getElementById('analysis-result').style.display = 'block';
                }
                if (data.rebalancingResult && document.getElementById('rebalancing-result')) {
                    document.getElementById('rebalancing-result').innerHTML = markdownToHtml(data.rebalancingResult);
                    document.getElementById('rebalancing-result').style.display = 'block';
                }
                if (data.actionPlan && document.getElementById('action-plan')) {
                    document.getElementById('action-plan').innerHTML = data.actionPlan;
                }
                if (data.marketData && document.getElementById('stock-grid')) {
                    document.getElementById('stock-grid').innerHTML = data.marketData;
                    document.getElementById('stock-grid').style.display = 'grid';
                }
                
                // 모달 닫기
                const modal = document.querySelector('[data-modal="saved-data"]');
                if (modal) modal.remove();
                
                showQuickNotification('✅ 저장된 데이터 로드 완료!', 'success');
                console.log('✅ 데이터 로드 완료:', new Date(data.timestamp).toLocaleString());
                
            } catch (error) {
                console.error('❌ 데이터 로드 오류:', error);
                showQuickNotification('❌ 데이터 로드 실패: ' + error.message, 'error');
            }
        }*/
        
        // 저장된 데이터를 JSON으로 다운로드하는 함수 (제거됨 - 파일 다운로드만 지원)
        /* function downloadSavedAsJSON(index) {
            try {
                const savedPortfolios = JSON.parse(localStorage.getItem('mydata_portfolios') || '[]');
                const data = savedPortfolios[index];
                
                if (!data) {
                    showQuickNotification('❌ 데이터를 찾을 수 없습니다', 'error');
                    return;
                }
                
                downloadAsJSONFile(data);
                
            } catch (error) {
                console.error('❌ 저장된 데이터 다운로드 오류:', error);
                showQuickNotification('❌ 다운로드 실패: ' + error.message, 'error');
            }
        }*/
        
        // 저장된 데이터 전체 삭제 함수 (제거됨 - 파일 다운로드만 지원)
        /* function clearSavedData() {
            if (confirm('저장된 모든 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                try {
                    localStorage.removeItem('mydata_portfolios');
                    
                    // 개별 세션 데이터도 삭제
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('mydata_session_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // 모달 닫기
                    const modal = document.querySelector('[data-modal="saved-data"]');
                    if (modal) modal.remove();
                    
                    showQuickNotification('🗑️ 모든 데이터가 삭제되었습니다', 'success');
                    console.log('✅ 저장된 데이터 전체 삭제 완료');
                    
                } catch (error) {
                    console.error('❌ 데이터 삭제 오류:', error);
                    showQuickNotification('❌ 데이터 삭제 실패: ' + error.message, 'error');
                }
            }
        }*/
        
        // 챗봇 관련 변수
        let chatHistory = [];
        let isChatbotMinimized = false;
        
        // 현재 포트폴리오 컨텍스트 수집
        function getCurrentPortfolioContext() {
            const portfolioInput = document.getElementById('current-portfolio');
            const investmentInput = document.getElementById('investment-amount');
            const targetReturnInput = document.getElementById('target-return');
            const riskLevelInput = document.getElementById('risk-level');
            
            const portfolio = portfolioInput ? portfolioInput.value.trim() : '';
            const investment = investmentInput ? investmentInput.value : '';
            const targetReturn = targetReturnInput ? targetReturnInput.value : '';
            const riskLevel = riskLevelInput ? riskLevelInput.value : '';
            
            // 포트폴리오에서 종목 추출
            const holdings = extractStockHoldings(portfolio);
            
            return {
                portfolio: portfolio,
                holdings: holdings,
                totalInvestment: investment,
                targetReturn: targetReturn,
                riskLevel: riskLevel,
                hasPortfolio: portfolio.length > 0,
                stockCount: holdings.length
            };
        }
        
        // 포트폴리오에서 종목 정보 추출
        function extractStockHoldings(portfolioText) {
            if (!portfolioText) return [];
            
            const holdings = [];
            // 개선된 정규식: 쉼표와 공백을 고려하여 종목명과 수량을 정확히 추출
            const regex = /([가-힣a-zA-Z0-9\s]+?)\s*(\d+)(?:주|개)?(?:\s*,|\s*$)/g;
            let match;
            
            console.log('🔍 포트폴리오 파싱:', portfolioText);
            
            while ((match = regex.exec(portfolioText)) !== null) {
                const stockName = match[1].trim();
                const quantity = parseInt(match[2]);
                
                console.log('📊 추출된 종목:', { stockName, quantity });
                
                if (stockName && quantity > 0) {
                    holdings.push({
                        name: stockName,
                        quantity: quantity
                    });
                }
            }
            
            console.log('✅ 최종 보유 종목:', holdings);
            return holdings;
        }

        // 포트폴리오 기반 개인화된 챗봇 응답 생성
        async function getPersonalizedChatbotResponse(userMessage, portfolioContext) {
            console.log('🤖 개인화된 챗봇 응답 생성 중...', { userMessage, portfolioContext });
            
            try {
                // Gemini AI API 호출을 위한 요청 데이터 구성
                const requestData = {
                    userMessage: userMessage,
                    portfolioContext: portfolioContext,
                    chatHistory: chatHistory.slice(-5), // 최근 5개 대화만 포함
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch('/api/investment-advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'AIzaSyAJa7ixo3h3CytmCvvAMSWX2cH2g1XTXpg'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.advice) {
                    return data.advice;
                } else {
                    throw new Error(data.error || 'AI 응답 생성 실패');
                }
                
            } catch (error) {
                console.error('❌ 개인화된 챗봇 응답 오류:', error);
                throw error;
            }
        }

        // 포트폴리오 기반 폴백 응답 생성
        function generatePortfolioBasedFallback(userMessage, portfolioContext) {
            console.log('🔄 포트폴리오 기반 폴백 응답 생성...', { userMessage, portfolioContext });
            
            // 사용자 메시지에서 키워드 추출
            const message = userMessage.toLowerCase();
            
            // 포트폴리오 정보가 있는 경우
            if (portfolioContext.hasPortfolio && portfolioContext.holdings.length > 0) {
                // 실제 보유 종목을 동적으로 추출
                const stockNames = portfolioContext.holdings.map(h => h.name).join(', ');
                const stockDetails = portfolioContext.holdings.map(h => `• ${h.name}: ${h.quantity}주`).join('\n');
                
                console.log('📊 실제 보유 종목:', stockNames);
                console.log('📊 종목 상세:', stockDetails);
                
                if (message.includes('분석') || message.includes('어떻게') || message.includes('어떤')) {
                    return `현재 보유하신 포트폴리오에 대한 분석을 요청하셨군요. 현재 네트워크 연결에 문제가 있어 실시간 분석이 어렵습니다.

**현재 보유 종목:**
${stockDetails}

**기본 분석 제안:**
• ${stockNames}는 모두 우량 기업으로 안정적인 포트폴리오입니다
• 분산투자를 통해 리스크를 관리하고 계시네요
• 정기적인 리밸런싱을 고려해보세요

더 자세한 분석이 필요하시면 잠시 후 다시 시도해주세요. 😊`;
                }
                
                if (message.includes('추천') || message.includes('추가') || message.includes('새로운')) {
                    return `현재 보유하신 종목을 확인했습니다!

**현재 보유 종목:**
${stockDetails}

**추가 투자 추천:**
• **ETF**: KODEX 200, TIGER 200 등으로 시장 전체 노출
• **섹터별**: 반도체, 바이오, 신재생에너지 등 성장 섹터
• **해외**: S&P 500, 나스닥 ETF로 글로벌 분산
• **배당주**: SK텔레콤, KT&G 등 안정적인 배당 수익

현재 포트폴리오에 추가하면 더욱 균형잡힌 투자가 가능할 것 같습니다! 📈`;
                }
                
                if (message.includes('위험') || message.includes('리스크') || message.includes('안전')) {
                    return `현재 포트폴리오의 위험 관리에 대해 문의하셨네요.

**현재 보유 종목:**
${stockDetails}

**리스크 관리 제안:**
• 현재 포트폴리오는 비교적 안정적인 종목들로 구성
• 투자금액의 10-20%는 현금으로 보유 권장
• 정기적인 리밸런싱으로 변동성 관리
• 손실 한도 설정 (예: -10% 도달 시 재검토)

투자에는 원금 손실의 위험이 있으니 신중하게 결정하세요! ⚠️`;
                }
            }
            
            // 포트폴리오 정보가 없는 경우 일반적인 응답
            if (message.includes('시작') || message.includes('처음') || message.includes('어떻게')) {
                return `안녕하세요! 투자에 관심을 가져주셔서 감사합니다. 

**투자 시작 가이드:**
1. **목표 설정**: 단기/중기/장기 목표 수익률 정하기
2. **리스크 평가**: 본인의 위험 성향 파악
3. **분산투자**: 여러 종목에 나누어 투자
4. **정기 투자**: 꾸준한 투자 습관 만들기

포트폴리오를 입력하시면 더 구체적인 조언을 드릴 수 있습니다! 💡`;
            }
            
            if (message.includes('종목') || message.includes('주식') || message.includes('추천')) {
                return `주식 종목 추천을 요청하셨군요!

**추천 종목 카테고리:**
• **대형주**: 삼성전자, SK하이닉스, LG화학
• **성장주**: 네이버, 카카오, 셀트리온
• **배당주**: SK텔레콤, KT&G, 한국전력
• **ETF**: KODEX 200, TIGER 반도체

개인의 투자 성향과 목표에 따라 선택하시는 것이 중요합니다! 📊`;
            }
            
            // 기본 응답
            return `안녕하세요! 투자 관련 질문에 대해 도움을 드리고 싶지만, 현재 일시적으로 AI 서비스에 연결할 수 없는 상황입니다. 😔

**일반적인 투자 조언:**
• 분산투자를 통한 리스크 관리
• 정기적인 포트폴리오 리밸런싱
• 장기 투자 관점 유지
• 투자 전 충분한 조사와 분석

더 구체적인 조언이 필요하시면 포트폴리오 정보를 입력해주세요! 💪`;
        }

        // 챗봇 메시지 전송 함수 (포트폴리오 기반 개인화)
        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (!message) {
                showQuickNotification('💬 메시지를 입력해주세요', 'warning');
                return;
            }
            
            // 사용자 메시지 추가
            addChatMessage(message, 'user');
            chatInput.value = '';
            
            // 로딩 메시지 표시
            const loadingId = addLoadingMessage();
            
            try {
                // 현재 포트폴리오 컨텍스트 수집
                const portfolioContext = getCurrentPortfolioContext();
                
                // 포트폴리오 기반 개인화된 AI 응답 요청
                const response = await getPersonalizedChatbotResponse(message, portfolioContext);
                
                // 로딩 메시지 제거
                removeLoadingMessage(loadingId);
                
                // AI 응답 추가
                addChatMessage(response, 'ai');
                
                // 채팅 히스토리에 저장 (포트폴리오 정보 포함)
                chatHistory.push({ 
                    user: message, 
                    ai: response, 
                    timestamp: new Date().toISOString(),
                    portfolio: portfolioContext
                });
                
                showQuickNotification('✅ 맞춤형 투자 조언 완료', 'success');
                
            } catch (error) {
                console.error('❌ 챗봇 응답 오류:', error);
                removeLoadingMessage(loadingId);
                
                // 포트폴리오 기반 폴백 응답 생성
                const portfolioContext = getCurrentPortfolioContext();
                const fallbackResponse = generatePortfolioBasedFallback(message, portfolioContext);
                addChatMessage(fallbackResponse, 'ai');
                showQuickNotification('⚠️ 네트워크 오류로 기본 조언 제공', 'warning');
            }
        }
        
        // 빠른 질문 전송 함수
        function sendQuickQuestion(question) {
            const chatInput = document.getElementById('chat-input');
            chatInput.value = question;
            sendChatMessage();
        }
        
        // 챗봇 응답 생성 함수
        async function getChatbotResponse(userMessage) {
            console.log('🤖 챗봇 응답 생성 중:', userMessage);
            
            try {
                // 현재 포트폴리오 정보 수집
                const portfolioText = document.getElementById('current-portfolio')?.value || '';
                const investmentAmount = document.getElementById('investment-amount')?.value || '';
                const riskLevel = document.getElementById('risk-level')?.value || '';
                const targetReturn = document.getElementById('target-return')?.value || '';
                
                // Gemini AI API 호출
                const requestData = {
                    userMessage: userMessage,
                    chatHistory: chatHistory.slice(-5), // 최근 5개 대화만 컨텍스트로 사용
                    userProfile: {
                        portfolio: portfolioText,
                        investmentAmount: investmentAmount,
                        riskLevel: riskLevel,
                        targetReturn: targetReturn
                    },
                    prompt: `당신은 마이데이터 네이버페이의 전문 AI 투자 상담사입니다. 다음 지침을 따라 상담해주세요:

**역할과 톤:**
- 친근하고 전문적인 투자 상담사
- 복잡한 금융 용어를 쉽게 설명
- 개인 맞춤형 조언 제공
- 항상 위험 고지와 면책조항 포함

**사용자 프로필:**
- 📊 현재 포트폴리오: ${portfolioText || '아직 미구성 (투자 계획 단계)'}
- 💰 투자 금액: ${investmentAmount ? investmentAmount.toLocaleString() + '원' : '미입력'}
- ⚖️ 위험 성향: ${riskLevel || '보통 (안정추구형)'}
- 🎯 목표 수익률: ${targetReturn || '5'}%

**포트폴리오 분석:**
${portfolioText ? 
  `- 보유 종목 수: ${portfolioText.split(',').length}개
  - 종목별 상세: ${portfolioText}
  - 개인화 조언: 현재 보유 종목들의 위험도와 수익성을 고려한 맞춤형 제안 필요` : 
  `- 상태: 포트폴리오 미구성
  - 조언 방향: 투자 기초 교육 및 초보자용 종목 추천`}

**대화 히스토리:**
${chatHistory.slice(-3).map(chat => `사용자: ${chat.user}\nAI: ${chat.ai}`).join('\n\n')}

**현재 질문:** ${userMessage}

**답변 가이드라인:**
1. 🎯 **개인화 필수**: 사용자의 실제 보유 종목을 구체적으로 언급하며 맞춤형 분석 제공
2. 📊 **포트폴리오 기반**: 현재 보유 종목들의 업종, 위험도, 상관관계를 고려한 전문적 조언
3. 💡 **실행 가능한 제안**: 구체적이고 실용적인 투자 방향 제시 (일반적 조언)
4. ⚖️ **위험 관리**: 현재 포트폴리오의 분산도 평가 및 리밸런싱 필요성 안내
5. 📈 **시장 상황 반영**: 현재 한국 금융시장 상황을 고려한 타이밍 조언
6. 🎨 **친근한 톤**: 전문적이면서도 이해하기 쉬운 설명
7. 📏 **간결성**: 120자 이내로 핵심만 전달
8. ⚠️ **필수 고지**: "투자에는 원금 손실 위험이 있으며, 최종 투자 결정은 본인의 판단과 책임입니다."

**응답 패턴 예시:**
- 포트폴리오 보유시: "${portfolioText.split(',')[0] || '보유종목'} 등을 보유 중이시군요! 현재 [분석내용]을 고려할 때 [투자방향성]을 검토해보시면 좋겠습니다."
- 포트폴리오 미보유시: "투자 초보자라면 분산투자 원칙으로 안정적인 우량주나 ETF부터 시작해보시길 권합니다."

**금지사항:**
- 구체적 종목 매수/매도 권유 금지 (일반적 방향성만 제시)
- 확실한 수익 보장 표현 금지
- 과도한 위험 투자 권장 금지
- 개인정보 요구 금지

한국어로 자연스럽고 도움이 되는 답변을 작성해주세요.`
                };
                
                const response = await fetch('/api/investment-advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success && result.advice) {
                    return result.advice;
                } else {
                    throw new Error(result.error || 'AI 응답 생성 실패');
                }
                
            } catch (error) {
                console.error('❌ 챗봇 API 오류:', error);
                
                // 백업 응답 생성
                return generateFallbackResponse(userMessage);
            }
        }
        
        // 백업 응답 생성 함수
        function generateFallbackResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('초보') || lowerMessage.includes('시작')) {
                return `투자 초보자를 위한 가이드를 알려드릴게요! 😊

**1단계: 기초 지식 쌓기**
• 주식, 채권, ETF 등 기본 상품 이해
• 분산투자의 중요성 학습
• 장기투자 vs 단기투자 개념

**2단계: 투자 목표 설정**
• 투자 기간 결정 (단기/중장기/장기)
• 목표 수익률 설정 (현실적인 범위)
• 손실 허용 범위 정하기

**3단계: 실전 시작**
• 소액으로 시작해보기
• 월 정액 적립식 투자 고려
• 시장 상황 꾸준히 모니터링

⚠️ **중요 알림:** 투자에는 원금 손실 위험이 있습니다. 본인의 투자 성향과 재정 상황을 충분히 고려해주세요.`;
            }
            
            if (lowerMessage.includes('안전') || lowerMessage.includes('위험')) {
                return `안전한 투자처에 대해 말씀드릴게요! 🛡️

**낮은 위험 투자처:**
• 국고채, 회사채 (AAA 등급)
• 예금, 적금 (예금자보호법 적용)
• 원금보장형 상품

**중간 위험 투자처:**
• 우량 대형주 (삼성전자, SK하이닉스 등)
• 코스피 200 ETF
• 배당주 중심 포트폴리오

**분산투자 권장:**
• 한 가지 상품에만 집중 투자 피하기
• 업종별, 지역별 분산
• 투자 시기 분산 (적립식)

💡 **팁:** 나이를 활용한 공식 '100 - 나이 = 주식 투자 비중(%)'을 참고해보세요.

⚠️ 모든 투자에는 위험이 따르므로 신중한 결정이 필요합니다.`;
            }
            
            if (lowerMessage.includes('ETF') || lowerMessage.includes('개별주식')) {
                return `ETF와 개별주식의 차이점을 설명해드릴게요! 📊

**ETF (상장지수펀드):**
✅ 장점:
• 자동 분산투자 효과
• 낮은 관리 비용
• 투명한 구성 종목
• 초보자에게 적합

❌ 단점:
• 시장 평균 수익률
• 개별 종목 선택 불가

**개별주식:**
✅ 장점:
• 고수익 가능성
• 종목 선택의 자유
• 배당금 직접 수령

❌ 단점:
• 높은 위험성
• 종목 분석 필요
• 분산투자 어려움

**추천 조합:**
• 코어: ETF로 안정적 기반 (70%)
• 사이드: 개별주식으로 수익 추구 (30%)

💡 투자 경험과 시간 여유에 따라 비중을 조절해보세요!`;
            }
            
            if (lowerMessage.includes('적금') || lowerMessage.includes('vs') || lowerMessage.includes('비교')) {
                return `적금과 주식 투자를 비교해드릴게요! 💰

**적금의 특징:**
✅ 장점: 원금 보장, 확정 수익률, 안전성
❌ 단점: 낮은 수익률, 인플레이션 리스크

**주식 투자의 특징:**
✅ 장점: 높은 수익 가능성, 인플레이션 대응
❌ 단점: 원금 손실 위험, 변동성

**추천 전략:**
1. **안전 자금** (6개월~1년 생활비): 적금, 예금
2. **장기 목표 자금**: 주식, ETF 투자
3. **비율 예시**: 적금 40% + 주식 60%

**월 100만원 기준 예시:**
• 적금 40만원 (안전 자금)
• 주식 60만원 (성장 자금)

💡 **핵심:** 둘 중 하나만 선택하기보다는 적절한 조합이 중요해요!

⚠️ 개인의 재정 상황과 투자 목표에 따라 비율을 조정하세요.`;
            }
            
            // 사용자 질문에 맞는 맞춤형 응답 생성
            return generateSmartFallbackResponse(userMessage, {
                portfolio: portfolioText,
                investmentAmount: investmentAmount,
                riskLevel: riskLevel,
                targetReturn: targetReturn
            });
        }
        
        // 스마트 백업 응답 생성 함수
        function generateSmartFallbackResponse(userMessage, userProfile) {
            const lowerMessage = userMessage.toLowerCase();
            
            // 사용자 질문 분석
            const isAboutReturn = lowerMessage.includes('수익') || lowerMessage.includes('이익') || lowerMessage.includes('벌');
            const isAboutRisk = lowerMessage.includes('위험') || lowerMessage.includes('손실') || lowerMessage.includes('안전');
            const isAboutTiming = lowerMessage.includes('언제') || lowerMessage.includes('시점') || lowerMessage.includes('타이밍');
            const isAboutAmount = lowerMessage.includes('얼마') || lowerMessage.includes('금액') || lowerMessage.includes('돈');
            const isAboutSpecificStock = lowerMessage.includes('삼성') || lowerMessage.includes('카카오') || lowerMessage.includes('네이버') || lowerMessage.includes('주가');
            const isAboutStrategy = lowerMessage.includes('전략') || lowerMessage.includes('방법') || lowerMessage.includes('어떻게');
            
            // 사용자 프로필 기반 맞춤 조언
            let personalizedAdvice = '';
            if (userProfile.portfolio) {
                const stocks = extractStockNamesFromPortfolio(userProfile.portfolio);
                if (stocks.length > 0) {
                    personalizedAdvice = `\n📊 **현재 보유 종목 (${stocks.join(', ')})에 대한 참고사항:**\n`;
                    
                    if (stocks.includes('카카오') || stocks.includes('네이버')) {
                        personalizedAdvice += '• IT/플랫폼 기업은 성장성이 높지만 변동성도 큰 편입니다\n';
                    }
                    if (stocks.includes('삼성전자')) {
                        personalizedAdvice += '• 대형주는 상대적으로 안정적이나 고성장은 어려울 수 있습니다\n';
                    }
                    personalizedAdvice += '• 분산투자를 통해 리스크를 관리하는 것이 중요합니다\n';
                }
            }
            
            if (userProfile.riskLevel) {
                personalizedAdvice += `\n🎯 **${userProfile.riskLevel} 성향에 맞는 조언:**\n`;
                if (userProfile.riskLevel === '안정형') {
                    personalizedAdvice += '• 안정적인 수익을 추구하시니 채권형 펀드나 배당주 중심 투자를 고려해보세요\n';
                } else if (userProfile.riskLevel === '공격형') {
                    personalizedAdvice += '• 적극적 투자를 선호하시니 성장주나 테마주도 고려할 수 있지만 리스크 관리는 필수입니다\n';
                }
            }
            
            // 질문 유형별 맞춤 응답
            if (isAboutReturn) {
                return `💰 **수익에 대한 질문이시군요!**
        
        투자 수익은 다양한 요인에 따라 달라집니다:
        
        **📈 수익률 기대치:**
        • 안전 자산 (예금/채권): 연 3-5%
        • 국내 주식 (장기): 연 6-10%
        • 해외 주식 (장기): 연 8-12%
        
        **⚠️ 중요한 점:**
        • 과거 수익률 ≠ 미래 수익률
        • 높은 수익 = 높은 위험
        • 꾸준한 투자가 복리 효과 창출
        ${personalizedAdvice}
        
        💡 **실용적 조언:** 목표 수익률을 너무 높게 잡지 마시고, 꾸준히 투자하는 것이 더 중요합니다!
        
        ⚠️ 모든 투자에는 원금 손실 위험이 있습니다.`;
            }
            
            if (isAboutRisk) {
                return `🛡️ **투자 위험 관리에 대해 알려드릴게요!**
        
        **위험의 종류:**
        • 시장 위험: 전체 시장 하락
        • 개별 위험: 특정 기업/산업 문제
        • 환율 위험: 해외 투자 시
        • 인플레이션 위험: 물가 상승
        
        **위험 관리 방법:**
        • 분산투자 (업종별, 지역별, 시기별)
        • 손절매 기준 설정
        • 투자 비중 조절 (생활비는 절대 투자 금지)
        • 정기적인 포트폴리오 재검토
        ${personalizedAdvice}
        
        💡 **핵심:** 위험을 완전히 없앨 수는 없지만, 분산투자로 줄일 수 있습니다!
        
        ⚠️ 투자 전 본인의 위험 허용 수준을 정확히 파악하세요.`;
            }
            
            if (isAboutTiming) {
                return `⏰ **투자 타이밍에 대해 말씀드릴게요!**
        
        **타이밍의 진실:**
        • 완벽한 타이밍은 없습니다
        • 시장 예측은 전문가도 어려워합니다
        • "시간을 맞추기"보다 "시간을 활용하기"
        
        **추천 전략:**
        • 달러 코스트 애버리징 (정액 적립식)
        • 분할 매수/매도
        • 장기 투자 관점 유지
        
        **좋은 투자 시점:**
        • 시장이 과도하게 하락했을 때
        • 본인의 투자 계획에 따른 정기 투자일
        • 여유 자금이 확보되었을 때
        ${personalizedAdvice}
        
        💡 **결론:** 언제 시작하느냐보다 꾸준히 하느냐가 더 중요합니다!
        
        ⚠️ 단기 시장 예측에 의존한 투자는 위험합니다.`;
            }
            
            if (isAboutAmount) {
                return `💵 **투자 금액 설정에 대해 안내드릴게요!**
        
        **투자 금액 결정 원칙:**
        • 생활비 6개월분은 비상금으로 보관
        • 단기 사용 예정 자금은 투자 금지
        • 잃어도 생활에 지장 없는 금액만 투자
        
        **투자 비중 가이드:**
        • 초보자: 총 자산의 10-30%
        • 경험자: 총 자산의 30-70%
        • 나이별: (100 - 나이)% 를 주식에 투자
        
        **단계별 접근:**
        1. 소액으로 시작 (월 10-50만원)
        2. 투자 경험 쌓기
        3. 점진적으로 투자 비중 확대
        ${personalizedAdvice}
        
        💡 **팁:** 처음에는 적게 시작해서 경험을 쌓는 것이 중요합니다!
        
        ⚠️ 빚을 내서 투자하거나 생활비를 투자하는 것은 절대 금물입니다.`;
            }
            
            if (isAboutSpecificStock) {
                return `📊 **개별 종목에 대해 말씀드릴게요!**
        
        **종목 분석 시 고려사항:**
        • 기업의 재무 상태 (매출, 이익, 부채)
        • 업종 전망과 경쟁력
        • 경영진의 능력과 비전
        • 밸류에이션 (PER, PBR 등)
        
        **한국 대표 기업들:**
        • 삼성전자: 반도체, 스마트폰 글로벌 1위
        • 네이버: 국내 IT 플랫폼 대표 기업
        • 카카오: 모바일 생태계 구축
        
        **주의사항:**
        • 한 종목에 과도한 집중 투자 피하기
        • 뉴스나 소문보다는 기업 실적 중심으로 판단
        • 정기적인 실적 발표 모니터링
        ${personalizedAdvice}
        
        💡 **조언:** 개별 종목보다는 ETF로 시작해서 경험을 쌓아보세요!
        
        ⚠️ 특정 종목 추천은 불가능하며, 투자 결정은 본인의 책임입니다.`;
            }
            
            if (isAboutStrategy) {
                return `🎯 **투자 전략에 대해 알려드릴게요!**
        
        **초보자 추천 전략:**
        • 인덱스 펀드/ETF 중심 투자
        • 달러 코스트 애버리징
        • 분산투자 (국내외, 업종별)
        
        **중급자 전략:**
        • 코어-사텔라이트 전략
        • 리밸런싱 (분기별/반기별)
        • 가치투자 vs 성장투자 조합
        
        **고급자 전략:**
        • 섹터 로테이션
        • 글로벌 자산 배분
        • 대안투자 포함 (REITs, 원자재 등)
        
        **공통 원칙:**
        • 장기 투자 관점 유지
        • 감정적 투자 배제
        • 꾸준한 학습과 모니터링
        ${personalizedAdvice}
        
        💡 **핵심:** 복잡한 전략보다는 단순하고 꾸준한 전략이 더 효과적입니다!
        
        ⚠️ 전략은 개인의 상황에 맞게 조정해야 합니다.`;
            }
            
            // 기본 응답 (질문 유형을 파악하지 못한 경우)
            return `💬 **투자 상담을 도와드리겠습니다!**
        
        질문해주신 내용에 대해 도움을 드리고 싶습니다. 좀 더 구체적으로 어떤 부분이 궁금하신지 알려주시면 더 정확한 답변을 드릴 수 있어요!
        
        **자주 묻는 질문들:**
        • 📈 "투자 수익률은 어느 정도 기대할 수 있나요?"
        • 🛡️ "안전한 투자 방법이 있을까요?"
        • ⏰ "언제 투자를 시작하는 게 좋을까요?"
        • 💵 "얼마 정도 투자하는 게 적당한가요?"
        • 📊 "어떤 종목을 선택해야 할까요?"
        • 🎯 "투자 전략은 어떻게 세워야 하나요?"
        
        **현재 이용 가능한 기능:**
        • 포트폴리오 분석 도구
        • AI 리밸런싱 제안
        • 실행 계획 생성
        • PDF/JSON 다운로드
        ${personalizedAdvice}
        
        💡 **팁:** 위의 빠른 질문 버튼들을 활용해보세요!
        
        ⚠️ 모든 투자 조언은 참고용이며, 최종 결정은 본인의 판단과 책임입니다.`;
        }
        
        // 채팅 메시지 추가 함수
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.style.marginBottom = '15px';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px; justify-content: flex-end;">
                        <div style="background: #03C75A; color: white; padding: 12px 15px; border-radius: 15px 15px 5px 15px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                            ${message}
                        </div>
                        <div style="width: 35px; height: 35px; background: #6c757d; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                            👤
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                            🤖
                        </div>
                        <div style="background: #f8f9fa; padding: 14px 16px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.6; font-size: 14px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            ${markdownToHtml(message)}
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            
            // 스크롤을 최신 메시지로 이동
            const chatBody = document.getElementById('chatbot-body');
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // 로딩 메시지 추가 함수
        function addLoadingMessage() {
            const chatMessages = document.getElementById('chat-messages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message ai-message';
            loadingDiv.style.marginBottom = '15px';
            
            loadingDiv.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                        🤖
                    </div>
                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 8px; height: 8px; background: #03C75A; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                            <div style="width: 8px; height: 8px; background: #03C75A; border-radius: 50%; animation: pulse 1.5s infinite 0.2s;"></div>
                            <div style="width: 8px; height: 8px; background: #03C75A; border-radius: 50%; animation: pulse 1.5s infinite 0.4s;"></div>
                            <span style="margin-left: 5px; color: #6c757d;">AI가 생각하고 있습니다...</span>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(loadingDiv);
            
            // 스크롤을 최신 메시지로 이동
            const chatBody = document.getElementById('chatbot-body');
            chatBody.scrollTop = chatBody.scrollHeight;
            
            return loadingId;
        }
        
        // 로딩 메시지 제거 함수
        function removeLoadingMessage(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // 채팅 기록 초기화 함수
        function clearChatHistory() {
            if (confirm('대화 기록을 모두 삭제하시겠습니까?')) {
                chatHistory = [];
                
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = `
                    <div class="message ai-message" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                                🤖
                            </div>
                            <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                                안녕하세요! 저는 마이데이터 네이버페이 AI 투자 상담사입니다. 🎯<br><br>
                                투자 목표, 위험 성향, 포트폴리오 구성 등 어떤 것이든 편하게 물어보세요!<br><br>
                                <strong>예시 질문:</strong><br>
                                💡 "안전한 투자 방법이 뭐가 있을까요?"<br>
                                💡 "월 100만원 적금 vs 주식 투자 어떤게 좋을까요?"<br>
                                💡 "삼성전자 주가 전망은 어떤가요?"
                            </div>
                        </div>
                    </div>
                `;
                
                showQuickNotification('🗑️ 대화 기록이 초기화되었습니다', 'success');
            }
        }
        
        // 챗봇 최소화/최대화 함수
        function toggleChatbot() {
            const chatBody = document.getElementById('chatbot-body');
            const toggleButton = document.getElementById('chatbot-toggle');
            
            if (isChatbotMinimized) {
                chatBody.style.display = 'block';
                toggleButton.textContent = '➖ 최소화';
                isChatbotMinimized = false;
            } else {
                chatBody.style.display = 'none';
                toggleButton.textContent = '➕ 펼치기';
                isChatbotMinimized = true;
            }
        }
        
        // 엔터 키 처리 함수
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // 페이지 로드 시 성능 모니터링 시작 (기본값 제거)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('✅ 페이지 로딩 완료 - 기본값 없이 시작');
            
            // 면책조항 날짜 업데이트
            const disclaimerDate = document.getElementById('disclaimer-date');
            if (disclaimerDate) {
                disclaimerDate.textContent = new Date().toLocaleDateString('ko-KR');
                console.log('📅 면책조항 날짜 업데이트:', disclaimerDate.textContent);
            }
            
            // 챗봇 히스토리는 세션 메모리만 사용 (새로고침 시 초기화)
            
            // 성능 메트릭 업데이트 제거됨 (고객용 인터페이스에 불필요)
            
            // 개발자 도구 기능 제거됨 (사용자 친화적 인터페이스)
        });
    </script>
    
    <!-- PWA 설치 및 서비스 워커 등록 -->
    <script>
        // PWA 설치 기능
        let deferredPrompt;
        let installButton;

        // PWA 설치 버튼 생성
        function createInstallButton() {
            if (installButton) return;
            
            installButton = document.createElement('button');
            installButton.className = 'btn npay-button pwa-install-btn';
            installButton.innerHTML = '<span class="npay-logo">📱</span>앱으로 설치';
            installButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3);
                border-radius: 25px;
                font-size: 14px;
                padding: 12px 20px;
            `;
            
            installButton.addEventListener('click', installPWA);
            document.body.appendChild(installButton);
        }

        // PWA 설치 실행
        async function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('사용자가 PWA 설치를 수락했습니다.');
                showNotification('앱 설치가 완료되었습니다! 홈 화면에서 확인해주세요.', 'success');
            } else {
                console.log('사용자가 PWA 설치를 거부했습니다.');
            }
            
            deferredPrompt = null;
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        }

        // 설치 가능 이벤트 리스너
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            createInstallButton();
        });

        // 앱 설치 완료 이벤트
        window.addEventListener('appinstalled', () => {
            console.log('PWA가 성공적으로 설치되었습니다.');
            showNotification('마이데이터 투자 앱이 설치되었습니다!', 'success');
            
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        });

        // 서비스 워커 등록 (개발 환경에서는 비활성화)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                // 개발 환경에서는 서비스 워커 캐시 방지
                if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                    console.log('🔄 개발 환경: 서비스 워커 비활성화 (캐시 방지)');
                    
                    // 기존 서비스 워커 제거
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        registrations.forEach(registration => {
                            registration.unregister();
                            console.log('기존 서비스 워커 제거됨');
                        });
                    } catch (error) {
                        console.log('서비스 워커 제거 실패:', error);
                    }
                    return;
                }
                
                // 프로덕션 환경에서만 서비스 워커 등록
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('서비스 워커 등록 성공:', registration.scope);
                    
                    // 서비스 워커 업데이트 확인
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                } catch (error) {
                    console.log('서비스 워커 등록 실패:', error);
                }
            });
        }

        // 업데이트 알림 표시
        function showUpdateNotification() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'update-banner';
            updateBanner.innerHTML = `
                <div style="background: var(--npay-green); color: white; padding: 12px 20px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;">
                    <span>새 업데이트가 있습니다!</span>
                    <button onclick="refreshApp()" style="background: white; color: var(--npay-green); border: none; padding: 4px 12px; margin-left: 12px; border-radius: 4px; cursor: pointer;">
                        새로고침
                    </button>
                    <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 4px 12px; margin-left: 8px; border-radius: 4px; cursor: pointer;">
                        나중에
                    </button>
                </div>
            `;
            document.body.appendChild(updateBanner);
        }

        // 앱 새로고침
        function refreshApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.waiting?.postMessage({ type: 'SKIP_WAITING' });
                });
                window.location.reload();
            }
        }

        // 알림 표시 함수
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--npay-green)' : 'var(--info)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 애니메이션 CSS 추가
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .pwa-install-btn {
                transition: all 0.3s ease;
            }
            .pwa-install-btn:hover {
                transform: scale(1.05);
            }
        `;
        document.head.appendChild(style);

        // 온라인/오프라인 상태 모니터링
        window.addEventListener('online', () => {
            showNotification('인터넷 연결이 복구되었습니다.', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('오프라인 모드입니다. 일부 기능이 제한될 수 있습니다.', 'warning');
        });

        // 마크다운을 HTML로 변환하는 함수
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            let html = markdown
                // 헤더 변환 (적절한 스타일링)
                .replace(/^### (.*$)/gim, '<h3 style="color: #333; font-size: 1.1em; font-weight: 600; margin: 12px 0 8px 0;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="color: #03C75A; font-size: 1.2em; font-weight: 600; margin: 15px 0 10px 0;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="color: #03C75A; font-size: 1.4em; font-weight: 700; margin: 18px 0 12px 0;">$1</h1>')
                // 볼드 텍스트 변환
                .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #333;">$1</strong>')
                // 이탤릭 텍스트 변환
                .replace(/\*(.*?)\*/g, '<em style="font-style: italic; color: #666;">$1</em>')
                // 리스트 변환
                .replace(/^\* (.*$)/gim, '<li style="margin: 3px 0;">$1</li>')
                .replace(/^- (.*$)/gim, '<li style="margin: 3px 0;">$1</li>')
                // 번호 리스트 변환
                .replace(/^\d+\. (.*$)/gim, '<li style="margin: 3px 0;">$1</li>')
                // 링크 변환
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #03C75A; text-decoration: none;">$1</a>')
                // 줄바꿈 변환
                .replace(/\n/g, '<br>');
            
            // 연속된 <li> 태그를 <ul>로 감싸기
            html = html.replace(/(<li[^>]*>.*?<\/li>)(\s*<br>\s*<li[^>]*>.*?<\/li>)*/g, function(match) {
                const listItems = match.replace(/<br>\s*/g, '');
                return `<ul style="margin: 8px 0; padding-left: 16px; list-style-type: disc;">${listItems}</ul>`;
            });
            
            // 연속된 <br> 태그 정리 (3개 이상을 2개로)
            html = html.replace(/(<br>\s*){3,}/g, '<br><br>');
            
            return html;
        }

        // 앱 버전 체크
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                const channel = new MessageChannel();
                channel.port1.onmessage = event => {
                    console.log('앱 버전:', event.data.version);
                };
                registration.active?.postMessage({ type: 'GET_VERSION' }, [channel.port2]);
            });
        }
    </script>
</body>
</html>
