<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„í˜ì´ ë§ˆì´ë°ì´í„° AI íˆ¬ìë¶„ì„ - ë§ì¶¤í˜• í¬íŠ¸í´ë¦¬ì˜¤ ì œì•ˆ</title>
    
    <!-- ê°œë°œ ì¤‘ ìºì‹œ ë°©ì§€ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="0">
    <meta http-equiv="If-Modified-Since" content="0">
    
    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" content="ë„¤ì´ë²„í˜ì´ ì—°ë™ AI ê¸°ë°˜ ì‹¤ì‹œê°„ íˆ¬ì ë¦¬ë°¸ëŸ°ì‹± ì„œë¹„ìŠ¤">
    <meta name="theme-color" content="#03C75A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë§ˆì´ë°ì´í„° íˆ¬ì">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA ë§¤ë‹ˆí˜ìŠ¤íŠ¸ (ì•„ì´ì½˜ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì„ì‹œ ë¹„í™œì„±í™”) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    
    <!-- íŒŒë¹„ì½˜ ë° ì•„ì´ì½˜ (ê¸°ë³¸ íŒŒë¹„ì½˜ ì‚¬ìš©) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    
    <!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ (ìºì‹œ ë°©ì§€) -->
    <link rel="stylesheet" href="style.css" id="main-css">
    
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ (HTMLì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ (PDF ìƒì„±ìš©) - ê°œì„ ëœ ë¡œë”© ì‹œìŠ¤í…œ -->
    <script>
        // jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë”© í•¨ìˆ˜
        function loadJsPDFLibrary() {
            return new Promise((resolve, reject) => {
                console.log('ğŸ“„ jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹œì‘...');
                
                // ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (window.jsPDF) {
                    console.log('âœ… jsPDF ì´ë¯¸ ë¡œë“œë¨');
                    resolve(window.jsPDF);
                    return;
                }
                
                // CDN ëª©ë¡ (ë” ì•ˆì •ì ì¸ CDNë“¤ë¡œ ì—…ë°ì´íŠ¸)
                const cdnList = [
                    // UMD ë²„ì „ë“¤ (ê°€ì¥ ì•ˆì •ì )
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    // êµ¬ë²„ì „ (ë” ì•ˆì •ì )
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js',
                    'https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js',
                    // JSDelivr CDN
                    'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'https://cdn.jsdelivr.net/npm/jspdf@1.5.3/dist/jspdf.min.js',
                    // ìµœì‹  ë²„ì „ë“¤ (ë§ˆì§€ë§‰ ì‹œë„)
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.min.js',
                    'https://unpkg.com/jspdf@latest/dist/jspdf.min.js'
                ];
                
                let cdnIndex = 0;
                
                function tryLoadCDN() {
                    if (cdnIndex >= cdnList.length) {
                        console.error('âŒ ëª¨ë“  jsPDF CDN ë¡œë”© ì‹¤íŒ¨');
                        reject(new Error('ëª¨ë“  jsPDF CDNì—ì„œ ë¡œë”© ì‹¤íŒ¨'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[cdnIndex];
                    
                    script.onload = function() {
                        // ë¡œë”© ì™„ë£Œ í›„ ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ jsPDF í™•ì¸
                        setTimeout(() => {
                            let jsPDFInstance = null;
                            
                            // 1. window.jsPDF ì§ì ‘ í™•ì¸
                            if (window.jsPDF) {
                                jsPDFInstance = window.jsPDF;
                                console.log(`âœ… jsPDF CDN ${cdnIndex + 1} ë¡œë”© ì„±ê³µ (window.jsPDF):`, cdnList[cdnIndex]);
                            }
                            // 2. window.jspdf ì†Œë¬¸ì í™•ì¸
                            else if (window.jspdf) {
                                jsPDFInstance = window.jspdf;
                                window.jsPDF = window.jspdf; // ëŒ€ë¬¸ìë¡œ ë³µì‚¬
                                console.log(`âœ… jsPDF CDN ${cdnIndex + 1} ë¡œë”© ì„±ê³µ (window.jspdf):`, cdnList[cdnIndex]);
                            }
                            // 3. ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì°¾ê¸°
                            else if (typeof jsPDF !== 'undefined') {
                                jsPDFInstance = jsPDF;
                                window.jsPDF = jsPDF;
                                console.log(`âœ… jsPDF CDN ${cdnIndex + 1} ë¡œë”© ì„±ê³µ (global jsPDF):`, cdnList[cdnIndex]);
                            }
                            // 4. require ë°©ì‹ ì‹œë„
                            else if (typeof require !== 'undefined') {
                                try {
                                    jsPDFInstance = require('jspdf');
                                    window.jsPDF = jsPDFInstance;
                                    console.log(`âœ… jsPDF CDN ${cdnIndex + 1} ë¡œë”© ì„±ê³µ (require):`, cdnList[cdnIndex]);
                                } catch (e) {
                                    // require ì‹¤íŒ¨
                                }
                            }
                            
                            if (jsPDFInstance) {
                                resolve(jsPDFInstance);
                            } else {
                                console.warn(`âš ï¸ CDN ${cdnIndex + 1} ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œëì§€ë§Œ jsPDF ì •ì˜ë˜ì§€ ì•ŠìŒ`);
                                console.log('   ì „ì—­ ê°ì²´ë“¤:', Object.keys(window).filter(key => key.toLowerCase().includes('pdf')));
                                cdnIndex++;
                                document.head.removeChild(script);
                                tryLoadCDN();
                            }
                        }, 200); // ì§€ì—°ì‹œê°„ ì¦ê°€
                    };
                    
                    script.onerror = function() {
                        console.warn(`âš ï¸ jsPDF CDN ${cdnIndex + 1} ì‹¤íŒ¨:`, cdnList[cdnIndex]);
                        document.head.removeChild(script);
                        cdnIndex++;
                        tryLoadCDN();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoadCDN();
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ jsPDF ë¡œë”©
        window.addEventListener('DOMContentLoaded', function() {
            loadJsPDFLibrary()
                .then(() => {
                    console.log('ğŸ‰ jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
                    window.jsPDFReady = true;
                })
                .catch(error => {
                    console.error('âŒ jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨:', error);
                    window.jsPDFReady = false;
                });
        });
        
        // ì „ì—­ jsPDF ë¡œë”© í•¨ìˆ˜ (í•„ìš”ì‹œ ì¬ì‹œë„ìš©)
        window.ensureJsPDFLoaded = loadJsPDFLibrary;
        
        // ì¢…ëª© ê²€ìƒ‰ ê¸°ëŠ¥
        async function searchStocks(query) {
            try {
                console.log(`ğŸ” ì¢…ëª© ê²€ìƒ‰: ${query}`);
                const response = await fetch(`/api/naver-search/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    showSearchSuggestions(data.results);
                    return data.results;
                } else {
                    hideSearchSuggestions();
                    showQuickNotification(`"${query}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
                    return [];
                }
            } catch (error) {
                console.error('ì¢…ëª© ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                hideSearchSuggestions();
                showQuickNotification('ì¢…ëª© ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return [];
            }
        }
        
        function showSearchSuggestions(results) {
            const suggestionsDiv = document.getElementById('search-suggestions');
            
            if (results.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            suggestionsDiv.innerHTML = results.map(stock => `
                <div style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s;" 
                     onclick="selectStock('${stock.name}', '${stock.code}')"
                     onmouseover="this.style.backgroundColor='#f8f9fa'"
                     onmouseout="this.style.backgroundColor='white'">
                    <span style="font-weight: bold; color: #333;">${stock.name}</span>
                    <span style="font-size: 0.9em; color: #666; margin-left: 10px;">${stock.code}</span>
                    <span style="font-size: 0.8em; color: #999; margin-left: 10px;">${stock.market}</span>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        function hideSearchSuggestions() {
            const suggestionsDiv = document.getElementById('search-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function selectStock(name, code) {
            const portfolioInput = document.getElementById('current-portfolio');
            const currentValue = portfolioInput.value.trim();
            
            // ì¢…ëª©ëª…ê³¼ ê¸°ë³¸ ìˆ˜ëŸ‰ ì¶”ê°€
            const newStock = currentValue ? `, ${name} 1ì£¼` : `${name} 1ì£¼`;
            portfolioInput.value = currentValue + newStock;
            
            hideSearchSuggestions();
            portfolioInput.focus();
            
            showQuickNotification(`${name} (${code})ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        
        async function searchStockPrompt() {
            const query = prompt('ê²€ìƒ‰í•  ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (query && query.trim()) {
                await searchStocks(query.trim());
            }
        }
    </script>
    <!-- ì„±ëŠ¥ ìµœì í™” (ìºì‹œ ë°©ì§€) -->
    <script src="optimize.js" id="optimize-js"></script>
    
    <!-- ê°œë°œ ì¤‘ ìë™ ìºì‹œ ë°©ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ CSSì™€ JS íŒŒì¼ì— íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        (function() {
            const timestamp = Date.now();
            
            // CSS íŒŒì¼ ìºì‹œ ë°©ì§€
            const cssLink = document.getElementById('main-css');
            if (cssLink) {
                cssLink.href = `style.css?v=${timestamp}`;
            }
            
            // JS íŒŒì¼ ìºì‹œ ë°©ì§€
            const jsScript = document.getElementById('optimize-js');
            if (jsScript) {
                jsScript.src = `optimize.js?v=${timestamp}`;
            }
            
            console.log(`ğŸ”„ ìºì‹œ ë°©ì§€ íƒ€ì„ìŠ¤íƒ¬í”„: ${timestamp}`);
        })();
    </script>
</head>
<body>
    <div class="container">
        <header class="header" style="background: linear-gradient(135deg, #03C75A 0%, #00B04F 100%); color: white; text-align: center;">
            <div class="naverpay-brand-header" style="padding: 30px 20px;">
                <!-- ë„¤ì´ë²„í˜ì´ ì‹œê·¸ë‹ˆì²˜ ë¡œê³  (ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜) -->
                <div class="npay-logo-section" style="margin-bottom: 20px;">
                    <span class="npay-signature-logo" style="font-size: 48px; font-weight: bold; letter-spacing: 2px;">
                        N<span style="color: #FFFFFF;">pay</span>
                    </span>
                    <span class="brand-divider" style="margin: 0 15px; font-size: 24px; opacity: 0.8;">Ã—</span>
                    <span class="service-name" style="font-size: 24px; font-weight: 500;">ë§ˆì´ë°ì´í„°</span>
                </div>
                
                <h1 style="margin: 0; font-size: 32px; font-weight: 700;">ğŸš€ AI íˆ¬ì ì œì•ˆ ì‹œìŠ¤í…œ</h1>
                <p style="margin: 15px 0; font-size: 18px; opacity: 0.9;">ë„¤ì´ë²„í˜ì´ ë§ˆì´ë°ì´í„° ê¸°ë°˜ ê°œì¸í™” í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ë° ë¦¬ë°¸ëŸ°ì‹± ì„œë¹„ìŠ¤</p>
                
                <!-- ë„¤ì´ë²„í˜ì´ í˜œíƒ ë°°ì§€ (ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ ì ìš©) -->
                <div class="benefit-badges" style="margin-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <div class="benefit-badge primary" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.3);">
                        <span style="font-size: 16px;">ğŸ’³ ë„¤ì´ë²„í˜ì´ ì—°ê²° ì‹œ <strong>ìµœëŒ€ 2% ì ë¦½</strong></span>
                    </div>
                    <div class="benefit-badge secondary" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2);">
                        <span style="font-size: 16px;">ğŸ”’ ë§ˆì´ë°ì´í„° <strong>ì•ˆì „í•œ ê¸ˆìœµì •ë³´ ê´€ë¦¬</strong></span>
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- 1ë‹¨ê³„: í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì…ë ¥ -->
            <section class="section" id="portfolio-section">
                <h2>ğŸ“Š í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤</h2>
                <div class="portfolio-form">
                    <div class="form-group">
                        <label for="current-portfolio">ë³´ìœ  ì¢…ëª© ì…ë ¥:</label>
                        <div class="portfolio-input-wrapper" style="position: relative;">
                            <textarea id="current-portfolio" placeholder="ì˜ˆì‹œ: ì‚¼ì„±ì „ì 10ì£¼, ì¹´ì¹´ì˜¤ 5, ë„¤ì´ë²„3 (ì£¼ ë‹¨ìœ„ ìƒëµ ê°€ëŠ¥)"></textarea>
                            <div class="search-suggestions" id="search-suggestions" 
                                style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <div class="input-helper" style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                            <button type="button" id="search-stocks-btn" onclick="searchStockPrompt()" 
                                style="background: #03C75A; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ğŸ” ì¢…ëª© ê²€ìƒ‰
                            </button>
                            <span style="font-size: 0.85em; color: #666;">ëª¨ë“  ìƒì¥ ì¢…ëª©ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="investment-amount">ì´ íˆ¬ìê¸ˆì•¡:</label>
                        <input type="number" id="investment-amount" placeholder="10000000" min="0">
                        <span class="unit">ì›</span>
                    </div>
                    <button class="btn primary" onclick="analyzePortfolioSimple()">í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„</button>
                </div>
            </section>

            <!-- ê¸ˆìœµ ë©´ì±…ì¡°í•­ (ì¤‘ìš” ê³ ì§€ì‚¬í•­) -->
            <section class="section" id="disclaimer-section" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 15px; margin: 30px 0;">
                <div style="padding: 25px;">
                    <h2 style="color: #856404; margin-bottom: 20px; text-align: center;">âš ï¸ íˆ¬ì ìœ„í—˜ ê³ ì§€ ë° ë©´ì±…ì¡°í•­</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; border-left: 5px solid #dc3545;">
                            <h3 style="color: #721c24; margin-bottom: 15px;">ğŸš¨ í•„ìˆ˜ í™•ì¸ì‚¬í•­</h3>
                            <ul style="color: #721c24; line-height: 1.8; margin: 0; padding-left: 20px;">
                                <li><strong>ì›ê¸ˆ ì†ì‹¤ ìœ„í—˜:</strong> ëª¨ë“  íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ì˜ ìœ„í—˜ì´ ìˆìœ¼ë©°, íˆ¬ì ì›ê¸ˆì´ ë³´ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                                <li><strong>ê³¼ê±° ì„±ê³¼ â‰  ë¯¸ë˜ ìˆ˜ìµ:</strong> ê³¼ê±°ì˜ íˆ¬ì ì„±ê³¼ê°€ ë¯¸ë˜ì˜ ìˆ˜ìµë¥ ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                                <li><strong>ê°œì¸ ì±…ì„:</strong> ìµœì¢… íˆ¬ì ê²°ì •ì€ íˆ¬ìì ë³¸ì¸ì˜ íŒë‹¨ê³¼ ì±…ì„ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.</li>
                                <li><strong>ì „ë¬¸ ìƒë‹´ ê¶Œê³ :</strong> íˆ¬ì ì „ ë°˜ë“œì‹œ ê¸ˆìœµ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                        
                        <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 5px solid #17a2b8;">
                            <h3 style="color: #0c5460; margin-bottom: 15px;">ğŸ“‹ ì„œë¹„ìŠ¤ ì´ìš© ì•ˆë‚´</h3>
                            <ul style="color: #0c5460; line-height: 1.8; margin: 0; padding-left: 20px;">
                                <li>ë³¸ ì„œë¹„ìŠ¤ëŠ” <strong>íˆ¬ì ì°¸ê³  ì •ë³´</strong> ì œê³µ ëª©ì ì´ë©°, íˆ¬ì ê¶Œìœ ë‚˜ ë§¤ë§¤ ì§€ì‹œê°€ ì•„ë‹™ë‹ˆë‹¤.</li>
                                <li>ê¸ˆìœµìœ„ì›íšŒì˜ ìŠ¹ì¸ ì—†ì´ ì‹¤ì œ íˆ¬ì ê¶Œìœ ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                                <li>ë§ˆì´ë°ì´í„° ì„œë¹„ìŠ¤ëŠ” ê¸ˆìœµìœ„ì›íšŒ ê·œì • ë° ê°œì¸ì •ë³´ë³´í˜¸ë²•ì— ë”°ë¼ ìš´ì˜ë©ë‹ˆë‹¤.</li>
                                <li>AI ë¶„ì„ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì‹œì¥ ë³€ë™ì„±ì„ ì™„ì „íˆ ì˜ˆì¸¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: #e2e3e5; border-radius: 8px;">
                        <p style="margin: 0; font-size: 14px; color: #495057;">
                            <strong>ğŸ›ï¸ ê·œì œê¸°ê´€:</strong> ê¸ˆìœµìœ„ì›íšŒ | <strong>ğŸ“ ê¸ˆìœµì†Œë¹„ìë³´í˜¸:</strong> 1332 | 
                            <strong>ğŸ“… ê³ ì§€ì¼:</strong> <span id="disclaimer-date"></span> | 
                            <strong>ğŸ”’ ì„œë¹„ìŠ¤:</strong> ë§ˆì´ë°ì´í„° íˆ¬ìë¶„ì„ì‹œìŠ¤í…œ
                        </p>
                    </div>
                </div>
            </section>

            <!-- 2ë‹¨ê³„: ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° -->
            <section class="section" id="market-section">
                <h2>ğŸ“ˆ ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„°</h2>
                <div class="market-controls">
                    <!-- ë„¤ì´ë²„ ê¸ˆìœµ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë¡œë”©ë˜ë¯€ë¡œ ë²„íŠ¼ ì œê±° -->
                </div>
                
                <div class="market-data" id="market-data">
                    <div class="loading" id="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>ì‹œì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                    
                    <div class="stock-grid" id="stock-grid">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì£¼ì‹ ë°ì´í„° -->
                    </div>
                </div>
            </section>

            <!-- 3ë‹¨ê³„: ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ -->
            <section class="section" id="rebalancing-section">
                <h2>âš–ï¸ ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ</h2>
                
                <!-- ë„¤ì´ë²„í˜ì´ í˜œíƒ ë°°ì§€ -->
                <div class="benefit-badge">
                    <span class="badge-text">Npay ê²°ì œ ì‹œ ìµœëŒ€ 2% ì ë¦½</span>
                </div>
                
                <div class="rebalancing-controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="risk-level">ìœ„í—˜ ìˆ˜ì¤€:</label>
                            <select id="risk-level">
                                <option value="conservative">ì•ˆì •í˜• (Conservative)</option>
                                <option value="moderate" selected>ê· í˜•í˜• (Moderate)</option>
                                <option value="aggressive">ê³µê²©í˜• (Aggressive)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="target-return">ëª©í‘œ ìˆ˜ìµë¥ :</label>
                            <div class="input-with-unit">
                                <input type="number" id="target-return" placeholder="8" min="1" max="30">
                                <span class="unit">%</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn primary" onclick="generateRebalancingAdvice()">AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ</button>
                </div>
                
                <div class="rebalancing-result" id="rebalancing-result">
                    <!-- AI ìƒì„± ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <!-- ì°¨íŠ¸ ì˜ì—­ -->
                <div class="chart-container">
                    <canvas id="portfolioChart" width="800" height="400"></canvas>
                </div>
            </section>

            <!-- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ ì œê±°: ê³ ê°ìš© ì¸í„°í˜ì´ìŠ¤ì—ì„œëŠ” ë¶ˆí•„ìš” -->

            <!-- 4ë‹¨ê³„: AI íˆ¬ì ìƒë‹´ ì±—ë´‡ -->
            <section class="section" id="chatbot-section">
                <h2>ğŸ’¬ AI íˆ¬ì ìƒë‹´ ì±—ë´‡</h2>
                <div class="chatbot-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; overflow: hidden; border: 1px solid #dee2e6;">
                    
                    <!-- ì±—ë´‡ í—¤ë” -->
                    <div class="chatbot-header" style="background: linear-gradient(135deg, #03C75A 0%, #028a47 100%); padding: 20px; color: white;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="font-size: 24px;">ğŸ¤–</span>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 18px;">AI íˆ¬ì ìƒë‹´ì‚¬</h3>
                                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">íˆ¬ì ê³ ë¯¼ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒë‹´í•´ë³´ì„¸ìš”</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="clearChatHistory()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ğŸ—‘ï¸ ëŒ€í™” ì´ˆê¸°í™”
                                </button>
                                <button onclick="toggleChatbot()" id="chatbot-toggle" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    â– ìµœì†Œí™”
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì±—ë´‡ ë³¸ë¬¸ -->
                    <div class="chatbot-body" id="chatbot-body" style="height: 400px; overflow-y: auto; padding: 20px; background: white;">
                        <div class="chat-messages" id="chat-messages">
                            <!-- AI ì²« ì¸ì‚¬ë§ -->
                            <div class="message ai-message" style="margin-bottom: 15px;">
                                <div style="display: flex; align-items: flex-start; gap: 10px;">
                                    <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                                        ğŸ¤–
                                    </div>
                                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                                        ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ AI íˆ¬ì ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸ¯<br><br>
                                        íˆ¬ì ëª©í‘œ, ìœ„í—˜ ì„±í–¥, í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± ë“± ì–´ë–¤ ê²ƒì´ë“  í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!<br><br>
                                        <strong>ì˜ˆì‹œ ì§ˆë¬¸:</strong><br>
                                        ğŸ’¡ "ì•ˆì „í•œ íˆ¬ì ë°©ë²•ì´ ë­ê°€ ìˆì„ê¹Œìš”?"<br>
                                        ğŸ’¡ "ì›” 100ë§Œì› ì ê¸ˆ vs ì£¼ì‹ íˆ¬ì ì–´ë–¤ê²Œ ì¢‹ì„ê¹Œìš”?"<br>
                                        ğŸ’¡ "ì‚¼ì„±ì „ì ì£¼ê°€ ì „ë§ì€ ì–´ë–¤ê°€ìš”?"
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì±—ë´‡ ì…ë ¥ì°½ -->
                    <div class="chatbot-input" style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6;">
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1; position: relative;">
                                <textarea 
                                    id="chat-input" 
                                    placeholder="íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                    style="width: 100%; min-height: 45px; max-height: 120px; padding: 12px 50px 12px 15px; border: 2px solid #dee2e6; border-radius: 25px; resize: none; font-size: 14px; line-height: 1.4; box-sizing: border-box; outline: none; transition: border-color 0.3s;"
                                    onkeypress="handleChatKeyPress(event)"
                                    onfocus="this.style.borderColor='#03C75A'"
                                    onblur="this.style.borderColor='#dee2e6'"
                                ></textarea>
                                <button 
                                    onclick="sendChatMessage()" 
                                    id="send-button"
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #03C75A; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: background-color 0.3s;"
                                    onmouseover="this.style.backgroundColor='#028a47'"
                                    onmouseout="this.style.backgroundColor='#03C75A'"
                                >
                                    â¤
                                </button>
                            </div>
                        </div>
                        
                        <!-- ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ë“¤ -->
                        <div class="quick-questions" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="sendQuickQuestion('ì´ˆë³´ì íˆ¬ì ê°€ì´ë“œ ì•Œë ¤ì£¼ì„¸ìš”')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                ğŸ’¡ ì´ˆë³´ì ê°€ì´ë“œ
                            </button>
                            <button onclick="sendQuickQuestion('ì•ˆì „í•œ íˆ¬ìì²˜ ì¶”ì²œí•´ì£¼ì„¸ìš”')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                ğŸ›¡ï¸ ì•ˆì „ íˆ¬ìì²˜
                            </button>
                            <button onclick="sendQuickQuestion('í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ë°¸ëŸ°ì‹± ë°©ë²•')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                âš–ï¸ ë¦¬ë°¸ëŸ°ì‹±
                            </button>
                            <button onclick="sendQuickQuestion('ETFì™€ ê°œë³„ì£¼ì‹ ì°¨ì´ì ')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                ğŸ“Š ETF vs ê°œë³„ì£¼ì‹
                            </button>
                            <button onclick="sendQuickQuestion('ì›” ì ê¸ˆ 100ë§Œì› vs ì£¼ì‹ íˆ¬ì')" class="quick-btn" style="background: #e9ecef; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#03C75A'; this.style.color='white'" onmouseout="this.style.backgroundColor='#e9ecef'; this.style.color='black'">
                                ğŸ’° ì ê¸ˆ vs ì£¼ì‹
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5ë‹¨ê³„: ì•¡ì…˜ í”Œëœ -->
            <section class="section" id="action-section">
                <h2>ğŸ“‹ ì‹¤í–‰ ê³„íš</h2>
                <div class="action-plan" id="action-plan">
                    <!-- êµ¬ì²´ì ì¸ ë§¤ë§¤ ì œì•ˆì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="export-options">
                    <button class="btn secondary" onclick="exportToPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn secondary" onclick="saveToLocalStorage()">ğŸ“ JSON íŒŒì¼ ì €ì¥</button>
                    <button class="btn primary npay-button" onclick="connectNpay()" style="background: linear-gradient(135deg, #03C75A 0%, #00B04F 100%); border: none; padding: 15px 30px; font-size: 16px; font-weight: 600; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                        <span class="npay-logo" style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 18px;">N</span>
                        <span>ë„¤ì´ë²„í˜ì´ ì—°ê²°í•˜ê¸°</span>
                        <span style="font-size: 12px; opacity: 0.8;">ìµœëŒ€ 2% ì ë¦½</span>
                    </button>
                </div>
            </section>
        </main>

        <!-- ë©´ì±…ì¡°í•­ -->
        <footer class="disclaimer">
            <p>âš ï¸ <strong>íˆ¬ì ìœ„í—˜ ê³ ì§€:</strong> ëª¨ë“  íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì œì•ˆì€ ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ íˆ¬ì ê²°ì •ì€ ì‹ ì¤‘íˆ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            <p>ğŸ“œ ê¸ˆìœµíˆ¬ìì—…ë²•ì— ë”°ë¼ íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹Œ ì •ë³´ ì œê³µ ëª©ì ì…ë‹ˆë‹¤.</p>
        </footer>
    </div>

    <!-- ëª¨ë“  ê¸°ëŠ¥ì„ ì—¬ê¸°ì— í†µí•© -->
    <script>
        // ê°„ë‹¨í•œ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ í•¨ìˆ˜ (ì‹¤ì‹œê°„ ë°ì´í„°)
        async function analyzePortfolioSimple() {
            console.log('ğŸ” ì‹¤ì‹œê°„ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì‹œì‘');
            
            let portfolioText, investmentAmount;
            
            try {
                portfolioText = document.getElementById('current-portfolio').value;
                investmentAmount = document.getElementById('investment-amount').value;
                
                console.log('ğŸ“Š ì…ë ¥ê°’:', { portfolioText, investmentAmount });
                
                if (!portfolioText || !investmentAmount) {
                    alert('í¬íŠ¸í´ë¦¬ì˜¤ì™€ íˆ¬ìê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ë¡œë”© í‘œì‹œ
                showQuickNotification('ì‹¤ì‹œê°„ ì£¼ê°€ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
                
                // ì‹¤ì‹œê°„ í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì‹±
                const portfolio = await parsePortfolioQuick(portfolioText);
                const amount = parseInt(investmentAmount);
                
                console.log('ğŸ“Š ì‹¤ì‹œê°„ í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„°:', portfolio);
                
                // ê²°ê³¼ í‘œì‹œ
                displayAnalysisResult(portfolio, amount);
                
                // ì°¨íŠ¸ ìƒì„±
                createPortfolioChart(portfolio, amount);
                
                // ìë™ìœ¼ë¡œ ì‹œì¥ ë°ì´í„° í‘œì‹œ (ë„¤ì´ë²„ ê¸ˆìœµ)
                console.log('ğŸ“Š ë„¤ì´ë²„ ê¸ˆìœµ ì‹œì¥ ë°ì´í„° ìë™ ë¡œë”© ì‹œì‘');
                await fetchMarketData('naver');
                
                // ì‹¤í–‰ ê³„íš ìƒì„±
                generateActionPlan(portfolio, amount);
                
                // ì‹¤ì‹œê°„ ë°ì´í„° ì‚¬ìš© ì—¬ë¶€ í‘œì‹œ
                const realTimeCount = Object.values(portfolio).filter(stock => stock.isRealTime).length;
                const totalCount = Object.keys(portfolio).length;
                
                if (realTimeCount === totalCount) {
                    showQuickNotification(`âœ… ë¶„ì„ ì™„ë£Œ! (ì‹¤ì‹œê°„ ë°ì´í„° ${realTimeCount}/${totalCount})`, 'success');
                } else if (realTimeCount > 0) {
                    showQuickNotification(`âš ï¸ ë¶„ì„ ì™„ë£Œ! (ì‹¤ì‹œê°„ ${realTimeCount}/${totalCount}, ë‚˜ë¨¸ì§€ëŠ” ì¶”ì •ê°€)`, 'warning');
                } else {
                    showQuickNotification('âš ï¸ ë¶„ì„ ì™„ë£Œ! (ì¶”ì • ë°ì´í„° ì‚¬ìš©)', 'warning');
                }
                
                
            } catch (error) {
                console.error('âŒ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return;
            }
        }
        
        // AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ í•¨ìˆ˜ (ì‹¤ì œ Gemini API)
        async function generateRebalancingAdvice() {
            console.log('ğŸ¤– ì‹¤ì œ AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ ì‹œì‘');
            
            try {
                // ìš”ì†Œ ì¡´ì¬ í™•ì¸ ë° ë°ì´í„° ìˆ˜ì§‘
                const riskElement = document.getElementById('risk-level');
                const targetReturnElement = document.getElementById('target-return');
                const portfolioElement = document.getElementById('current-portfolio');
                const investmentAmountElement = document.getElementById('investment-amount');
                
                if (!riskElement || !targetReturnElement || !portfolioElement || !investmentAmountElement) {
                    alert('í•„ìˆ˜ ì…ë ¥ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const riskTolerance = riskElement.value;
                const targetReturn = targetReturnElement.value;
                const portfolioText = portfolioElement.value;
                const investmentAmount = investmentAmountElement.value;
                
                console.log('ğŸ“Š ì…ë ¥ ë°ì´í„°:', { riskTolerance, targetReturn, portfolioText, investmentAmount });
                
                if (!riskTolerance || !targetReturn || !portfolioText || !investmentAmount) {
                    alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ë¡œë”© í‘œì‹œ
                const resultDiv = document.getElementById('rebalancing-result');
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p>ğŸ¤– AIê°€ ìµœì ì˜ ë¦¬ë°¸ëŸ°ì‹± ì „ëµì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        <p style="font-size: 0.9em; color: #666;">ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„°ì™€ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.</p>
                        <div style="margin-top: 15px; font-size: 0.8em; color: #999;">
                            <span id="loading-dots">â—</span>
                        </div>
                    </div>
                `;
                
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
                let dotCount = 1;
                const loadingInterval = setInterval(() => {
                    const dots = 'â—'.repeat(dotCount % 4);
                    const dotsElement = document.getElementById('loading-dots');
                    if (dotsElement) {
                        dotsElement.textContent = dots;
                    }
                    dotCount++;
                }, 500);
                
                // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì‹± (ì‹¤ì‹œê°„ ë°ì´í„° í¬í•¨)
                const portfolio = await parsePortfolioQuick(portfolioText);
                
                // Gemini AI API í˜¸ì¶œ (ì‹¤ì œ ì—°ë™) - ì„œë²„ API í˜•ì‹ì— ë§ì¶¤
                const requestData = {
                    userMessage: `í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ë°¸ëŸ°ì‹± ì¡°ì–¸ì„ ìš”ì²­í•©ë‹ˆë‹¤. ìœ„í—˜ ì„±í–¥: ${riskTolerance}, ëª©í‘œ ìˆ˜ìµë¥ : ${targetReturn}%, ì´ íˆ¬ìê¸ˆì•¡: ${parseInt(investmentAmount).toLocaleString()}ì›`,
                    portfolioContext: {
                        hasPortfolio: true,
                        holdings: Object.entries(portfolio).map(([stock, data]) => ({
                            name: stock,
                            quantity: data.shares,
                            currentPrice: data.currentPrice,
                            totalValue: data.shares * data.currentPrice
                        })),
                        riskTolerance: riskTolerance,
                        targetReturn: parseFloat(targetReturn),
                        investmentAmount: parseInt(investmentAmount),
                        portfolioText: portfolioText
                    },
                    chatHistory: [],
                    timestamp: new Date().toISOString()
                };
                
                console.log('ğŸ¤– Gemini AI API í˜¸ì¶œ ì¤‘... (ì‹¤ì œ API í‚¤ ì‚¬ìš©)');
                console.log('ğŸ“Š ìš”ì²­ ë°ì´í„°:', requestData);
                
                const response = await fetch('/api/investment-advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ ì™„ë£Œ');
                    
                    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
                    clearInterval(loadingInterval);
                    
                    // AI ì œì•ˆ ê²°ê³¼ í‘œì‹œ
                    resultDiv.innerHTML = `
                        <div class="ai-advice-container">
                            <h3 style="color: #03C75A; margin-bottom: 20px;">ğŸ¤– AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ</h3>
                            <div class="advice-content" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; line-height: 1.6;">
                                ${markdownToHtml(result.advice)}
                            </div>
                            <div class="risk-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <strong>âš ï¸ íˆ¬ì ìœ„í—˜ ê³ ì§€:</strong><br>
                                ${result.riskWarning}
                            </div>
                            <div class="api-info" style="font-size: 0.8em; color: #666; margin-top: 10px; text-align: right;">
                                ìƒì„± ì‹œê°„: ${new Date(result.timestamp).toLocaleString()}<br>
                                ëª¨ë¸: ${result.apiUsage?.model || 'Gemini AI'} | ì‘ë‹µ ê¸¸ì´: ${result.apiUsage?.responseLength || 'N/A'}ì
                            </div>
                        </div>
                    `;
                    
                    showQuickNotification('âœ… AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    console.error('âŒ AI ì œì•ˆ ì‹¤íŒ¨:', result.error);
                    
                    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
                    clearInterval(loadingInterval);
                    
                    if (result.error.includes('API í‚¤')) {
                        // API í‚¤ ì—†ì„ ë•Œ ë°ëª¨ ì œì•ˆ í‘œì‹œ
                        showDemoRebalancingAdvice(riskTolerance);
                        showQuickNotification('âš ï¸ ë°ëª¨ ëª¨ë“œ: ì‹¤ì œ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                    } else {
                        resultDiv.innerHTML = `
                            <div style="color: #dc3545; padding: 20px; text-align: center;">
                                <h4>âŒ AI ì œì•ˆ ìƒì„± ì‹¤íŒ¨</h4>
                                <p>${result.error}</p>
                                <button class="btn secondary" onclick="showDemoRebalancingAdvice('${riskTolerance}')">ë°ëª¨ ì œì•ˆ ë³´ê¸°</button>
                            </div>
                        `;
                        showQuickNotification('âŒ AI ì œì•ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                    }
                }
                
            } catch (error) {
                console.error('AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ ì˜¤ë¥˜:', error);
                
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
                clearInterval(loadingInterval);
                
                const resultDiv = document.getElementById('rebalancing-result');
                resultDiv.innerHTML = `
                    <div style="color: #dc3545; padding: 20px; text-align: center;">
                        <h4>âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</h4>
                        <p>AI ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</p>
                        <button class="btn secondary" onclick="generateRebalancingAdvice()">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
                showQuickNotification('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }
        
        // ë°ëª¨ ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ (ë°±ì—…ìš©)
        function showDemoRebalancingAdvice(riskTolerance) {
            const resultDiv = document.getElementById('rebalancing-result');
            console.log('ğŸ“Š ë°ëª¨ ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ í‘œì‹œ:', riskTolerance);
            
            if (!riskTolerance) {
                alert('ìœ„í—˜ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ìƒì„¸í•œ ë¦¬ë°¸ëŸ°ì‹± ì¡°ì–¸ ìƒì„±
                const advice = {
                    conservative: `
                        <strong>ì•ˆì • ì¤‘ì‹¬ í¬íŠ¸í´ë¦¬ì˜¤ ê¶Œì¥:</strong><br>
                        â€¢ í•œêµ­ êµ­ê³ ì±„ê¶Œ 30%, íšŒì‚¬ì±„ 20%<br>
                        â€¢ ëŒ€í˜• ìš°ëŸ‰ì£¼ (ì‚¼ì„±ì „ì, LGí™”í•™) 30%<br>
                        â€¢ ë°°ë‹¹ì£¼ ë° ë¦¬ì¸  20%<br>
                        â€¢ ì˜ˆìƒ ìˆ˜ìµë¥ : ì—° 4-6%, ë³€ë™ì„± ë‚®ìŒ
                    `,
                    moderate: `
                        <strong>ê· í˜• ì¡íŒ í¬íŠ¸í´ë¦¬ì˜¤ ê¶Œì¥:</strong><br>
                        â€¢ êµ­ë‚´ ì£¼ì‹ 40% (ëŒ€í˜•ì£¼ 25%, ì¤‘ì†Œí˜•ì£¼ 15%)<br>
                        â€¢ í•´ì™¸ ì£¼ì‹ 20% (ë¯¸êµ­ ETF ìœ„ì£¼)<br>
                        â€¢ ì±„ê¶Œ 30% (êµ­ê³ ì±„, íšŒì‚¬ì±„ í˜¼í•©)<br>
                        â€¢ ëŒ€ì•ˆíˆ¬ì 10% (ë¦¬ì¸ , ì›ìì¬)<br>
                        â€¢ ì˜ˆìƒ ìˆ˜ìµë¥ : ì—° 6-8%, ì ì • ë³€ë™ì„±
                    `,
                    aggressive: `
                        <strong>ì„±ì¥ ì¤‘ì‹¬ í¬íŠ¸í´ë¦¬ì˜¤ ê¶Œì¥:</strong><br>
                        â€¢ êµ­ë‚´ ì„±ì¥ì£¼ 40% (ê¸°ìˆ ì£¼, ë°”ì´ì˜¤ í¬í•¨)<br>
                        â€¢ í•´ì™¸ ì„±ì¥ì£¼ 30% (ë‚˜ìŠ¤ë‹¥ ETF, ì‹ í¥êµ­)<br>
                        â€¢ í…Œë§ˆì£¼ 20% (AI, ë°˜ë„ì²´, ì‹ ì¬ìƒì—ë„ˆì§€)<br>
                        â€¢ í˜„ê¸ˆ 10% (ê¸°íšŒ íˆ¬ììš©)<br>
                        â€¢ ì˜ˆìƒ ìˆ˜ìµë¥ : ì—° 8-12%, ë†’ì€ ë³€ë™ì„± ê°ìˆ˜
                    `
                };
                
                const result = advice[riskTolerance] || "ìœ„í—˜ë„ì— ë§ëŠ” ì¡°ì–¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                console.log('ğŸ“Š ìƒì„±ëœ ì¡°ì–¸:', result);
                
                // ê²°ê³¼ í‘œì‹œ
                const resultContainer = document.getElementById('rebalancing-result');
                console.log('ğŸ“Š ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì°¾ê¸°:', resultContainer);
                
                if (resultContainer) {
                    resultContainer.innerHTML = `
                        <div class="ai-advice" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #03C75A;">
                            <h4 style="color: #03C75A; margin-bottom: 15px;">ğŸ¤– AI ë¦¬ë°¸ëŸ°ì‹± ì¡°ì–¸</h4>
                            <p style="margin-bottom: 10px;"><strong>ì„ íƒí•œ ìœ„í—˜ë„:</strong> ${riskTolerance}</p>
                            <div style="margin-bottom: 15px; font-size: 16px; line-height: 1.6;">${markdownToHtml(result)}</div>
                            <p style="color: #e74c3c; font-size: 0.9em; margin: 0;">âš ï¸ ì´ëŠ” ì˜ˆì‹œ ì¡°ì–¸ì…ë‹ˆë‹¤. ì‹¤ì œ íˆ¬ì ê²°ì • ì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                    resultContainer.style.display = 'block';
                    
                    // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    console.log('âœ… ê²°ê³¼ í‘œì‹œ ë° ìŠ¤í¬ë¡¤ ì™„ë£Œ');
                } else {
                    console.error('âŒ rebalancing-result ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    alert('ê²°ê³¼ë¥¼ í‘œì‹œí•  ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                showQuickNotification('ğŸ¤– AI ë¦¬ë°¸ëŸ°ì‹± ì¡°ì–¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                console.log('âœ… AI ë¦¬ë°¸ëŸ°ì‹± í•¨ìˆ˜ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ AI ë¦¬ë°¸ëŸ°ì‹± ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸ ìƒì„±
        let portfolioChart = null;
        
        function createPortfolioChart(portfolio, totalAmount) {
            console.log('ğŸ“Š ì°¨íŠ¸ ìƒì„± ì‹œì‘');
            
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) {
                console.error('âŒ ì°¨íŠ¸ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            // ë°ì´í„° ì¤€ë¹„
            const labels = Object.keys(portfolio);
            const data = Object.values(portfolio).map(stock => stock.shares * stock.currentPrice);
            const colors = [
                '#03C75A', // ë„¤ì´ë²„í˜ì´ ê·¸ë¦°
                '#FF6B6B', // ë ˆë“œ
                '#4ECDC4', // í„°ì½°ì´ì¦ˆ
                '#45B7D1', // ë¸”ë£¨
                '#96CEB4', // ë¯¼íŠ¸
                '#FFEAA7', // ì˜ë¡œìš°
                '#DDA0DD', // í¼í”Œ
                '#F7DC6F'  // ê³¨ë“œ
            ];
            
            try {
                portfolioChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±',
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ìì‚° êµ¬ì„±',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / totalAmount) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${value.toLocaleString()}ì› (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const percentage = ((value / totalAmount) * 100).toFixed(1);
                                        return `${label}: ${value.toLocaleString()}ì› (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 1500
                        }
                    }
                });
                
                console.log('âœ… ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                
                // ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ
                ctx.style.display = 'none';
                const container = ctx.parentElement;
                container.innerHTML = `
                    <div style="height: 400px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6c757d; flex-direction: column;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
                        <div>ì°¨íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">ë°ì´í„°ëŠ” ìœ„ì˜ ë¶„ì„ ê²°ê³¼ì—ì„œ í™•ì¸í•˜ì„¸ìš”</div>
                    </div>
                `;
            }
        }
        
        // ì„±ëŠ¥ ë¦¬í¬íŠ¸ í‘œì‹œ
        function showDetailedReport() {
            console.log('ğŸ“Š ìƒì„¸ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìš”ì²­');
            
            if (typeof getPerformanceReport === 'function') {
                const report = getPerformanceReport();
                
                const reportHtml = `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #03C75A; margin-bottom: 15px;">ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                        <div style="margin-bottom: 15px;">
                            <h4>í˜„ì¬ ìƒíƒœ:</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li>ğŸ“ˆ í˜ì´ì§€ ë¡œë”©: ${report.í˜„ì¬_ìƒíƒœ?.í˜ì´ì§€_ë¡œë”© || 'N/A'}</li>
                                <li>âš¡ í‰ê·  ë¡œë”©: ${report.í˜„ì¬_ìƒíƒœ?.í‰ê· _ë¡œë”© || 'N/A'}</li>
                                <li>ğŸŒ API í˜¸ì¶œìˆ˜: ${report.í˜„ì¬_ìƒíƒœ?.API_í˜¸ì¶œìˆ˜ || 0}</li>
                                <li>ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${report.í˜„ì¬_ìƒíƒœ?.ë©”ëª¨ë¦¬_ì‚¬ìš©ëŸ‰ || 'N/A'}</li>
                                <li>ğŸ“¶ ë„¤íŠ¸ì›Œí¬: ${report.í˜„ì¬_ìƒíƒœ?.ë„¤íŠ¸ì›Œí¬ || 'N/A'}</li>
                            </ul>
                        </div>
                        <div>
                            <h4>ê¶Œì¥ì‚¬í•­:</h4>
                            <ul>
                                ${report.ê¶Œì¥ì‚¬í•­?.map(suggestion => `<li>${suggestion}</li>`).join('') || '<li>ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</li>'}
                            </ul>
                        </div>
                        <button onclick="this.parentElement.style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
                    </div>
                `;
                
                const existingReport = document.querySelector('.performance-report');
                if (existingReport) {
                    existingReport.remove();
                }
                
                const reportDiv = document.createElement('div');
                reportDiv.className = 'performance-report';
                reportDiv.innerHTML = reportHtml;
                
                const performanceSection = document.getElementById('performance-section');
                performanceSection.appendChild(reportDiv);
                
                reportDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ì‹¤ì‹œê°„ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        function updatePerformanceMetrics() {
            // í˜ì´ì§€ ë¡œë”© ì‹œê°„ ì—…ë°ì´íŠ¸
            if (typeof performance !== 'undefined' && performance.timing) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                if (loadTime > 0) {
                    document.getElementById('page-load-time').textContent = `${loadTime}ms`;
                }
            }
            
            // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
            if (performance.memory) {
                const memoryUsage = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memory-usage').textContent = `${memoryUsage}MB`;
            }
            
            // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (navigator.connection) {
                const connection = navigator.connection;
                const networkType = connection.effectiveType || 'unknown';
                document.getElementById('network-status').textContent = networkType;
            }
        }
        
        // ê°œì„ ëœ í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì‹± (ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ)
        async function parsePortfolioQuick(text) {
            const portfolio = {};
            const lines = text.split(/[,\n]/);
            
            // ì£¼ì‹ ì´ë¦„ê³¼ ì£¼ìˆ˜ë¥¼ ë¨¼ì € íŒŒì‹±
            const stockList = [];
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    // íŒ¨í„´ 1: "ì‚¼ì„±ì „ì 10ì£¼" í˜•íƒœ
                    let match = trimmed.match(/(.+?)\s*(\d+)\s*ì£¼/);
                    
                    if (match) {
                        const stockName = match[1].trim();
                        const shares = parseInt(match[2]);
                        stockList.push({ stockName, shares });
                    } else {
                        // íŒ¨í„´ 2: "ì‚¼ì„±ì „ì 10" í˜•íƒœ (ì£¼ ì—†ì´ ìˆ«ìë§Œ)
                        match = trimmed.match(/(.+?)\s+(\d+)$/);
                        
                        if (match) {
                            const stockName = match[1].trim();
                            const shares = parseInt(match[2]);
                            stockList.push({ stockName, shares });
                        } else {
                            // íŒ¨í„´ 3: "ì‚¼ì„±ì „ì10" í˜•íƒœ (ê³µë°± ì—†ì´)
                            match = trimmed.match(/^(.+?)(\d+)$/);
                            
                            if (match && match[1].length > 1) { // ì¢…ëª©ëª…ì´ ìµœì†Œ 2ê¸€ì ì´ìƒ
                                const stockName = match[1].trim();
                                const shares = parseInt(match[2]);
                                
                                // ì¢…ëª©ëª…ì´ ìˆ«ìë¡œë§Œ êµ¬ì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
                                if (!/^\d+$/.test(stockName)) {
                                    stockList.push({ stockName, shares });
                                }
                            }
                        }
                    }
                }
            });
            
            // ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ (ë³‘ë ¬ ì²˜ë¦¬)
            console.log('ğŸ“Š ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ ì‹œì‘...');
            const pricePromises = stockList.map(async ({ stockName, shares }) => {
                const priceData = await getRealTimePrice(stockName);
                return {
                    stockName,
                    shares,
                    currentPrice: priceData.price,
                    marketData: priceData
                };
            });
            
            try {
                const results = await Promise.all(pricePromises);
                results.forEach(({ stockName, shares, currentPrice, marketData }) => {
                    portfolio[stockName] = { 
                        shares, 
                        currentPrice,
                        marketData,
                        isRealTime: !marketData.fallback
                    };
                });
                
                console.log('ğŸ“Š ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ ì™„ë£Œ:', portfolio);
            } catch (error) {
                console.error('âŒ ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ì‹œ ë°±ì—… ë°ì´í„° ì‚¬ìš©
                stockList.forEach(({ stockName, shares }) => {
                    portfolio[stockName] = { 
                        shares, 
                        currentPrice: getEstimatedPrice(stockName),
                        isRealTime: false
                    };
                });
            }
            
            return portfolio;
        }
        
        // ìˆ«ìë¥¼ í•œêµ­ì‹ ì‰¼í‘œ í‘œê¸°ë¡œ ë³€í™˜
        function formatKoreanNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // ì‹¤ì œ ì£¼ì‹ ê°€ê²© ì¡°íšŒ (ë„¤ì´ë²„ ê¸ˆìœµ API)
        async function getRealTimePrice(stockName) {
            try {
                console.log(`ğŸ“Š ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ: ${stockName}`);
                
                const response = await fetch(`/api/naver-finance/${encodeURIComponent(stockName)}`);
                const data = await response.json();
                
                if (data.success && data.price > 0) {
                    console.log(`âœ… ${stockName} ì‹¤ì‹œê°„ ê°€ê²©: ${data.price}ì›`);
                    return {
                        price: data.price,
                        change: data.change,
                        changePercent: data.changePercent,
                        volume: data.volume,
                        marketState: data.marketState,
                        lastUpdate: data.lastUpdateTime
                    };
                } else {
                    console.warn(`âš ï¸ ${stockName} ì‹¤ì‹œê°„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©`);
                    return { price: getEstimatedPrice(stockName), fallback: true };
                }
            } catch (error) {
                console.error(`âŒ ${stockName} ê°€ê²© ì¡°íšŒ ì˜¤ë¥˜:`, error);
                return { price: getEstimatedPrice(stockName), fallback: true };
            }
        }
        
        // ì˜ˆìƒ ì£¼ê°€ (ë°±ì—…ìš©)
        function getEstimatedPrice(stockName) {
            const prices = {
                'ì‚¼ì„±ì „ì': 71900,
                'ì¹´ì¹´ì˜¤': 54200,
                'ë„¤ì´ë²„': 195000,
                'SKí•˜ì´ë‹‰ìŠ¤': 128500,
                'LGí™”í•™': 378000,
                'NAVER': 195000,
                'Kakao': 54200
            };
            return prices[stockName] || 50000;
        }
        
        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ (í•œêµ­ì‹ ì‰¼í‘œ í‘œê¸° ì ìš©)
        function displayAnalysisResult(portfolio, totalAmount) {
            const stockGrid = document.getElementById('stock-grid');
            if (!stockGrid) return;
            
            let html = '<h3>ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼</h3>';
            let portfolioValue = 0;
            
            Object.entries(portfolio).forEach(([name, data]) => {
                const value = data.shares * data.currentPrice;
                portfolioValue += value;
                
                html += `
                    <div class="stock-card">
                        <h4>${name}</h4>
                        <p>ë³´ìœ : ${formatKoreanNumber(data.shares)}ì£¼</p>
                        <p>í˜„ì¬ê°€: ${formatKoreanNumber(data.currentPrice)}ì›</p>
                        <p>í‰ê°€ê¸ˆì•¡: ${formatKoreanNumber(value)}ì›</p>
                        <p>ë¹„ì¤‘: ${((value / totalAmount) * 100).toFixed(1)}%</p>
                    </div>
                `;
            });
            
            html += `
                <div class="analysis-summary">
                    <h4>ğŸ’¡ ë¶„ì„ ìš”ì•½</h4>
                    <p>ì´ íˆ¬ìê¸ˆì•¡: ${formatKoreanNumber(totalAmount)}ì›</p>
                    <p>í˜„ì¬ í‰ê°€ê¸ˆì•¡: ${formatKoreanNumber(portfolioValue)}ì›</p>
                    <p>ì†ìµ: ${formatKoreanNumber(portfolioValue - totalAmount)}ì›</p>
                    <p>ìˆ˜ìµë¥ : ${(((portfolioValue - totalAmount) / totalAmount) * 100).toFixed(2)}%</p>
                </div>
                
                <div class="ai-advice">
                    <h4>ğŸ¤– AI íˆ¬ì ì¡°ì–¸</h4>
                    <p>í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” ê¸°ìˆ ì£¼ ì¤‘ì‹¬ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <p>ì ì ˆí•œ ë¶„ì‚°íˆ¬ìê°€ ì´ë£¨ì–´ì ¸ ìˆìœ¼ë‚˜, ì„¹í„° ì§‘ì¤‘ë„ê°€ ë†’ìŠµë‹ˆë‹¤.</p>
                    <p>ì •ê¸°ì ì¸ ë¦¬ë°¸ëŸ°ì‹±ì„ í†µí•´ ìœ„í—˜ì„ ê´€ë¦¬í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                    <p style="color: #e74c3c;">âš ï¸ íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;
            
            stockGrid.innerHTML = html;
            stockGrid.style.display = 'block';
        }
        
        // ë¹ ë¥¸ ì•Œë¦¼ (íƒ€ì…ë³„ ìƒ‰ìƒ ì§€ì›)
        function showQuickNotification(message, type = 'success') {
            const notification = document.createElement('div');
            
            // íƒ€ì…ë³„ ìƒ‰ìƒ ì„¤ì •
            const colors = {
                success: '#03C75A',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            const backgroundColor = colors[type] || colors.success;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${backgroundColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                max-width: 300px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // ìë™ ì œê±°
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // í¬íŠ¸í´ë¦¬ì˜¤ í…ìŠ¤íŠ¸ì—ì„œ ì¢…ëª©ëª… ì¶”ì¶œ í•¨ìˆ˜
        function extractStockNamesFromPortfolio(portfolioText) {
            const stockNames = [];
            if (!portfolioText) return stockNames;
            
            const lines = portfolioText.split(/[,\n]/);
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    // íŒ¨í„´ 1: "ì‚¼ì„±ì „ì 10ì£¼" í˜•íƒœ
                    let match = trimmed.match(/(.+?)\s*(\d+)\s*ì£¼/);
                    
                    if (match) {
                        const stockName = match[1].trim();
                        if (!stockNames.includes(stockName)) {
                            stockNames.push(stockName);
                        }
                    } else {
                        // íŒ¨í„´ 2: "ì‚¼ì„±ì „ì 10" í˜•íƒœ (ì£¼ ì—†ì´ ìˆ«ìë§Œ)
                        match = trimmed.match(/(.+?)\s+(\d+)$/);
                        
                        if (match) {
                            const stockName = match[1].trim();
                            if (!stockNames.includes(stockName)) {
                                stockNames.push(stockName);
                            }
                        } else {
                            // íŒ¨í„´ 3: "ì‚¼ì„±ì „ì10" í˜•íƒœ (ê³µë°± ì—†ì´)
                            match = trimmed.match(/^(.+?)(\d+)$/);
                            
                            if (match && match[1].length > 1) { // ì¢…ëª©ëª…ì´ ìµœì†Œ 2ê¸€ì ì´ìƒ
                                const stockName = match[1].trim();
                                
                                // ì¢…ëª©ëª…ì´ ìˆ«ìë¡œë§Œ êµ¬ì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
                                if (!/^\d+$/.test(stockName) && !stockNames.includes(stockName)) {
                                    stockNames.push(stockName);
                                }
                            }
                        }
                    }
                }
            });
            
            return stockNames;
        }
        
        // ì‹œì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        async function fetchMarketData(source) {
            console.log(`ğŸ“Š ì‹œì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°: ${source}`);
            
            try {
                const loadingDiv = document.getElementById('loading');
                const stockGrid = document.getElementById('stock-grid');
                
                // ë¡œë”© í‘œì‹œ
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (stockGrid) stockGrid.innerHTML = '';
                
                showQuickNotification(`${source} ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...`, 'info');
                
                // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì¢…ëª© ì¶”ì¶œ
                const portfolioText = document.getElementById('current-portfolio')?.value || '';
                const stockNames = extractStockNamesFromPortfolio(portfolioText);
                
                if (stockNames.length === 0) {
                    showQuickNotification('âš ï¸ ë³´ìœ  ì¢…ëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    return;
                }
                
                console.log('ğŸ“Š ì¶”ì¶œëœ ì¢…ëª© ë¦¬ìŠ¤íŠ¸:', stockNames);
                let results = [];
                
                if (source === 'naver') {
                    // ë„¤ì´ë²„ ê¸ˆìœµ API í˜¸ì¶œ
                    for (const stockName of stockNames) {
                        const response = await fetch(`/api/naver-finance/${encodeURIComponent(stockName)}`);
                        const data = await response.json();
                        results.push({
                            name: stockName,
                            price: data.price || 0,
                            change: data.change || 0,
                            changePercent: data.changePercent || 0,
                            volume: data.volume || 0,
                            source: data.isRealTime ? 'ë„¤ì´ë²„ ê¸ˆìœµ (ì‹¤ì‹œê°„)' : 'ë„¤ì´ë²„ ê¸ˆìœµ (ì§€ì—°)',
                            success: data.success,
                            isRealTime: data.isRealTime || false
                        });
                    }
                } else if (source === 'kis') {
                    // KIS APIëŠ” ë¯¸êµ¬í˜„ì´ë¯€ë¡œ ìƒ˜í”Œ ë°ì´í„°
                    showQuickNotification('KIS APIëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.', 'warning');
                    results = [
                        { name: 'ì‚¼ì„±ì „ì', price: 71900, change: -800, changePercent: -1.1, volume: 12456789, source: 'KIS API (Demo)', success: true },
                        { name: 'ì¹´ì¹´ì˜¤', price: 54200, change: 600, changePercent: 1.12, volume: 8765432, source: 'KIS API (Demo)', success: true },
                        { name: 'ë„¤ì´ë²„', price: 195000, change: -2000, changePercent: -1.02, volume: 3456789, source: 'KIS API (Demo)', success: true }
                    ];
                } else if (source === 'sample') {
                    // ìƒ˜í”Œ ë°ì´í„°
                    results = [
                        { name: 'ì‚¼ì„±ì „ì', price: 72000, change: 100, changePercent: 0.14, volume: 10000000, source: 'ìƒ˜í”Œ ë°ì´í„°', success: true },
                        { name: 'ì¹´ì¹´ì˜¤', price: 55000, change: -300, changePercent: -0.54, volume: 5000000, source: 'ìƒ˜í”Œ ë°ì´í„°', success: true },
                        { name: 'ë„¤ì´ë²„', price: 200000, change: 3000, changePercent: 1.52, volume: 2000000, source: 'ìƒ˜í”Œ ë°ì´í„°', success: true }
                    ];
                }
                
                // ê²°ê³¼ í‘œì‹œ
                displayMarketData(results);
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                showQuickNotification(`${source} ë°ì´í„° ë¡œë”© ì™„ë£Œ!`, 'success');
                
            } catch (error) {
                console.error('âŒ ì‹œì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showQuickNotification('ì‹œì¥ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + error.message, 'error');
                
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }
        
        // ì‹œì¥ ë°ì´í„° í‘œì‹œ í•¨ìˆ˜
        function displayMarketData(results) {
            const stockGrid = document.getElementById('stock-grid');
            if (!stockGrid) return;
            
            let html = '';
            results.forEach(stock => {
                const changeColor = stock.change >= 0 ? '#03C75A' : '#dc3545';
                const changeIcon = stock.change >= 0 ? 'â–²' : 'â–¼';
                
                html += `
                    <div class="stock-card" style="border: 1px solid #ddd; padding: 20px; margin: 10px; border-radius: 8px; background: white;">
                        <h4 style="color: #333; margin-bottom: 10px;">${stock.name}</h4>
                        <p style="font-size: 1.5em; font-weight: bold; color: #333; margin: 5px 0;">
                            ${formatKoreanNumber(stock.price)}ì›
                        </p>
                        <p style="color: ${changeColor}; margin: 5px 0;">
                            ${changeIcon} ${formatKoreanNumber(Math.abs(stock.change))}ì› (${stock.changePercent}%)
                        </p>
                        <p style="color: #666; font-size: 0.9em; margin: 5px 0;">
                            ê±°ë˜ëŸ‰: ${formatKoreanNumber(stock.volume)}
                        </p>
                        <p style="color: #999; font-size: 0.8em; margin: 5px 0;">
                            ì¶œì²˜: ${stock.source} ${stock.isRealTime ? 'ğŸŸ¢ ì‹¤ì‹œê°„' : 'ğŸŸ¡ ì§€ì—°'}
                        </p>
                    </div>
                `;
            });
            
            stockGrid.innerHTML = html;
            stockGrid.style.display = 'grid';
        }
        
        // ì‹¤í–‰ ê³„íš ìƒì„± í•¨ìˆ˜
        function generateActionPlan(portfolio, totalAmount) {
            console.log('ğŸ“‹ ì‹¤í–‰ ê³„íš ìƒì„± ì‹œì‘');
            
            const actionPlanDiv = document.getElementById('action-plan');
            if (!actionPlanDiv) {
                console.error('âŒ action-plan ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„
            const stocks = Object.entries(portfolio);
            const totalValue = stocks.reduce((sum, [name, data]) => sum + (data.shares * data.currentPrice), 0);
            
            // ì¢…ëª©ë³„ ë¹„ì¤‘ ê³„ì‚°
            const stockWeights = stocks.map(([name, data]) => ({
                name,
                shares: data.shares,
                value: data.shares * data.currentPrice,
                weight: ((data.shares * data.currentPrice) / totalValue * 100).toFixed(1),
                currentPrice: data.currentPrice
            })).sort((a, b) => b.value - a.value);
            
            let actionPlanHTML = `
                <div class="action-plan-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; border: 1px solid #dee2e6;">
                    <div class="plan-header" style="margin-bottom: 20px;">
                        <h3 style="color: #03C75A; display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="background: #03C75A; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">ğŸ“‹</span>
                            êµ¬ì²´ì  ì‹¤í–‰ ê³„íš
                        </h3>
                        <p style="color: #6c757d; margin: 0; font-size: 14px;">í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ë‹¨ê³„ë³„ ì•¡ì…˜ í”Œëœì…ë‹ˆë‹¤.</p>
                    </div>
                    
                    <div class="current-analysis" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                        <h4 style="color: #17a2b8; margin-bottom: 15px;">ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™© ë¶„ì„</h4>
                        <div class="stock-breakdown">
            `;
            
            // ì¢…ëª©ë³„ ìƒì„¸ ì •ë³´ì™€ ê¶Œì¥ì‚¬í•­
            stockWeights.forEach((stock, index) => {
                const isOverweight = parseFloat(stock.weight) > 35;
                const isUnderweight = parseFloat(stock.weight) < 15;
                let recommendation = 'âœ… ì ì • ë¹„ì¤‘ ìœ ì§€';
                let actionColor = '#28a745';
                
                if (isOverweight) {
                    recommendation = 'ğŸ”» ë¶€ë¶„ ë§¤ë„ ê¶Œì¥';
                    actionColor = '#dc3545';
                } else if (isUnderweight && parseFloat(stock.weight) > 5) {
                    recommendation = 'ğŸ”º ì¶”ê°€ ë§¤ìˆ˜ ê³ ë ¤';
                    actionColor = '#ffc107';
                }
                
                actionPlanHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f3f4;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${stock.name}</div>
                            <div style="font-size: 12px; color: #6c757d;">${stock.shares}ì£¼ @ ${formatKoreanNumber(stock.currentPrice)}ì›</div>
                        </div>
                        <div style="text-align: center; flex: 0 0 80px;">
                            <div style="font-size: 18px; font-weight: bold; color: #03C75A;">${stock.weight}%</div>
                        </div>
                        <div style="text-align: right; flex: 0 0 100px;">
                            <div style="font-weight: bold; margin-bottom: 4px;">${formatKoreanNumber(stock.value)}ì›</div>
                            <div style="font-size: 11px; color: ${actionColor}; font-weight: 500;">${recommendation}</div>
                        </div>
                    </div>
                `;
            });
            
            // êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ ìƒì„±
            let actions = [];
            
            stockWeights.forEach(stock => {
                if (parseFloat(stock.weight) > 35) {
                    const reduceShares = Math.ceil(stock.shares * 0.25);
                    actions.push({
                        priority: 1,
                        type: 'SELL',
                        stock: stock.name,
                        shares: reduceShares,
                        amount: reduceShares * stock.currentPrice,
                        reason: `ë¹„ì¤‘ ${stock.weight}% â†’ ê³¼ë„í•œ ì§‘ì¤‘ ë¦¬ìŠ¤í¬`
                    });
                }
                
                if (parseFloat(stock.weight) < 15 && parseFloat(stock.weight) > 5) {
                    const addShares = Math.ceil(stock.shares * 0.3);
                    actions.push({
                        priority: 2,
                        type: 'BUY',
                        stock: stock.name,
                        shares: addShares,
                        amount: addShares * stock.currentPrice,
                        reason: `ë¹„ì¤‘ ${stock.weight}% â†’ ê· í˜• ê°œì„  í•„ìš”`
                    });
                }
            });
            
            actionPlanHTML += `
                        </div>
                    </div>
                    
                    <div class="action-steps" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">ğŸ¯ ì‹¤í–‰ ë‹¨ê³„</h4>
            `;
            
            if (actions.length === 0) {
                actionPlanHTML += `
                    <div style="text-align: center; padding: 20px; color: #28a745;">
                        <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
                        <h5 style="margin-bottom: 10px;">í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì˜ ê· í˜•ì¡í˜€ ìˆìŠµë‹ˆë‹¤!</h5>
                        <p style="color: #6c757d; margin: 0;">í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ì‹œê³  ì •ê¸°ì ìœ¼ë¡œ ë¦¬ë°¸ëŸ°ì‹±ì„ ê²€í† í•˜ì„¸ìš”.</p>
                    </div>
                `;
            } else {
                actions.sort((a, b) => a.priority - b.priority);
                
                actions.forEach((action, index) => {
                    const stepNum = index + 1;
                    const typeIcon = action.type === 'SELL' ? 'ğŸ“‰' : 'ğŸ“ˆ';
                    const typeColor = action.type === 'SELL' ? '#dc3545' : '#03C75A';
                    const actionText = action.type === 'SELL' ? 'ë§¤ë„' : 'ë§¤ìˆ˜';
                    
                    actionPlanHTML += `
                        <div class="action-step" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: flex-start;">
                            <div style="background: ${typeColor}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; flex-shrink: 0;">
                                ${stepNum}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${typeIcon} ${action.stock} ${action.shares}ì£¼ ${actionText}
                                </div>
                                <div style="font-size: 13px; color: #6c757d; margin-bottom: 5px;">
                                    ğŸ’° ì˜ˆìƒ ê¸ˆì•¡: ${formatKoreanNumber(action.amount)}ì›
                                </div>
                                <div style="font-size: 12px; color: #856404; background: #fff3cd; padding: 5px 8px; border-radius: 4px; display: inline-block;">
                                    ğŸ’¡ ${action.reason}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            actionPlanHTML += `
                    </div>
                    
                    <div class="timeline" style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #6f42c1;">
                        <h4 style="color: #6f42c1; margin-bottom: 15px;">â° ì‹¤í–‰ ì¼ì •</h4>
                        <div class="timeline-item" style="margin-bottom: 15px; display: flex; align-items: center;">
                            <div style="background: #dc3545; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold;">ì˜¤ëŠ˜</div>
                            <div>
                                <strong>ìš°ì„ ìˆœìœ„ ë§¤ë„ ì£¼ë¬¸ ì‹¤í–‰</strong>
                                <div style="font-size: 12px; color: #6c757d;">ì‹œì¥ ê°œì¥ í›„ 1ì‹œê°„ ì´ë‚´ ê¶Œì¥</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="margin-bottom: 15px; display: flex; align-items: center;">
                            <div style="background: #ffc107; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold;">+2ì¼</div>
                            <div>
                                <strong>ë§¤ë„ ëŒ€ê¸ˆ ê²°ì œ í›„ ì¬íˆ¬ì</strong>
                                <div style="font-size: 12px; color: #6c757d;">T+2ì¼ ê²°ì œ ì™„ë£Œ í›„ ë§¤ìˆ˜ ì§„í–‰</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="display: flex; align-items: center;">
                            <div style="background: #28a745; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold;">+7ì¼</div>
                            <div>
                                <strong>í¬íŠ¸í´ë¦¬ì˜¤ ì¬ì ê²€</strong>
                                <div style="font-size: 12px; color: #6c757d;">ë¦¬ë°¸ëŸ°ì‹± íš¨ê³¼ í™•ì¸ ë° ì¶”ê°€ ì¡°ì •</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            actionPlanDiv.innerHTML = actionPlanHTML;
            console.log('âœ… êµ¬ì²´ì  ì‹¤í–‰ ê³„íš ìƒì„± ì™„ë£Œ');
        }
        
        // PDF ë””ë²„ê¹… í•¨ìˆ˜ ì œê±°ë¨ (ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ì— ë¶ˆí•„ìš”)
        function debugPDFStatus_REMOVED() {
            console.log('ğŸ” PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë²„ê¹… ì‹œì‘');
            console.log('1. window.jsPDF ì¡´ì¬ ì—¬ë¶€:', typeof window.jsPDF);
            console.log('2. window.jsPDF ë‚´ìš©:', window.jsPDF);
            console.log('3. window.jsPDFReady ìƒíƒœ:', window.jsPDFReady);
            
            showQuickNotification('ğŸ” PDF ë””ë²„ê¹… ì •ë³´ë¥¼ ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”', 'info');
            
            if (window.jsPDF) {
                console.log('4. jsPDF ìƒì„±ì í…ŒìŠ¤íŠ¸ ì‹œë„...');
                try {
                    let testPdf;
                    if (window.jsPDF.jsPDF) {
                        testPdf = new window.jsPDF.jsPDF();
                        console.log('5. âœ… UMD í˜•ì‹ìœ¼ë¡œ jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ');
                    } else if (typeof window.jsPDF === 'function') {
                        testPdf = new window.jsPDF();
                        console.log('5. âœ… ì§ì ‘ ìƒì„±ìë¡œ jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ');
                    }
                    
                    // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ PDF ìƒì„± ì‹œë„
                    testPdf.text('Test PDF Generation - Success!', 20, 20);
                    testPdf.text('Generated at: ' + new Date().toLocaleString(), 20, 30);
                    console.log('6. âœ… í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ì¶”ê°€ ì„±ê³µ');
                    
                    // ì‹¤ì œ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (ì‚¬ìš©ì ì„ íƒ)
                    if (confirm('ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ PDFë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„±ê³µí•˜ë©´ ì‹¤ì œ PDF ë‹¤ìš´ë¡œë“œë„ ì‘ë™í•©ë‹ˆë‹¤)')) {
                        testPdf.save('ë§ˆì´ë°ì´í„°-jsPDF-í…ŒìŠ¤íŠ¸.pdf');
                        console.log('7. âœ… í…ŒìŠ¤íŠ¸ PDF ë‹¤ìš´ë¡œë“œ ì„±ê³µ');
                        showQuickNotification('âœ… í…ŒìŠ¤íŠ¸ PDF ë‹¤ìš´ë¡œë“œ ì„±ê³µ! ì‹¤ì œ PDF ë‹¤ìš´ë¡œë“œë„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.', 'success');
                    }
                    
                    return true;
                } catch (error) {
                    console.log('5. âŒ jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨:', error);
                    showQuickNotification('âŒ jsPDF í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
                    return false;
                }
            } else {
                console.log('4. âŒ window.jsPDFê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
                
                // ìë™ ë¡œë”© ì‹œë„ ì˜µì…˜ ì œê³µ
                const userChoice = confirm('jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”:\nâ€¢ í™•ì¸: ìë™ ë¡œë”© ì¬ì‹œë„\nâ€¢ ì·¨ì†Œ: í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆ ì‚¬ìš©');
                
                if (userChoice) {
                    showQuickNotification('â³ jsPDF ìë™ ë¡œë”© ì¬ì‹œë„ ì¤‘...', 'info');
                    window.ensureJsPDFLoaded()
                        .then(() => {
                            showQuickNotification('âœ… jsPDF ë¡œë”© ì™„ë£Œ! ë‹¤ì‹œ ë””ë²„ê¹…í•´ë³´ì„¸ìš”.', 'success');
                            setTimeout(() => debugPDFStatus(), 500);
                        })
                        .catch(error => {
                            showQuickNotification('âŒ jsPDF ìë™ ë¡œë”© ì‹¤íŒ¨. í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆì„ ì‚¬ìš©í•˜ì„¸ìš”.', 'error');
                            console.error('jsPDF ë¡œë”© ìµœì¢… ì‹¤íŒ¨:', error);
                        });
                } else {
                    showQuickNotification('ğŸ’¡ "ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ëŒ€ì‹  ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.', 'info');
                }
            }
            
            // ë¡œë“œëœ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ë“¤ í™•ì¸
            const scripts = document.querySelectorAll('script[src*="jspdf"]');
            console.log('8. ë¡œë“œëœ jsPDF ìŠ¤í¬ë¦½íŠ¸ ê°œìˆ˜:', scripts.length);
            scripts.forEach((script, index) => {
                console.log(`   ìŠ¤í¬ë¦½íŠ¸ ${index + 1}:`, script.src, 'loaded:', !script.error);
            });
            
            return false;
        }
        
        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (í•œê¸€ ìš°ì„ )
        function exportToPDF() {
            console.log('ğŸ“„ PDF ë‚´ë³´ë‚´ê¸° ì‹œì‘');
            
            // html2canvasì™€ jsPDF í™•ì¸
            if (typeof html2canvas === 'undefined') {
                console.error('âŒ html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ');
                showQuickNotification('âŒ html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ ë° ë¡œë”©
            if (!window.jsPDF) {
                console.log('â³ jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...');
                showQuickNotification('â³ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...', 'info');
                
                window.ensureJsPDFLoaded()
                    .then(() => {
                        console.log('âœ… PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì™„ë£Œ, í•œê¸€ PDF ìƒì„± ì‹œì‘');
                        generateKoreanPDF();
                    })
                    .catch(error => {
                        console.error('âŒ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨:', error);
                        showQuickNotification('âŒ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    });
            } else {
                // ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° - í•œê¸€ PDF ìš°ì„  ì‹œë„
                console.log('âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ë¨, í•œê¸€ PDF ìƒì„± ì‹œì‘');
                generateKoreanPDF()
                    .catch(error => {
                        console.error('âŒ í•œê¸€ PDF ì‹¤íŒ¨, ì˜ë¬¸ PDFë¡œ ëŒ€ì²´:', error);
                        showQuickNotification('âŒ í•œê¸€ PDF ì‹¤íŒ¨. ì˜ë¬¸ PDFë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.', 'warning');
                        generatePDF();
                    });
            }
        }
        
        // ë™ì  jsPDF ë¡œë”© í•¨ìˆ˜ (í†µí•©ëœ ì‹œìŠ¤í…œ ì‚¬ìš©)
        function loadJsPDFDynamically() {
            showQuickNotification('â³ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¬ë¡œë”© ì¤‘...', 'info');
            
            // ê¸°ì¡´ jsPDF ì°¸ì¡° ì œê±°
            window.jsPDF = undefined;
            window.jsPDFReady = false;
            
            // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
            const existingScripts = document.querySelectorAll('script[src*="jspdf"]');
            existingScripts.forEach(script => script.remove());
            
            // í†µí•©ëœ ë¡œë”© ì‹œìŠ¤í…œ ì‚¬ìš©
            window.ensureJsPDFLoaded()
                .then(() => {
                    console.log('âœ… ì¬ë¡œë”© ì™„ë£Œ, PDF ìƒì„± ì‹œì‘');
                    debugPDFStatus();
                    generatePDF();
                })
                .catch(error => {
                    console.error('âŒ ì¬ë¡œë”© ì‹¤íŒ¨:', error);
                    showQuickNotification('âŒ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¬ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                });
        }
        
        // í•œê¸€ ì§€ì› PDF ìƒì„± í•¨ìˆ˜ (HTML2Canvas ë°©ì‹)
        function generateKoreanPDF() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ğŸ“„ í•œê¸€ PDF ìƒì„± ì‹œì‘ (HTML2Canvas ë°©ì‹)');
                    showQuickNotification('ğŸ“„ í•œê¸€ PDF ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');
                    
                    // ì„ì‹œ PDF ì½˜í…ì¸  ìƒì„±
                    const pdfContent = createPDFContent();
                    document.body.appendChild(pdfContent);
                    
                    // html2canvasë¡œ ì´ë¯¸ì§€ ë³€í™˜ (í°íŠ¸ ì˜¤ë¥˜ ë°©ì§€)
                    html2canvas(pdfContent, {
                        scale: 2, // ê³ í•´ìƒë„
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        width: 794, // A4 width (210mm at 96dpi * 3.78)
                        height: 1123, // A4 height (297mm at 96dpi * 3.78)
                        allowTaint: true,
                        foreignObjectRendering: false,
                        ignoreElements: function(element) {
                            // í°íŠ¸ ë¡œë”© ë¬¸ì œê°€ ìˆëŠ” ìš”ì†Œ ë¬´ì‹œ
                            return element.tagName === 'LINK' && element.rel === 'stylesheet';
                        },
                        onclone: function(clonedDoc) {
                            // í´ë¡ ëœ ë¬¸ì„œì—ì„œ í°íŠ¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì •ë¦¬
                            const style = clonedDoc.createElement('style');
                            style.textContent = `
                                * {
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif !important;
                                }
                                @font-face {
                                    font-family: 'NotoSansKR';
                                    src: local('Malgun Gothic'), local('Apple SD Gothic Neo'), local('Noto Sans CJK KR');
                                }
                            `;
                            clonedDoc.head.appendChild(style);
                        }
                    }).then(canvas => {
                        try {
                            // jsPDFë¡œ PDF ìƒì„± (ë‹¤ì–‘í•œ ë°©ì‹ ì‹œë„)
                            let pdf;
                            if (window.jsPDF && window.jsPDF.jsPDF) {
                                pdf = new window.jsPDF.jsPDF('p', 'mm', 'a4');
                            } else if (window.jsPDF && typeof window.jsPDF === 'function') {
                                pdf = new window.jsPDF('p', 'mm', 'a4');
                            } else {
                                throw new Error('jsPDF ìƒì„±ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                            
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 210; // A4 width in mm
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            let heightLeft = imgHeight;
                            let position = 0;
                            
                            // ì²« ë²ˆì§¸ í˜ì´ì§€
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= 297; // A4 height
                            
                            // ì¶”ê°€ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
                            while (heightLeft >= 0) {
                                position = heightLeft - imgHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                                heightLeft -= 297;
                            }
                            
                            // ì„ì‹œ ì½˜í…ì¸  ì œê±°
                            document.body.removeChild(pdfContent);
                            
                            // PDF ì €ì¥
                            const fileName = `ë§ˆì´ë°ì´í„°_íˆ¬ìì œì•ˆì„œ_${new Date().toISOString().slice(0, 10)}.pdf`;
                            pdf.save(fileName);
                            
                            showQuickNotification('âœ… í•œê¸€ PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
                            console.log('âœ… í•œê¸€ PDF ìƒì„± ì™„ë£Œ:', fileName);
                            resolve();
                            
                        } catch (pdfError) {
                            document.body.removeChild(pdfContent);
                            throw pdfError;
                        }
                    }).catch(canvasError => {
                        document.body.removeChild(pdfContent);
                        throw canvasError;
                    });
                    
                } catch (error) {
                    console.error('âŒ í•œê¸€ PDF ìƒì„± ì˜¤ë¥˜:', error);
                    showQuickNotification('âŒ í•œê¸€ PDF ìƒì„± ì‹¤íŒ¨. ì˜ë¬¸ PDFë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.', 'error');
                    
                    // ì˜ë¬¸ PDFë¡œ ëŒ€ì²´
                    generatePDF().then(resolve).catch(reject);
                }
            });
        }
        
        // PDF ì½˜í…ì¸  HTML ìƒì„± í•¨ìˆ˜
        function createPDFContent() {
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: -9999px;
                left: -9999px;
                width: 794px;
                min-height: 1123px;
                background: white;
                padding: 40px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
                font-size: 14px;
                line-height: 1.6;
                color: #333;
                box-sizing: border-box;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            `;
            
            // í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ ìˆ˜ì§‘
            const portfolioText = document.getElementById('current-portfolio')?.value || '';
            const investmentAmount = document.getElementById('investment-amount')?.value || '';
            const targetReturn = document.getElementById('target-return')?.value || '';
            const riskLevel = document.getElementById('risk-level')?.value || '';
            const analysisResult = document.getElementById('analysis-result')?.innerText || '';
            const rebalancingResult = document.getElementById('rebalancing-result')?.innerText || '';
            const actionPlan = document.getElementById('action-plan')?.innerText || '';
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #03C75A; padding-bottom: 20px;">
                    <h1 style="color: #03C75A; margin: 0; font-size: 28px; font-weight: bold;">ë§ˆì´ë°ì´í„° íˆ¬ì ì œì•ˆì„œ</h1>
                    <h2 style="color: #666; margin: 10px 0 0 0; font-size: 18px;">ë„¤ì´ë²„í˜ì´ AI íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ</h2>
                    <p style="margin: 10px 0 0 0; color: #999;">ìƒì„± ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #03C75A; border-bottom: 2px solid #03C75A; padding-bottom: 5px; margin-bottom: 15px;">ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>ë³´ìœ  ì¢…ëª©:</strong> ${portfolioText || 'ë¯¸ì§€ì •'}</p>
                        <p><strong>ì´ íˆ¬ìê¸ˆì•¡:</strong> ${investmentAmount ? Number(investmentAmount).toLocaleString() + 'ì›' : 'ë¯¸ì§€ì •'}</p>
                        <p><strong>ëª©í‘œ ìˆ˜ìµë¥ :</strong> ${targetReturn || 'ë¯¸ì§€ì •'}%</p>
                        <p><strong>ìœ„í—˜ ì„±í–¥:</strong> ${riskLevel || 'ë¯¸ì§€ì •'}</p>
                    </div>
                </div>
                
                ${analysisResult ? `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 15px;">ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8;">
                        ${analysisResult}
                    </div>
                </div>
                ` : ''}
                
                ${rebalancingResult ? `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 5px; margin-bottom: 15px;">ğŸ¤– AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8;">
                        ${rebalancingResult}
                    </div>
                </div>
                ` : ''}
                
                ${actionPlan ? `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #6f42c1; border-bottom: 2px solid #6f42c1; padding-bottom: 5px; margin-bottom: 15px;">ğŸ“‹ ì‹¤í–‰ ê³„íš</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8;">
                        ${actionPlan}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 50px; border-top: 2px solid #dc3545; padding-top: 20px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">âš ï¸ íˆ¬ì ìœ„í—˜ ê³ ì§€</h3>
                    <div style="font-size: 12px; line-height: 1.8; color: #666;">
                        <p><strong>â€¢ ëª¨ë“  íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.</strong></p>
                        <p>â€¢ ì´ ì œì•ˆì€ ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ íˆ¬ì ê²°ì •ì€ ì‹ ì¤‘íˆ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                        <p>â€¢ ê¸ˆìœµíˆ¬ìì—…ë²•ì— ë”°ë¼ íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹Œ ì •ë³´ ì œê³µ ëª©ì ì…ë‹ˆë‹¤.</p>
                        <p>â€¢ ê³¼ê±° ìˆ˜ìµë¥ ì´ ë¯¸ë˜ ìˆ˜ìµë¥ ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        <p>â€¢ íˆ¬ì ì „ ë°˜ë“œì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <p><strong>ğŸ“‹ ìƒì„± ì •ë³´</strong></p>
                            <p>â€¢ ìƒì„± ì‹œìŠ¤í…œ: ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ</p>
                            <p>â€¢ AI ëª¨ë¸: Gemini AI & ë„¤ì´ë²„ ê¸ˆìœµ API</p>
                            <p>â€¢ ìƒì„± ë°©ì‹: HTML2Canvas + jsPDF (í•œê¸€ ì™„ì „ ì§€ì›)</p>
                        </div>
                    </div>
                </div>
            `;
            
            return container;
        }
        
        // ê¸°ì¡´ PDF ìƒì„± í•¨ìˆ˜ (ì˜ë¬¸ ë°±ì—…ìš©)
        function generatePDF() {
            try {
                console.log('ğŸ“„ PDF ìƒì„± í•¨ìˆ˜ ì‹œì‘');
                
                // jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                if (!window.jsPDF) {
                    throw new Error('jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // jsPDF ìƒì„±ì í™•ì¸ ë° ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ë‹¤ì–‘í•œ ë°©ì‹ ì‹œë„)
                let pdf;
                
                // 1. UMD í˜•ì‹ (jsPDF.jsPDF)
                if (window.jsPDF && window.jsPDF.jsPDF && typeof window.jsPDF.jsPDF === 'function') {
                    pdf = new window.jsPDF.jsPDF('p', 'mm', 'a4');
                    console.log('âœ… UMD í˜•ì‹ (jsPDF.jsPDF)ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
                }
                // 2. ì§ì ‘ ìƒì„±ì í˜•ì‹ (window.jsPDFê°€ í•¨ìˆ˜)
                else if (window.jsPDF && typeof window.jsPDF === 'function') {
                    pdf = new window.jsPDF('p', 'mm', 'a4');
                    console.log('âœ… ì§ì ‘ ìƒì„±ì (window.jsPDF)ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
                }
                // 3. ê¸°ë³¸ ìƒì„±ì í˜•ì‹ (ì¸ì ì—†ì´)
                else if (window.jsPDF && typeof window.jsPDF === 'function') {
                    pdf = new window.jsPDF();
                    pdf.internal.pageSize.width = 210; // A4 width in mm
                    pdf.internal.pageSize.height = 297; // A4 height in mm
                    console.log('âœ… ê¸°ë³¸ ìƒì„±ìë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
                }
                // 4. ì „ì—­ jsPDF í™•ì¸
                else if (typeof jsPDF !== 'undefined' && typeof jsPDF === 'function') {
                    pdf = new jsPDF('p', 'mm', 'a4');
                    console.log('âœ… ì „ì—­ jsPDFë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
                }
                // 5. êµ¬ë²„ì „ ë°©ì‹
                else if (window.jsPDF && window.jsPDF.API) {
                    pdf = new window.jsPDF.API('p', 'mm', 'a4');
                    console.log('âœ… êµ¬ë²„ì „ API ë°©ì‹ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
                }
                else {
                    throw new Error('jsPDF ìƒì„±ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš© ê°€ëŠ¥í•œ í˜•ì‹: ' + 
                        Object.keys(window.jsPDF || {}).join(', '));
                }
                
                console.log('âœ… jsPDF ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ');
                
                // í•œê¸€ ì§€ì›ì„ ìœ„í•´ ê¸°ë³¸ í°íŠ¸ë¥¼ helveticaë¡œ ì„¤ì •í•˜ê³ , 
                // í•œê¸€ í…ìŠ¤íŠ¸ëŠ” ì´ë¯¸ì§€ë‚˜ ê°„ë‹¨í•œ í˜•íƒœë¡œ ì²˜ë¦¬
                pdf.setFont('helvetica');
                
                // í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ì˜ë¬¸ ìš”ì•½ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
                function generateEnglishSummary(koreanText) {
                    if (!koreanText) return 'No analysis data available.';
                    
                    // í•œê¸€ í…ìŠ¤íŠ¸ì—ì„œ ìˆ«ìì™€ í¼ì„¼íŠ¸, ì›í™” ì •ë³´ ì¶”ì¶œ
                    const numbers = koreanText.match(/[\d,]+/g) || [];
                    const percentages = koreanText.match(/\d+\.?\d*%/g) || [];
                    const amounts = koreanText.match(/[\d,]+ì›/g) || [];
                    
                    // ì˜ë¬¸ ìš”ì•½ ìƒì„±
                    let summary = 'PORTFOLIO ANALYSIS SUMMARY:\n\n';
                    
                    if (numbers.length > 0) {
                        summary += `Key Financial Figures: ${numbers.slice(0, 5).join(', ')}\n`;
                    }
                    
                    if (percentages.length > 0) {
                        summary += `Percentage Data: ${percentages.slice(0, 3).join(', ')}\n`;
                    }
                    
                    if (amounts.length > 0) {
                        summary += `Amount Data: ${amounts.slice(0, 3).join(', ')}\n`;
                    }
                    
                    // ê¸°ë³¸ íˆ¬ì ì¡°ì–¸ ì¶”ê°€
                    summary += '\nRECOMMENDATIONS:\n';
                    summary += 'â€¢ Consider portfolio diversification\n';
                    summary += 'â€¢ Monitor market conditions regularly\n';
                    summary += 'â€¢ Maintain risk management strategy\n';
                    summary += 'â€¢ Review investment goals periodically\n';
                    
                    return summary;
                }
                
                // PDF í—¤ë” (ì™„ì „ ì˜ë¬¸)
                pdf.setFontSize(20);
                pdf.setTextColor(3, 199, 90); // ë„¤ì´ë²„í˜ì´ ê·¸ë¦°
                pdf.text('MyData Investment Proposal Report', 20, 25);
                pdf.text('Naver Pay AI Investment Analysis System', 20, 32);
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Generated: ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}`, 20, 45);
                
                // í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ ì¶”ì¶œ ë° ì˜ë¬¸ ë³€í™˜
                const analysisResultDiv = document.getElementById('analysis-result');
                let yPosition = 60;
                
                console.log('ğŸ“Š ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ ì‹œì‘');
                
                // í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ ì˜ë¬¸ ìš”ì•½ ìƒì„±
                const portfolioText = document.getElementById('current-portfolio')?.value || '';
                const investmentAmount = document.getElementById('investment-amount')?.value || '';
                const targetReturn = document.getElementById('target-return')?.value || '';
                const riskLevel = document.getElementById('risk-level')?.value || '';
                
                // 1. Portfolio Summary Section
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.text('=== PORTFOLIO ANALYSIS SUMMARY ===', 20, yPosition);
                yPosition += 12;
                
                pdf.setFontSize(10);
                pdf.text(`Portfolio Holdings: ${portfolioText || 'Not specified'}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Investment Amount: ${investmentAmount ? investmentAmount.toLocaleString() + ' KRW' : 'Not specified'}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Target Return: ${targetReturn || 'Not specified'}%`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Risk Level: ${riskLevel || 'Not specified'}`, 20, yPosition);
                yPosition += 15;
                
                // 2. AI Analysis Results Section
                if (analysisResultDiv && analysisResultDiv.style.display !== 'none') {
                    pdf.setFontSize(14);
                    pdf.setTextColor(23, 162, 184);
                    pdf.text('=== AI ANALYSIS RESULTS ===', 20, yPosition);
                    yPosition += 12;
                    
                    const analysisText = analysisResultDiv.innerText || '';
                    const englishSummary = generateEnglishSummary(analysisText);
                    const summaryLines = englishSummary.split('\n');
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    
                    for (let line of summaryLines) {
                        if (line.trim() && yPosition < 250) {
                            const splitText = pdf.splitTextToSize(line.trim(), 170);
                            for (let textLine of splitText) {
                                pdf.text(textLine, 20, yPosition);
                                yPosition += 6;
                                if (yPosition > 250) break;
                            }
                        }
                    }
                    yPosition += 10;
                }
                
                if (analysisResultDiv && analysisResultDiv.style.display !== 'none') {
                    pdf.setFontSize(16);
                    pdf.setTextColor(23, 162, 184);
                    pdf.text('Portfolio Analysis Results', 20, yPosition);
                    yPosition += 15;
                    
                    // ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° ë³€í™˜ (í•œê¸€ ì²˜ë¦¬ ê°œì„ )
                    const analysisText = extractTextFromHTML(analysisResultDiv.innerHTML);
                    console.log('ğŸ“Š ë¶„ì„ í…ìŠ¤íŠ¸ ê¸¸ì´:', analysisText.length);
                    
                    if (analysisText && analysisText.trim()) {
                        const lines = analysisText.split('\n').filter(line => line.trim() !== '');
                        
                        pdf.setFontSize(10);
                        pdf.setTextColor(0, 0, 0);
                        
                        lines.forEach((line, index) => {
                            try {
                                if (yPosition > 270) { // í˜ì´ì§€ ë ê·¼ì²˜ì—ì„œ ìƒˆ í˜ì´ì§€
                                    pdf.addPage();
                                    yPosition = 20;
                                }
                                
                                // í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ì˜ë¬¸/ìˆ«ìë§Œ í¬í•¨í•˜ë„ë¡ ë³€í™˜ (ì•ˆì „ì„±ì„ ìœ„í•´)
                                const safeLine = convertToSafeText(line.trim());
                                if (safeLine) {
                                    // ê¸´ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                                    const maxWidth = 170;
                                    const splitText = pdf.splitTextToSize(safeLine, maxWidth);
                                    
                                    splitText.forEach(textLine => {
                                        pdf.text(textLine, 20, yPosition);
                                        yPosition += 5;
                                    });
                                    yPosition += 2;
                                }
                            } catch (lineError) {
                                console.warn('âš ï¸ ë¼ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', lineError, 'ë¼ì¸:', line);
                            }
                        });
                    }
                }
                
                // AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ ì¶”ê°€
                const rebalancingResultDiv = document.getElementById('rebalancing-result');
                if (rebalancingResultDiv && rebalancingResultDiv.style.display !== 'none') {
                    yPosition += 10;
                    
                    if (yPosition > 250) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(3, 199, 90);
                    pdf.text('AI íˆ¬ì ì¡°ì–¸', 20, yPosition);
                    yPosition += 15;
                    
                    const rebalancingText = rebalancingResultDiv.textContent || rebalancingResultDiv.innerText || '';
                    const rebalancingLines = rebalancingText.split('\n').filter(line => line.trim() !== '');
                    
                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    
                    rebalancingLines.forEach(line => {
                        if (yPosition > 270) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        
                        const maxWidth = 170;
                        const splitText = pdf.splitTextToSize(line.trim(), maxWidth);
                        
                        splitText.forEach(textLine => {
                            pdf.text(textLine, 20, yPosition);
                            yPosition += 4;
                        });
                        yPosition += 1;
                    });
                }
                
                // ì‹¤í–‰ ê³„íš ì¶”ê°€
                const actionPlanDiv = document.getElementById('action-plan');
                if (actionPlanDiv && actionPlanDiv.innerHTML.trim() !== '') {
                    yPosition += 10;
                    
                    if (yPosition > 240) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(40, 167, 69);
                    pdf.text('ì‹¤í–‰ ê³„íš', 20, yPosition);
                    yPosition += 15;
                    
                    const actionText = actionPlanDiv.textContent || actionPlanDiv.innerText || '';
                    const actionLines = actionText.split('\n').filter(line => line.trim() !== '');
                    
                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    
                    actionLines.forEach(line => {
                        if (yPosition > 270) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        
                        const maxWidth = 170;
                        const splitText = pdf.splitTextToSize(line.trim(), maxWidth);
                        
                        splitText.forEach(textLine => {
                            pdf.text(textLine, 20, yPosition);
                            yPosition += 4;
                        });
                        yPosition += 1;
                    });
                }
                
                // ë©´ì±…ì¡°í•­ ì¶”ê°€ (ì˜ë¬¸)
                pdf.addPage();
                pdf.setFontSize(14);
                pdf.setTextColor(220, 53, 69);
                pdf.text('INVESTMENT RISK DISCLOSURE', 20, 25);
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                const disclaimerText = `
WARNING: Investment Risk Disclosure

â€¢ All investments carry the risk of principal loss.
â€¢ This proposal is for reference only; actual investment decisions should be made carefully.
â€¢ This is for informational purposes only, not investment solicitation per Financial Investment Services Act.
â€¢ Past performance does not guarantee future returns.
â€¢ Please consult with professionals before making investment decisions.

REPORT INFORMATION:
â€¢ Generated by: MyData Naver Pay AI Investment Analysis System
â€¢ Generated at: ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}
â€¢ AI Models: Gemini AI & Naver Finance API
â€¢ Report Language: English (Korean data converted)

TECHNICAL NOTES:
â€¢ Original Korean text converted to English summary for PDF compatibility
â€¢ All numerical data and percentages preserved from original analysis
â€¢ For full Korean content, please use the text file download option
                `;
                
                const disclaimerLines = disclaimerText.split('\n');
                let disclaimerY = 40;
                
                disclaimerLines.forEach(line => {
                    const splitText = pdf.splitTextToSize(line, 170);
                    splitText.forEach(textLine => {
                        pdf.text(textLine, 20, disclaimerY);
                        disclaimerY += 5;
                    });
                });
                
                // PDF ì €ì¥ (ì˜ë¬¸ íŒŒì¼ëª…)
                const fileName = `MyData_Investment_Proposal_${new Date().toISOString().slice(0, 10)}.pdf`;
                pdf.save(fileName);
                
                showQuickNotification('âœ… PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
                console.log('âœ… PDF ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', fileName);
                
            } catch (error) {
                console.error('âŒ PDF ìƒì„± ì˜¤ë¥˜:', error);
                showQuickNotification('âŒ PDF ìƒì„± ì‹¤íŒ¨. í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ëŒ€ì²´ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤.', 'error');
                
                // PDF ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆ ì œê³µ
                fallbackTextDownload();
            }
        }
        
        // PDF ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆ ë‹¤ìš´ë¡œë“œ
        function fallbackTextDownload() {
            try {
                console.log('ğŸ“„ í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
                
                // í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ ìˆ˜ì§‘
                const analysisResult = document.getElementById('analysis-result')?.innerText || '';
                const rebalancingResult = document.getElementById('rebalancing-result')?.innerText || '';
                const actionPlan = document.getElementById('action-plan')?.innerText || '';
                
                // í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ìš© ìƒì„±
                const textContent = `
ë§ˆì´ë°ì´í„° íˆ¬ì ì œì•ˆì„œ
ìƒì„± ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}
ìƒì„± ì‹œìŠ¤í…œ: ë„¤ì´ë²„í˜ì´ ë§ˆì´ë°ì´í„° íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ

==================================================
ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼
==================================================
${analysisResult}

==================================================
ğŸ¤– AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ
==================================================
${rebalancingResult}

==================================================
ğŸ“‹ ì‹¤í–‰ ê³„íš
==================================================
${actionPlan}

==================================================
âš ï¸ ë©´ì±…ì¡°í•­
==================================================
â€¢ ì´ íˆ¬ì ì œì•ˆì„œëŠ” AI ê¸°ë°˜ ë¶„ì„ ê²°ê³¼ë¡œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.
â€¢ ëª¨ë“  íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.
â€¢ íˆ¬ì ê²°ì •ì€ ê°œì¸ì˜ íŒë‹¨ê³¼ ì±…ì„í•˜ì— ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.
â€¢ ê¸ˆìœµíˆ¬ìì—…ë²•ì— ë”°ë¼ íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹Œ ì •ë³´ ì œê³µ ëª©ì ì…ë‹ˆë‹¤.
â€¢ ê³¼ê±° ìˆ˜ìµë¥ ì´ ë¯¸ë˜ ìˆ˜ìµë¥ ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
â€¢ íˆ¬ì ì „ ë°˜ë“œì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

ìƒì„± ì‹œìŠ¤í…œ: ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ
AI ëª¨ë¸: Gemini AI & ë„¤ì´ë²„ ê¸ˆìœµ API
`;

                // í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ë§ˆì´ë°ì´í„°_íˆ¬ìì œì•ˆì„œ_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showQuickNotification('âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! (PDF ëŒ€ì•ˆ)', 'success');
                console.log('âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
                
            } catch (fallbackError) {
                console.error('âŒ í…ìŠ¤íŠ¸ íŒŒì¼ ëŒ€ì•ˆë„ ì‹¤íŒ¨:', fallbackError);
                showQuickNotification('âŒ ëª¨ë“  ë‹¤ìš´ë¡œë“œ ë°©ì‹ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
            }
        }
        
        // ë¡œì»¬ ì €ì¥ í•¨ìˆ˜ (JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
        function saveToLocalStorage() {
            console.log('ğŸ’¾ íŒŒì¼ ì €ì¥ ì‹œì‘');
            
            try {
                showQuickNotification('ğŸ“ ë°ì´í„° íŒŒì¼ ìƒì„± ì¤‘...', 'info');
                
                const currentDate = new Date().toISOString();
                
                // ì €ì¥í•  ë°ì´í„° ìˆ˜ì§‘
                const portfolioData = {
                    timestamp: currentDate,
                    portfolio: document.getElementById('current-portfolio')?.value || '',
                    investmentAmount: document.getElementById('investment-amount')?.value || '',
                    targetReturn: document.getElementById('target-return')?.value || '',
                    riskLevel: document.getElementById('risk-level')?.value || '',
                    analysisResult: document.getElementById('analysis-result')?.innerHTML || '',
                    rebalancingResult: document.getElementById('rebalancing-result')?.innerHTML || '',
                    actionPlan: document.getElementById('action-plan')?.innerHTML || '',
                    marketData: document.getElementById('stock-grid')?.innerHTML || ''
                };
                
                // ë°”ë¡œ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                downloadAsJSONFile(portfolioData);
                
            } catch (error) {
                console.error('âŒ íŒŒì¼ ì €ì¥ ì˜¤ë¥˜:', error);
                showQuickNotification('âŒ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadAsJSONFile(portfolioData) {
            try {
                console.log('ğŸ“ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
                
                // ì‚¬ìš©ì ì¹œí™”ì ì¸ ë°ì´í„° êµ¬ì¡°ë¡œ ë³€í™˜
                const exportData = {
                    exportInfo: {
                        title: 'ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ íˆ¬ì ë¶„ì„ ê²°ê³¼',
                        exportDate: new Date().toLocaleString('ko-KR'),
                        version: '1.0'
                    },
                    userInput: {
                        í¬íŠ¸í´ë¦¬ì˜¤: portfolioData.portfolio,
                        íˆ¬ìê¸ˆì•¡: portfolioData.investmentAmount + 'ì›',
                        ëª©í‘œìˆ˜ìµë¥ : portfolioData.targetReturn + '%',
                        ìœ„í—˜ì„±í–¥: portfolioData.riskLevel
                    },
                    analysisResults: {
                        í¬íŠ¸í´ë¦¬ì˜¤ë¶„ì„: extractTextFromHTML(portfolioData.analysisResult),
                        AIë¦¬ë°¸ëŸ°ì‹±ì œì•ˆ: extractTextFromHTML(portfolioData.rebalancingResult),
                        ì‹¤í–‰ê³„íš: extractTextFromHTML(portfolioData.actionPlan),
                        ì‹œì¥ë°ì´í„°: extractTextFromHTML(portfolioData.marketData)
                    },
                    metadata: {
                        ì €ì¥ì‹œê°„: portfolioData.timestamp,
                        ë¸Œë¼ìš°ì €: navigator.userAgent,
                        ì‹œìŠ¤í…œ: 'ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ'
                    }
                };
                
                // JSON ë¬¸ìì—´ë¡œ ë³€í™˜ (ë³´ê¸° ì¢‹ê²Œ ë“¤ì—¬ì“°ê¸° ì ìš©)
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Blob ìƒì„±
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // íŒŒì¼ëª… ìƒì„± (ë‚ ì§œì™€ ì‹œê°„ í¬í•¨)
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // HH-MM-SS
                const fileName = `ë§ˆì´ë°ì´í„°_íˆ¬ìë¶„ì„_${dateStr}_${timeStr}.json`;
                
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URL ê°ì²´ ì •ë¦¬
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                showQuickNotification(`ğŸ“ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${fileName}`, 'success');
                console.log('âœ… JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', fileName);
                
            } catch (error) {
                console.error('âŒ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showQuickNotification('âŒ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // HTMLì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ í•¨ìˆ˜
        function extractTextFromHTML(htmlString) {
            if (!htmlString) return '';
            
            try {
                // ì„ì‹œ div ìš”ì†Œ ìƒì„±í•˜ì—¬ HTML íŒŒì‹±
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                
                // í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œí•˜ê³  ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ ì •ë¦¬
                const text = tempDiv.textContent || tempDiv.innerText || '';
                return text.replace(/\s+/g, ' ').trim();
                
            } catch (error) {
                console.error('âŒ HTML í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜:', error);
                return htmlString; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            }
        }
        
        // PDFìš© ì•ˆì „í•œ í…ìŠ¤íŠ¸ ë³€í™˜ í•¨ìˆ˜
        function convertToSafeText(text) {
            if (!text) return '';
            
            try {
                // í•œê¸€ì„ ë¡œë§ˆìë¡œ ë³€í™˜í•˜ëŠ” ê°„ë‹¨í•œ ë§¤í•‘
                const koreanMap = {
                    'í¬íŠ¸í´ë¦¬ì˜¤': 'Portfolio',
                    'ë¶„ì„': 'Analysis', 
                    'ê²°ê³¼': 'Result',
                    'íˆ¬ì': 'Investment',
                    'ìˆ˜ìµë¥ ': 'Return Rate',
                    'ìœ„í—˜ë„': 'Risk Level',
                    'ì‚¼ì„±ì „ì': 'Samsung Electronics',
                    'ë„¤ì´ë²„': 'Naver',
                    'ì¹´ì¹´ì˜¤': 'Kakao',
                    'ì›': 'KRW',
                    'ì£¼': 'shares',
                    'ë§¤ìˆ˜': 'Buy',
                    'ë§¤ë„': 'Sell',
                    'ë³´ìœ ': 'Hold',
                    'ë¦¬ë°¸ëŸ°ì‹±': 'Rebalancing',
                    'ì œì•ˆ': 'Recommendation',
                    'í˜„ì¬ê°€': 'Current Price',
                    'í‰ê°€ê¸ˆì•¡': 'Market Value',
                    'ìˆ˜ìµ': 'Profit',
                    'ì†ì‹¤': 'Loss',
                    'ì´': 'Total',
                    'í‰ê· ': 'Average',
                    'ë¹„ì¤‘': 'Weight',
                    'ê°œ': 'ea',
                    'ì•ˆì •í˜•': 'Conservative',
                    'ê· í˜•í˜•': 'Moderate', 
                    'ê³µê²©í˜•': 'Aggressive'
                };
                
                let result = text;
                
                // í•œê¸€ ë‹¨ì–´ë¥¼ ì˜ë¬¸ìœ¼ë¡œ ë³€í™˜
                Object.keys(koreanMap).forEach(korean => {
                    const regex = new RegExp(korean, 'g');
                    result = result.replace(regex, koreanMap[korean]);
                });
                
                // í•œê¸€ì´ ì—¬ì „íˆ ë‚¨ì•„ìˆìœ¼ë©´ ì œê±°í•˜ê±°ë‚˜ ëŒ€ì²´
                result = result.replace(/[ã„±-ã…|ã…-ã…£|ê°€-í£]/g, '');
                
                // ì—°ì†ëœ ê³µë°± ì •ë¦¬
                result = result.replace(/\s+/g, ' ').trim();
                
                // ë¹ˆ ë¬¸ìì—´ì´ë©´ ê¸°ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜
                if (!result || result.length < 2) {
                    return '(Korean text - see JSON file for full content)';
                }
                
                return result;
                
            } catch (error) {
                console.error('âŒ í…ìŠ¤íŠ¸ ë³€í™˜ ì˜¤ë¥˜:', error);
                return '(Text conversion error)';
            }
        }
        
        // ì €ì¥ëœ ë°ì´í„° ëª©ë¡ í‘œì‹œ í•¨ìˆ˜ (ì œê±°ë¨ - íŒŒì¼ ë‹¤ìš´ë¡œë“œë§Œ ì§€ì›)
        /* function showSavedDataList() {
            try {
                const savedPortfolios = JSON.parse(localStorage.getItem('mydata_portfolios') || '[]');
                
                if (savedPortfolios.length === 0) {
                    showQuickNotification('ğŸ’¾ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                    return;
                }
                
                let listHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; max-width: 500px; max-height: 70vh; overflow-y: auto;">
                        <h4 style="color: #03C75A; margin-bottom: 20px; display: flex; align-items: center;">
                            <span style="margin-right: 10px;">ğŸ’¾</span>
                            ì €ì¥ëœ ë¶„ì„ ë°ì´í„° (${savedPortfolios.length}ê°œ)
                        </h4>
                        <div style="margin-bottom: 20px;">
                `;
                
                savedPortfolios.forEach((data, index) => {
                    const date = new Date(data.timestamp).toLocaleString('ko-KR');
                    const portfolioPreview = data.portfolio.substring(0, 30) + (data.portfolio.length > 30 ? '...' : '');
                    
                    listHTML += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #03C75A;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1; cursor: pointer;" onclick="loadSavedData(${index})">
                                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">${date}</div>
                                    <div style="font-size: 12px; color: #6c757d;">í¬íŠ¸í´ë¦¬ì˜¤: ${portfolioPreview}</div>
                                    <div style="font-size: 12px; color: #6c757d;">íˆ¬ìê¸ˆì•¡: ${data.investmentAmount}ì›</div>
                                </div>
                                <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                    <button onclick="event.stopPropagation(); downloadSavedAsJSON(${index})" style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">
                                        ğŸ“ JSON
                                    </button>
                                    <button onclick="event.stopPropagation(); loadSavedData(${index})" style="background: #03C75A; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="ë°ì´í„° ë¡œë“œ">
                                        ğŸ“‚ ë¡œë“œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listHTML += `
                        </div>
                        <div style="text-align: center;">
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">ë‹«ê¸°</button>
                            <button onclick="clearSavedData()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">ì „ì²´ ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                
                // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
                const existingModal = document.querySelector('[data-modal="saved-data"]');
                if (existingModal) existingModal.remove();
                
                // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
                const modalDiv = document.createElement('div');
                modalDiv.setAttribute('data-modal', 'saved-data');
                modalDiv.innerHTML = listHTML;
                document.body.appendChild(modalDiv);
                
            } catch (error) {
                console.error('âŒ ì €ì¥ëœ ë°ì´í„° ëª©ë¡ í‘œì‹œ ì˜¤ë¥˜:', error);
                showQuickNotification('âŒ ë°ì´í„° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }*/
        
        // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ì œê±°ë¨ - íŒŒì¼ ë‹¤ìš´ë¡œë“œë§Œ ì§€ì›)
        /* function loadSavedData(index) {
            try {
                const savedPortfolios = JSON.parse(localStorage.getItem('mydata_portfolios') || '[]');
                const data = savedPortfolios[index];
                
                if (!data) {
                    showQuickNotification('âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                // í¼ ë°ì´í„° ë³µì›
                if (document.getElementById('current-portfolio')) {
                    document.getElementById('current-portfolio').value = data.portfolio;
                }
                if (document.getElementById('investment-amount')) {
                    document.getElementById('investment-amount').value = data.investmentAmount;
                }
                if (document.getElementById('target-return')) {
                    document.getElementById('target-return').value = data.targetReturn;
                }
                if (document.getElementById('risk-level')) {
                    document.getElementById('risk-level').value = data.riskLevel;
                }
                
                // ê²°ê³¼ ë°ì´í„° ë³µì›
                if (data.analysisResult && document.getElementById('analysis-result')) {
                    document.getElementById('analysis-result').innerHTML = data.analysisResult;
                    document.getElementById('analysis-result').style.display = 'block';
                }
                if (data.rebalancingResult && document.getElementById('rebalancing-result')) {
                    document.getElementById('rebalancing-result').innerHTML = markdownToHtml(data.rebalancingResult);
                    document.getElementById('rebalancing-result').style.display = 'block';
                }
                if (data.actionPlan && document.getElementById('action-plan')) {
                    document.getElementById('action-plan').innerHTML = data.actionPlan;
                }
                if (data.marketData && document.getElementById('stock-grid')) {
                    document.getElementById('stock-grid').innerHTML = data.marketData;
                    document.getElementById('stock-grid').style.display = 'grid';
                }
                
                // ëª¨ë‹¬ ë‹«ê¸°
                const modal = document.querySelector('[data-modal="saved-data"]');
                if (modal) modal.remove();
                
                showQuickNotification('âœ… ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!', 'success');
                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', new Date(data.timestamp).toLocaleString());
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showQuickNotification('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }*/
        
        // ì €ì¥ëœ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ (ì œê±°ë¨ - íŒŒì¼ ë‹¤ìš´ë¡œë“œë§Œ ì§€ì›)
        /* function downloadSavedAsJSON(index) {
            try {
                const savedPortfolios = JSON.parse(localStorage.getItem('mydata_portfolios') || '[]');
                const data = savedPortfolios[index];
                
                if (!data) {
                    showQuickNotification('âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                downloadAsJSONFile(data);
                
            } catch (error) {
                console.error('âŒ ì €ì¥ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showQuickNotification('âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }*/
        
        // ì €ì¥ëœ ë°ì´í„° ì „ì²´ ì‚­ì œ í•¨ìˆ˜ (ì œê±°ë¨ - íŒŒì¼ ë‹¤ìš´ë¡œë“œë§Œ ì§€ì›)
        /* function clearSavedData() {
            if (confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                try {
                    localStorage.removeItem('mydata_portfolios');
                    
                    // ê°œë³„ ì„¸ì…˜ ë°ì´í„°ë„ ì‚­ì œ
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('mydata_session_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // ëª¨ë‹¬ ë‹«ê¸°
                    const modal = document.querySelector('[data-modal="saved-data"]');
                    if (modal) modal.remove();
                    
                    showQuickNotification('ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    console.log('âœ… ì €ì¥ëœ ë°ì´í„° ì „ì²´ ì‚­ì œ ì™„ë£Œ');
                    
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
                    showQuickNotification('âŒ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
        }*/
        
        // ì±—ë´‡ ê´€ë ¨ ë³€ìˆ˜
        let chatHistory = [];
        let isChatbotMinimized = false;
        
        // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
        function getCurrentPortfolioContext() {
            const portfolioInput = document.getElementById('current-portfolio');
            const investmentInput = document.getElementById('investment-amount');
            const targetReturnInput = document.getElementById('target-return');
            const riskLevelInput = document.getElementById('risk-level');
            
            const portfolio = portfolioInput ? portfolioInput.value.trim() : '';
            const investment = investmentInput ? investmentInput.value : '';
            const targetReturn = targetReturnInput ? targetReturnInput.value : '';
            const riskLevel = riskLevelInput ? riskLevelInput.value : '';
            
            // í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì¢…ëª© ì¶”ì¶œ
            const holdings = extractStockHoldings(portfolio);
            
            return {
                portfolio: portfolio,
                holdings: holdings,
                totalInvestment: investment,
                targetReturn: targetReturn,
                riskLevel: riskLevel,
                hasPortfolio: portfolio.length > 0,
                stockCount: holdings.length
            };
        }
        
        // í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì¢…ëª© ì •ë³´ ì¶”ì¶œ
        function extractStockHoldings(portfolioText) {
            if (!portfolioText) return [];
            
            const holdings = [];
            // ê°œì„ ëœ ì •ê·œì‹: ì‰¼í‘œì™€ ê³µë°±ì„ ê³ ë ¤í•˜ì—¬ ì¢…ëª©ëª…ê³¼ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì¶”ì¶œ
            const regex = /([ê°€-í£a-zA-Z0-9\s]+?)\s*(\d+)(?:ì£¼|ê°œ)?(?:\s*,|\s*$)/g;
            let match;
            
            console.log('ğŸ” í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì‹±:', portfolioText);
            
            while ((match = regex.exec(portfolioText)) !== null) {
                const stockName = match[1].trim();
                const quantity = parseInt(match[2]);
                
                console.log('ğŸ“Š ì¶”ì¶œëœ ì¢…ëª©:', { stockName, quantity });
                
                if (stockName && quantity > 0) {
                    holdings.push({
                        name: stockName,
                        quantity: quantity
                    });
                }
            }
            
            console.log('âœ… ìµœì¢… ë³´ìœ  ì¢…ëª©:', holdings);
            return holdings;
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ ê°œì¸í™”ëœ ì±—ë´‡ ì‘ë‹µ ìƒì„±
        async function getPersonalizedChatbotResponse(userMessage, portfolioContext) {
            console.log('ğŸ¤– ê°œì¸í™”ëœ ì±—ë´‡ ì‘ë‹µ ìƒì„± ì¤‘...', { userMessage, portfolioContext });
            
            try {
                // Gemini AI API í˜¸ì¶œì„ ìœ„í•œ ìš”ì²­ ë°ì´í„° êµ¬ì„±
                const requestData = {
                    userMessage: userMessage,
                    portfolioContext: portfolioContext,
                    chatHistory: chatHistory.slice(-5), // ìµœê·¼ 5ê°œ ëŒ€í™”ë§Œ í¬í•¨
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch('/api/investment-advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'AIzaSyAJa7ixo3h3CytmCvvAMSWX2cH2g1XTXpg'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.advice) {
                    return data.advice;
                } else {
                    throw new Error(data.error || 'AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('âŒ ê°œì¸í™”ëœ ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ í´ë°± ì‘ë‹µ ìƒì„±
        function generatePortfolioBasedFallback(userMessage, portfolioContext) {
            console.log('ğŸ”„ í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ í´ë°± ì‘ë‹µ ìƒì„±...', { userMessage, portfolioContext });
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
            const message = userMessage.toLowerCase();
            
            // í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°
            if (portfolioContext.hasPortfolio && portfolioContext.holdings.length > 0) {
                // ì‹¤ì œ ë³´ìœ  ì¢…ëª©ì„ ë™ì ìœ¼ë¡œ ì¶”ì¶œ
                const stockNames = portfolioContext.holdings.map(h => h.name).join(', ');
                const stockDetails = portfolioContext.holdings.map(h => `â€¢ ${h.name}: ${h.quantity}ì£¼`).join('\n');
                
                console.log('ğŸ“Š ì‹¤ì œ ë³´ìœ  ì¢…ëª©:', stockNames);
                console.log('ğŸ“Š ì¢…ëª© ìƒì„¸:', stockDetails);
                
                if (message.includes('ë¶„ì„') || message.includes('ì–´ë–»ê²Œ') || message.includes('ì–´ë–¤')) {
                    return `í˜„ì¬ ë³´ìœ í•˜ì‹  í¬íŠ¸í´ë¦¬ì˜¤ì— ëŒ€í•œ ë¶„ì„ì„ ìš”ì²­í•˜ì…¨êµ°ìš”. í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ìˆì–´ ì‹¤ì‹œê°„ ë¶„ì„ì´ ì–´ë µìŠµë‹ˆë‹¤.

**í˜„ì¬ ë³´ìœ  ì¢…ëª©:**
${stockDetails}

**ê¸°ë³¸ ë¶„ì„ ì œì•ˆ:**
â€¢ ${stockNames}ëŠ” ëª¨ë‘ ìš°ëŸ‰ ê¸°ì—…ìœ¼ë¡œ ì•ˆì •ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ì…ë‹ˆë‹¤
â€¢ ë¶„ì‚°íˆ¬ìë¥¼ í†µí•´ ë¦¬ìŠ¤í¬ë¥¼ ê´€ë¦¬í•˜ê³  ê³„ì‹œë„¤ìš”
â€¢ ì •ê¸°ì ì¸ ë¦¬ë°¸ëŸ°ì‹±ì„ ê³ ë ¤í•´ë³´ì„¸ìš”

ë” ìì„¸í•œ ë¶„ì„ì´ í•„ìš”í•˜ì‹œë©´ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ˜Š`;
                }
                
                if (message.includes('ì¶”ì²œ') || message.includes('ì¶”ê°€') || message.includes('ìƒˆë¡œìš´')) {
                    return `í˜„ì¬ ë³´ìœ í•˜ì‹  ì¢…ëª©ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤!

**í˜„ì¬ ë³´ìœ  ì¢…ëª©:**
${stockDetails}

**ì¶”ê°€ íˆ¬ì ì¶”ì²œ:**
â€¢ **ETF**: KODEX 200, TIGER 200 ë“±ìœ¼ë¡œ ì‹œì¥ ì „ì²´ ë…¸ì¶œ
â€¢ **ì„¹í„°ë³„**: ë°˜ë„ì²´, ë°”ì´ì˜¤, ì‹ ì¬ìƒì—ë„ˆì§€ ë“± ì„±ì¥ ì„¹í„°
â€¢ **í•´ì™¸**: S&P 500, ë‚˜ìŠ¤ë‹¥ ETFë¡œ ê¸€ë¡œë²Œ ë¶„ì‚°
â€¢ **ë°°ë‹¹ì£¼**: SKí…”ë ˆì½¤, KT&G ë“± ì•ˆì •ì ì¸ ë°°ë‹¹ ìˆ˜ìµ

í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€í•˜ë©´ ë”ìš± ê· í˜•ì¡íŒ íˆ¬ìê°€ ê°€ëŠ¥í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤! ğŸ“ˆ`;
                }
                
                if (message.includes('ìœ„í—˜') || message.includes('ë¦¬ìŠ¤í¬') || message.includes('ì•ˆì „')) {
                    return `í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìœ„í—˜ ê´€ë¦¬ì— ëŒ€í•´ ë¬¸ì˜í•˜ì…¨ë„¤ìš”.

**í˜„ì¬ ë³´ìœ  ì¢…ëª©:**
${stockDetails}

**ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì œì•ˆ:**
â€¢ í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” ë¹„êµì  ì•ˆì •ì ì¸ ì¢…ëª©ë“¤ë¡œ êµ¬ì„±
â€¢ íˆ¬ìê¸ˆì•¡ì˜ 10-20%ëŠ” í˜„ê¸ˆìœ¼ë¡œ ë³´ìœ  ê¶Œì¥
â€¢ ì •ê¸°ì ì¸ ë¦¬ë°¸ëŸ°ì‹±ìœ¼ë¡œ ë³€ë™ì„± ê´€ë¦¬
â€¢ ì†ì‹¤ í•œë„ ì„¤ì • (ì˜ˆ: -10% ë„ë‹¬ ì‹œ ì¬ê²€í† )

íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ì˜ ìœ„í—˜ì´ ìˆìœ¼ë‹ˆ ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•˜ì„¸ìš”! âš ï¸`;
                }
            }
            
            // í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ì¼ë°˜ì ì¸ ì‘ë‹µ
            if (message.includes('ì‹œì‘') || message.includes('ì²˜ìŒ') || message.includes('ì–´ë–»ê²Œ')) {
                return `ì•ˆë…•í•˜ì„¸ìš”! íˆ¬ìì— ê´€ì‹¬ì„ ê°€ì ¸ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. 

**íˆ¬ì ì‹œì‘ ê°€ì´ë“œ:**
1. **ëª©í‘œ ì„¤ì •**: ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° ëª©í‘œ ìˆ˜ìµë¥  ì •í•˜ê¸°
2. **ë¦¬ìŠ¤í¬ í‰ê°€**: ë³¸ì¸ì˜ ìœ„í—˜ ì„±í–¥ íŒŒì•…
3. **ë¶„ì‚°íˆ¬ì**: ì—¬ëŸ¬ ì¢…ëª©ì— ë‚˜ëˆ„ì–´ íˆ¬ì
4. **ì •ê¸° íˆ¬ì**: ê¾¸ì¤€í•œ íˆ¬ì ìŠµê´€ ë§Œë“¤ê¸°

í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì…ë ¥í•˜ì‹œë©´ ë” êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ’¡`;
            }
            
            if (message.includes('ì¢…ëª©') || message.includes('ì£¼ì‹') || message.includes('ì¶”ì²œ')) {
                return `ì£¼ì‹ ì¢…ëª© ì¶”ì²œì„ ìš”ì²­í•˜ì…¨êµ°ìš”!

**ì¶”ì²œ ì¢…ëª© ì¹´í…Œê³ ë¦¬:**
â€¢ **ëŒ€í˜•ì£¼**: ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤, LGí™”í•™
â€¢ **ì„±ì¥ì£¼**: ë„¤ì´ë²„, ì¹´ì¹´ì˜¤, ì…€íŠ¸ë¦¬ì˜¨
â€¢ **ë°°ë‹¹ì£¼**: SKí…”ë ˆì½¤, KT&G, í•œêµ­ì „ë ¥
â€¢ **ETF**: KODEX 200, TIGER ë°˜ë„ì²´

ê°œì¸ì˜ íˆ¬ì ì„±í–¥ê³¼ ëª©í‘œì— ë”°ë¼ ì„ íƒí•˜ì‹œëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤! ğŸ“Š`;
            }
            
            // ê¸°ë³¸ ì‘ë‹µ
            return `ì•ˆë…•í•˜ì„¸ìš”! íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì— ëŒ€í•´ ë„ì›€ì„ ë“œë¦¬ê³  ì‹¶ì§€ë§Œ, í˜„ì¬ ì¼ì‹œì ìœ¼ë¡œ AI ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì…ë‹ˆë‹¤. ğŸ˜”

**ì¼ë°˜ì ì¸ íˆ¬ì ì¡°ì–¸:**
â€¢ ë¶„ì‚°íˆ¬ìë¥¼ í†µí•œ ë¦¬ìŠ¤í¬ ê´€ë¦¬
â€¢ ì •ê¸°ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ë°¸ëŸ°ì‹±
â€¢ ì¥ê¸° íˆ¬ì ê´€ì  ìœ ì§€
â€¢ íˆ¬ì ì „ ì¶©ë¶„í•œ ì¡°ì‚¬ì™€ ë¶„ì„

ë” êµ¬ì²´ì ì¸ ì¡°ì–¸ì´ í•„ìš”í•˜ì‹œë©´ í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ’ª`;
        }

        // ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ ê°œì¸í™”)
        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (!message) {
                showQuickNotification('ğŸ’¬ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addChatMessage(message, 'user');
            chatInput.value = '';
            
            // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            const loadingId = addLoadingMessage();
            
            try {
                // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
                const portfolioContext = getCurrentPortfolioContext();
                
                // í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ ê°œì¸í™”ëœ AI ì‘ë‹µ ìš”ì²­
                const response = await getPersonalizedChatbotResponse(message, portfolioContext);
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                removeLoadingMessage(loadingId);
                
                // AI ì‘ë‹µ ì¶”ê°€
                addChatMessage(response, 'ai');
                
                // ì±„íŒ… íˆìŠ¤í† ë¦¬ì— ì €ì¥ (í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ í¬í•¨)
                chatHistory.push({ 
                    user: message, 
                    ai: response, 
                    timestamp: new Date().toISOString(),
                    portfolio: portfolioContext
                });
                
                showQuickNotification('âœ… ë§ì¶¤í˜• íˆ¬ì ì¡°ì–¸ ì™„ë£Œ', 'success');
                
            } catch (error) {
                console.error('âŒ ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜:', error);
                removeLoadingMessage(loadingId);
                
                // í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜ í´ë°± ì‘ë‹µ ìƒì„±
                const portfolioContext = getCurrentPortfolioContext();
                const fallbackResponse = generatePortfolioBasedFallback(message, portfolioContext);
                addChatMessage(fallbackResponse, 'ai');
                showQuickNotification('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ê¸°ë³¸ ì¡°ì–¸ ì œê³µ', 'warning');
            }
        }
        
        // ë¹ ë¥¸ ì§ˆë¬¸ ì „ì†¡ í•¨ìˆ˜
        function sendQuickQuestion(question) {
            const chatInput = document.getElementById('chat-input');
            chatInput.value = question;
            sendChatMessage();
        }
        
        // ì±—ë´‡ ì‘ë‹µ ìƒì„± í•¨ìˆ˜
        async function getChatbotResponse(userMessage) {
            console.log('ğŸ¤– ì±—ë´‡ ì‘ë‹µ ìƒì„± ì¤‘:', userMessage);
            
            try {
                // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ ìˆ˜ì§‘
                const portfolioText = document.getElementById('current-portfolio')?.value || '';
                const investmentAmount = document.getElementById('investment-amount')?.value || '';
                const riskLevel = document.getElementById('risk-level')?.value || '';
                const targetReturn = document.getElementById('target-return')?.value || '';
                
                // Gemini AI API í˜¸ì¶œ
                const requestData = {
                    userMessage: userMessage,
                    chatHistory: chatHistory.slice(-5), // ìµœê·¼ 5ê°œ ëŒ€í™”ë§Œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©
                    userProfile: {
                        portfolio: portfolioText,
                        investmentAmount: investmentAmount,
                        riskLevel: riskLevel,
                        targetReturn: targetReturn
                    },
                    prompt: `ë‹¹ì‹ ì€ ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ì˜ ì „ë¬¸ AI íˆ¬ì ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ ìƒë‹´í•´ì£¼ì„¸ìš”:

**ì—­í• ê³¼ í†¤:**
- ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸ íˆ¬ì ìƒë‹´ì‚¬
- ë³µì¡í•œ ê¸ˆìœµ ìš©ì–´ë¥¼ ì‰½ê²Œ ì„¤ëª…
- ê°œì¸ ë§ì¶¤í˜• ì¡°ì–¸ ì œê³µ
- í•­ìƒ ìœ„í—˜ ê³ ì§€ì™€ ë©´ì±…ì¡°í•­ í¬í•¨

**ì‚¬ìš©ì í”„ë¡œí•„:**
- ğŸ“Š í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤: ${portfolioText || 'ì•„ì§ ë¯¸êµ¬ì„± (íˆ¬ì ê³„íš ë‹¨ê³„)'}
- ğŸ’° íˆ¬ì ê¸ˆì•¡: ${investmentAmount ? investmentAmount.toLocaleString() + 'ì›' : 'ë¯¸ì…ë ¥'}
- âš–ï¸ ìœ„í—˜ ì„±í–¥: ${riskLevel || 'ë³´í†µ (ì•ˆì •ì¶”êµ¬í˜•)'}
- ğŸ¯ ëª©í‘œ ìˆ˜ìµë¥ : ${targetReturn || '5'}%

**í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„:**
${portfolioText ? 
  `- ë³´ìœ  ì¢…ëª© ìˆ˜: ${portfolioText.split(',').length}ê°œ
  - ì¢…ëª©ë³„ ìƒì„¸: ${portfolioText}
  - ê°œì¸í™” ì¡°ì–¸: í˜„ì¬ ë³´ìœ  ì¢…ëª©ë“¤ì˜ ìœ„í—˜ë„ì™€ ìˆ˜ìµì„±ì„ ê³ ë ¤í•œ ë§ì¶¤í˜• ì œì•ˆ í•„ìš”` : 
  `- ìƒíƒœ: í¬íŠ¸í´ë¦¬ì˜¤ ë¯¸êµ¬ì„±
  - ì¡°ì–¸ ë°©í–¥: íˆ¬ì ê¸°ì´ˆ êµìœ¡ ë° ì´ˆë³´ììš© ì¢…ëª© ì¶”ì²œ`}

**ëŒ€í™” íˆìŠ¤í† ë¦¬:**
${chatHistory.slice(-3).map(chat => `ì‚¬ìš©ì: ${chat.user}\nAI: ${chat.ai}`).join('\n\n')}

**í˜„ì¬ ì§ˆë¬¸:** ${userMessage}

**ë‹µë³€ ê°€ì´ë“œë¼ì¸:**
1. ğŸ¯ **ê°œì¸í™” í•„ìˆ˜**: ì‚¬ìš©ìì˜ ì‹¤ì œ ë³´ìœ  ì¢…ëª©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ë©° ë§ì¶¤í˜• ë¶„ì„ ì œê³µ
2. ğŸ“Š **í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ë°˜**: í˜„ì¬ ë³´ìœ  ì¢…ëª©ë“¤ì˜ ì—…ì¢…, ìœ„í—˜ë„, ìƒê´€ê´€ê³„ë¥¼ ê³ ë ¤í•œ ì „ë¬¸ì  ì¡°ì–¸
3. ğŸ’¡ **ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ**: êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ íˆ¬ì ë°©í–¥ ì œì‹œ (ì¼ë°˜ì  ì¡°ì–¸)
4. âš–ï¸ **ìœ„í—˜ ê´€ë¦¬**: í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ë¶„ì‚°ë„ í‰ê°€ ë° ë¦¬ë°¸ëŸ°ì‹± í•„ìš”ì„± ì•ˆë‚´
5. ğŸ“ˆ **ì‹œì¥ ìƒí™© ë°˜ì˜**: í˜„ì¬ í•œêµ­ ê¸ˆìœµì‹œì¥ ìƒí™©ì„ ê³ ë ¤í•œ íƒ€ì´ë° ì¡°ì–¸
6. ğŸ¨ **ì¹œê·¼í•œ í†¤**: ì „ë¬¸ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…
7. ğŸ“ **ê°„ê²°ì„±**: 120ì ì´ë‚´ë¡œ í•µì‹¬ë§Œ ì „ë‹¬
8. âš ï¸ **í•„ìˆ˜ ê³ ì§€**: "íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ ìœ„í—˜ì´ ìˆìœ¼ë©°, ìµœì¢… íˆ¬ì ê²°ì •ì€ ë³¸ì¸ì˜ íŒë‹¨ê³¼ ì±…ì„ì…ë‹ˆë‹¤."

**ì‘ë‹µ íŒ¨í„´ ì˜ˆì‹œ:**
- í¬íŠ¸í´ë¦¬ì˜¤ ë³´ìœ ì‹œ: "${portfolioText.split(',')[0] || 'ë³´ìœ ì¢…ëª©'} ë“±ì„ ë³´ìœ  ì¤‘ì´ì‹œêµ°ìš”! í˜„ì¬ [ë¶„ì„ë‚´ìš©]ì„ ê³ ë ¤í•  ë•Œ [íˆ¬ìë°©í–¥ì„±]ì„ ê²€í† í•´ë³´ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤."
- í¬íŠ¸í´ë¦¬ì˜¤ ë¯¸ë³´ìœ ì‹œ: "íˆ¬ì ì´ˆë³´ìë¼ë©´ ë¶„ì‚°íˆ¬ì ì›ì¹™ìœ¼ë¡œ ì•ˆì •ì ì¸ ìš°ëŸ‰ì£¼ë‚˜ ETFë¶€í„° ì‹œì‘í•´ë³´ì‹œê¸¸ ê¶Œí•©ë‹ˆë‹¤."

**ê¸ˆì§€ì‚¬í•­:**
- êµ¬ì²´ì  ì¢…ëª© ë§¤ìˆ˜/ë§¤ë„ ê¶Œìœ  ê¸ˆì§€ (ì¼ë°˜ì  ë°©í–¥ì„±ë§Œ ì œì‹œ)
- í™•ì‹¤í•œ ìˆ˜ìµ ë³´ì¥ í‘œí˜„ ê¸ˆì§€
- ê³¼ë„í•œ ìœ„í—˜ íˆ¬ì ê¶Œì¥ ê¸ˆì§€
- ê°œì¸ì •ë³´ ìš”êµ¬ ê¸ˆì§€

í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.`
                };
                
                const response = await fetch('/api/investment-advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success && result.advice) {
                    return result.advice;
                } else {
                    throw new Error(result.error || 'AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('âŒ ì±—ë´‡ API ì˜¤ë¥˜:', error);
                
                // ë°±ì—… ì‘ë‹µ ìƒì„±
                return generateFallbackResponse(userMessage);
            }
        }
        
        // ë°±ì—… ì‘ë‹µ ìƒì„± í•¨ìˆ˜
        function generateFallbackResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('ì´ˆë³´') || lowerMessage.includes('ì‹œì‘')) {
                return `íˆ¬ì ì´ˆë³´ìë¥¼ ìœ„í•œ ê°€ì´ë“œë¥¼ ì•Œë ¤ë“œë¦´ê²Œìš”! ğŸ˜Š

**1ë‹¨ê³„: ê¸°ì´ˆ ì§€ì‹ ìŒ“ê¸°**
â€¢ ì£¼ì‹, ì±„ê¶Œ, ETF ë“± ê¸°ë³¸ ìƒí’ˆ ì´í•´
â€¢ ë¶„ì‚°íˆ¬ìì˜ ì¤‘ìš”ì„± í•™ìŠµ
â€¢ ì¥ê¸°íˆ¬ì vs ë‹¨ê¸°íˆ¬ì ê°œë…

**2ë‹¨ê³„: íˆ¬ì ëª©í‘œ ì„¤ì •**
â€¢ íˆ¬ì ê¸°ê°„ ê²°ì • (ë‹¨ê¸°/ì¤‘ì¥ê¸°/ì¥ê¸°)
â€¢ ëª©í‘œ ìˆ˜ìµë¥  ì„¤ì • (í˜„ì‹¤ì ì¸ ë²”ìœ„)
â€¢ ì†ì‹¤ í—ˆìš© ë²”ìœ„ ì •í•˜ê¸°

**3ë‹¨ê³„: ì‹¤ì „ ì‹œì‘**
â€¢ ì†Œì•¡ìœ¼ë¡œ ì‹œì‘í•´ë³´ê¸°
â€¢ ì›” ì •ì•¡ ì ë¦½ì‹ íˆ¬ì ê³ ë ¤
â€¢ ì‹œì¥ ìƒí™© ê¾¸ì¤€íˆ ëª¨ë‹ˆí„°ë§

âš ï¸ **ì¤‘ìš” ì•Œë¦¼:** íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ë³¸ì¸ì˜ íˆ¬ì ì„±í–¥ê³¼ ì¬ì • ìƒí™©ì„ ì¶©ë¶„íˆ ê³ ë ¤í•´ì£¼ì„¸ìš”.`;
            }
            
            if (lowerMessage.includes('ì•ˆì „') || lowerMessage.includes('ìœ„í—˜')) {
                return `ì•ˆì „í•œ íˆ¬ìì²˜ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”! ğŸ›¡ï¸

**ë‚®ì€ ìœ„í—˜ íˆ¬ìì²˜:**
â€¢ êµ­ê³ ì±„, íšŒì‚¬ì±„ (AAA ë“±ê¸‰)
â€¢ ì˜ˆê¸ˆ, ì ê¸ˆ (ì˜ˆê¸ˆìë³´í˜¸ë²• ì ìš©)
â€¢ ì›ê¸ˆë³´ì¥í˜• ìƒí’ˆ

**ì¤‘ê°„ ìœ„í—˜ íˆ¬ìì²˜:**
â€¢ ìš°ëŸ‰ ëŒ€í˜•ì£¼ (ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤ ë“±)
â€¢ ì½”ìŠ¤í”¼ 200 ETF
â€¢ ë°°ë‹¹ì£¼ ì¤‘ì‹¬ í¬íŠ¸í´ë¦¬ì˜¤

**ë¶„ì‚°íˆ¬ì ê¶Œì¥:**
â€¢ í•œ ê°€ì§€ ìƒí’ˆì—ë§Œ ì§‘ì¤‘ íˆ¬ì í”¼í•˜ê¸°
â€¢ ì—…ì¢…ë³„, ì§€ì—­ë³„ ë¶„ì‚°
â€¢ íˆ¬ì ì‹œê¸° ë¶„ì‚° (ì ë¦½ì‹)

ğŸ’¡ **íŒ:** ë‚˜ì´ë¥¼ í™œìš©í•œ ê³µì‹ '100 - ë‚˜ì´ = ì£¼ì‹ íˆ¬ì ë¹„ì¤‘(%)'ì„ ì°¸ê³ í•´ë³´ì„¸ìš”.

âš ï¸ ëª¨ë“  íˆ¬ìì—ëŠ” ìœ„í—˜ì´ ë”°ë¥´ë¯€ë¡œ ì‹ ì¤‘í•œ ê²°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
            }
            
            if (lowerMessage.includes('ETF') || lowerMessage.includes('ê°œë³„ì£¼ì‹')) {
                return `ETFì™€ ê°œë³„ì£¼ì‹ì˜ ì°¨ì´ì ì„ ì„¤ëª…í•´ë“œë¦´ê²Œìš”! ğŸ“Š

**ETF (ìƒì¥ì§€ìˆ˜í€ë“œ):**
âœ… ì¥ì :
â€¢ ìë™ ë¶„ì‚°íˆ¬ì íš¨ê³¼
â€¢ ë‚®ì€ ê´€ë¦¬ ë¹„ìš©
â€¢ íˆ¬ëª…í•œ êµ¬ì„± ì¢…ëª©
â€¢ ì´ˆë³´ìì—ê²Œ ì í•©

âŒ ë‹¨ì :
â€¢ ì‹œì¥ í‰ê·  ìˆ˜ìµë¥ 
â€¢ ê°œë³„ ì¢…ëª© ì„ íƒ ë¶ˆê°€

**ê°œë³„ì£¼ì‹:**
âœ… ì¥ì :
â€¢ ê³ ìˆ˜ìµ ê°€ëŠ¥ì„±
â€¢ ì¢…ëª© ì„ íƒì˜ ììœ 
â€¢ ë°°ë‹¹ê¸ˆ ì§ì ‘ ìˆ˜ë ¹

âŒ ë‹¨ì :
â€¢ ë†’ì€ ìœ„í—˜ì„±
â€¢ ì¢…ëª© ë¶„ì„ í•„ìš”
â€¢ ë¶„ì‚°íˆ¬ì ì–´ë ¤ì›€

**ì¶”ì²œ ì¡°í•©:**
â€¢ ì½”ì–´: ETFë¡œ ì•ˆì •ì  ê¸°ë°˜ (70%)
â€¢ ì‚¬ì´ë“œ: ê°œë³„ì£¼ì‹ìœ¼ë¡œ ìˆ˜ìµ ì¶”êµ¬ (30%)

ğŸ’¡ íˆ¬ì ê²½í—˜ê³¼ ì‹œê°„ ì—¬ìœ ì— ë”°ë¼ ë¹„ì¤‘ì„ ì¡°ì ˆí•´ë³´ì„¸ìš”!`;
            }
            
            if (lowerMessage.includes('ì ê¸ˆ') || lowerMessage.includes('vs') || lowerMessage.includes('ë¹„êµ')) {
                return `ì ê¸ˆê³¼ ì£¼ì‹ íˆ¬ìë¥¼ ë¹„êµí•´ë“œë¦´ê²Œìš”! ğŸ’°

**ì ê¸ˆì˜ íŠ¹ì§•:**
âœ… ì¥ì : ì›ê¸ˆ ë³´ì¥, í™•ì • ìˆ˜ìµë¥ , ì•ˆì „ì„±
âŒ ë‹¨ì : ë‚®ì€ ìˆ˜ìµë¥ , ì¸í”Œë ˆì´ì…˜ ë¦¬ìŠ¤í¬

**ì£¼ì‹ íˆ¬ìì˜ íŠ¹ì§•:**
âœ… ì¥ì : ë†’ì€ ìˆ˜ìµ ê°€ëŠ¥ì„±, ì¸í”Œë ˆì´ì…˜ ëŒ€ì‘
âŒ ë‹¨ì : ì›ê¸ˆ ì†ì‹¤ ìœ„í—˜, ë³€ë™ì„±

**ì¶”ì²œ ì „ëµ:**
1. **ì•ˆì „ ìê¸ˆ** (6ê°œì›”~1ë…„ ìƒí™œë¹„): ì ê¸ˆ, ì˜ˆê¸ˆ
2. **ì¥ê¸° ëª©í‘œ ìê¸ˆ**: ì£¼ì‹, ETF íˆ¬ì
3. **ë¹„ìœ¨ ì˜ˆì‹œ**: ì ê¸ˆ 40% + ì£¼ì‹ 60%

**ì›” 100ë§Œì› ê¸°ì¤€ ì˜ˆì‹œ:**
â€¢ ì ê¸ˆ 40ë§Œì› (ì•ˆì „ ìê¸ˆ)
â€¢ ì£¼ì‹ 60ë§Œì› (ì„±ì¥ ìê¸ˆ)

ğŸ’¡ **í•µì‹¬:** ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•˜ê¸°ë³´ë‹¤ëŠ” ì ì ˆí•œ ì¡°í•©ì´ ì¤‘ìš”í•´ìš”!

âš ï¸ ê°œì¸ì˜ ì¬ì • ìƒí™©ê³¼ íˆ¬ì ëª©í‘œì— ë”°ë¼ ë¹„ìœ¨ì„ ì¡°ì •í•˜ì„¸ìš”.`;
            }
            
            // ì‚¬ìš©ì ì§ˆë¬¸ì— ë§ëŠ” ë§ì¶¤í˜• ì‘ë‹µ ìƒì„±
            return generateSmartFallbackResponse(userMessage, {
                portfolio: portfolioText,
                investmentAmount: investmentAmount,
                riskLevel: riskLevel,
                targetReturn: targetReturn
            });
        }
        
        // ìŠ¤ë§ˆíŠ¸ ë°±ì—… ì‘ë‹µ ìƒì„± í•¨ìˆ˜
        function generateSmartFallbackResponse(userMessage, userProfile) {
            const lowerMessage = userMessage.toLowerCase();
            
            // ì‚¬ìš©ì ì§ˆë¬¸ ë¶„ì„
            const isAboutReturn = lowerMessage.includes('ìˆ˜ìµ') || lowerMessage.includes('ì´ìµ') || lowerMessage.includes('ë²Œ');
            const isAboutRisk = lowerMessage.includes('ìœ„í—˜') || lowerMessage.includes('ì†ì‹¤') || lowerMessage.includes('ì•ˆì „');
            const isAboutTiming = lowerMessage.includes('ì–¸ì œ') || lowerMessage.includes('ì‹œì ') || lowerMessage.includes('íƒ€ì´ë°');
            const isAboutAmount = lowerMessage.includes('ì–¼ë§ˆ') || lowerMessage.includes('ê¸ˆì•¡') || lowerMessage.includes('ëˆ');
            const isAboutSpecificStock = lowerMessage.includes('ì‚¼ì„±') || lowerMessage.includes('ì¹´ì¹´ì˜¤') || lowerMessage.includes('ë„¤ì´ë²„') || lowerMessage.includes('ì£¼ê°€');
            const isAboutStrategy = lowerMessage.includes('ì „ëµ') || lowerMessage.includes('ë°©ë²•') || lowerMessage.includes('ì–´ë–»ê²Œ');
            
            // ì‚¬ìš©ì í”„ë¡œí•„ ê¸°ë°˜ ë§ì¶¤ ì¡°ì–¸
            let personalizedAdvice = '';
            if (userProfile.portfolio) {
                const stocks = extractStockNamesFromPortfolio(userProfile.portfolio);
                if (stocks.length > 0) {
                    personalizedAdvice = `\nğŸ“Š **í˜„ì¬ ë³´ìœ  ì¢…ëª© (${stocks.join(', ')})ì— ëŒ€í•œ ì°¸ê³ ì‚¬í•­:**\n`;
                    
                    if (stocks.includes('ì¹´ì¹´ì˜¤') || stocks.includes('ë„¤ì´ë²„')) {
                        personalizedAdvice += 'â€¢ IT/í”Œë«í¼ ê¸°ì—…ì€ ì„±ì¥ì„±ì´ ë†’ì§€ë§Œ ë³€ë™ì„±ë„ í° í¸ì…ë‹ˆë‹¤\n';
                    }
                    if (stocks.includes('ì‚¼ì„±ì „ì')) {
                        personalizedAdvice += 'â€¢ ëŒ€í˜•ì£¼ëŠ” ìƒëŒ€ì ìœ¼ë¡œ ì•ˆì •ì ì´ë‚˜ ê³ ì„±ì¥ì€ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n';
                    }
                    personalizedAdvice += 'â€¢ ë¶„ì‚°íˆ¬ìë¥¼ í†µí•´ ë¦¬ìŠ¤í¬ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤\n';
                }
            }
            
            if (userProfile.riskLevel) {
                personalizedAdvice += `\nğŸ¯ **${userProfile.riskLevel} ì„±í–¥ì— ë§ëŠ” ì¡°ì–¸:**\n`;
                if (userProfile.riskLevel === 'ì•ˆì •í˜•') {
                    personalizedAdvice += 'â€¢ ì•ˆì •ì ì¸ ìˆ˜ìµì„ ì¶”êµ¬í•˜ì‹œë‹ˆ ì±„ê¶Œí˜• í€ë“œë‚˜ ë°°ë‹¹ì£¼ ì¤‘ì‹¬ íˆ¬ìë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”\n';
                } else if (userProfile.riskLevel === 'ê³µê²©í˜•') {
                    personalizedAdvice += 'â€¢ ì ê·¹ì  íˆ¬ìë¥¼ ì„ í˜¸í•˜ì‹œë‹ˆ ì„±ì¥ì£¼ë‚˜ í…Œë§ˆì£¼ë„ ê³ ë ¤í•  ìˆ˜ ìˆì§€ë§Œ ë¦¬ìŠ¤í¬ ê´€ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤\n';
                }
            }
            
            // ì§ˆë¬¸ ìœ í˜•ë³„ ë§ì¶¤ ì‘ë‹µ
            if (isAboutReturn) {
                return `ğŸ’° **ìˆ˜ìµì— ëŒ€í•œ ì§ˆë¬¸ì´ì‹œêµ°ìš”!**
        
        íˆ¬ì ìˆ˜ìµì€ ë‹¤ì–‘í•œ ìš”ì¸ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤:
        
        **ğŸ“ˆ ìˆ˜ìµë¥  ê¸°ëŒ€ì¹˜:**
        â€¢ ì•ˆì „ ìì‚° (ì˜ˆê¸ˆ/ì±„ê¶Œ): ì—° 3-5%
        â€¢ êµ­ë‚´ ì£¼ì‹ (ì¥ê¸°): ì—° 6-10%
        â€¢ í•´ì™¸ ì£¼ì‹ (ì¥ê¸°): ì—° 8-12%
        
        **âš ï¸ ì¤‘ìš”í•œ ì :**
        â€¢ ê³¼ê±° ìˆ˜ìµë¥  â‰  ë¯¸ë˜ ìˆ˜ìµë¥ 
        â€¢ ë†’ì€ ìˆ˜ìµ = ë†’ì€ ìœ„í—˜
        â€¢ ê¾¸ì¤€í•œ íˆ¬ìê°€ ë³µë¦¬ íš¨ê³¼ ì°½ì¶œ
        ${personalizedAdvice}
        
        ğŸ’¡ **ì‹¤ìš©ì  ì¡°ì–¸:** ëª©í‘œ ìˆ˜ìµë¥ ì„ ë„ˆë¬´ ë†’ê²Œ ì¡ì§€ ë§ˆì‹œê³ , ê¾¸ì¤€íˆ íˆ¬ìí•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•©ë‹ˆë‹¤!
        
        âš ï¸ ëª¨ë“  íˆ¬ìì—ëŠ” ì›ê¸ˆ ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`;
            }
            
            if (isAboutRisk) {
                return `ğŸ›¡ï¸ **íˆ¬ì ìœ„í—˜ ê´€ë¦¬ì— ëŒ€í•´ ì•Œë ¤ë“œë¦´ê²Œìš”!**
        
        **ìœ„í—˜ì˜ ì¢…ë¥˜:**
        â€¢ ì‹œì¥ ìœ„í—˜: ì „ì²´ ì‹œì¥ í•˜ë½
        â€¢ ê°œë³„ ìœ„í—˜: íŠ¹ì • ê¸°ì—…/ì‚°ì—… ë¬¸ì œ
        â€¢ í™˜ìœ¨ ìœ„í—˜: í•´ì™¸ íˆ¬ì ì‹œ
        â€¢ ì¸í”Œë ˆì´ì…˜ ìœ„í—˜: ë¬¼ê°€ ìƒìŠ¹
        
        **ìœ„í—˜ ê´€ë¦¬ ë°©ë²•:**
        â€¢ ë¶„ì‚°íˆ¬ì (ì—…ì¢…ë³„, ì§€ì—­ë³„, ì‹œê¸°ë³„)
        â€¢ ì†ì ˆë§¤ ê¸°ì¤€ ì„¤ì •
        â€¢ íˆ¬ì ë¹„ì¤‘ ì¡°ì ˆ (ìƒí™œë¹„ëŠ” ì ˆëŒ€ íˆ¬ì ê¸ˆì§€)
        â€¢ ì •ê¸°ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ ì¬ê²€í† 
        ${personalizedAdvice}
        
        ğŸ’¡ **í•µì‹¬:** ìœ„í—˜ì„ ì™„ì „íˆ ì—†ì•¨ ìˆ˜ëŠ” ì—†ì§€ë§Œ, ë¶„ì‚°íˆ¬ìë¡œ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
        
        âš ï¸ íˆ¬ì ì „ ë³¸ì¸ì˜ ìœ„í—˜ í—ˆìš© ìˆ˜ì¤€ì„ ì •í™•íˆ íŒŒì•…í•˜ì„¸ìš”.`;
            }
            
            if (isAboutTiming) {
                return `â° **íˆ¬ì íƒ€ì´ë°ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”!**
        
        **íƒ€ì´ë°ì˜ ì§„ì‹¤:**
        â€¢ ì™„ë²½í•œ íƒ€ì´ë°ì€ ì—†ìŠµë‹ˆë‹¤
        â€¢ ì‹œì¥ ì˜ˆì¸¡ì€ ì „ë¬¸ê°€ë„ ì–´ë ¤ì›Œí•©ë‹ˆë‹¤
        â€¢ "ì‹œê°„ì„ ë§ì¶”ê¸°"ë³´ë‹¤ "ì‹œê°„ì„ í™œìš©í•˜ê¸°"
        
        **ì¶”ì²œ ì „ëµ:**
        â€¢ ë‹¬ëŸ¬ ì½”ìŠ¤íŠ¸ ì• ë²„ë¦¬ì§• (ì •ì•¡ ì ë¦½ì‹)
        â€¢ ë¶„í•  ë§¤ìˆ˜/ë§¤ë„
        â€¢ ì¥ê¸° íˆ¬ì ê´€ì  ìœ ì§€
        
        **ì¢‹ì€ íˆ¬ì ì‹œì :**
        â€¢ ì‹œì¥ì´ ê³¼ë„í•˜ê²Œ í•˜ë½í–ˆì„ ë•Œ
        â€¢ ë³¸ì¸ì˜ íˆ¬ì ê³„íšì— ë”°ë¥¸ ì •ê¸° íˆ¬ìì¼
        â€¢ ì—¬ìœ  ìê¸ˆì´ í™•ë³´ë˜ì—ˆì„ ë•Œ
        ${personalizedAdvice}
        
        ğŸ’¡ **ê²°ë¡ :** ì–¸ì œ ì‹œì‘í•˜ëŠëƒë³´ë‹¤ ê¾¸ì¤€íˆ í•˜ëŠëƒê°€ ë” ì¤‘ìš”í•©ë‹ˆë‹¤!
        
        âš ï¸ ë‹¨ê¸° ì‹œì¥ ì˜ˆì¸¡ì— ì˜ì¡´í•œ íˆ¬ìëŠ” ìœ„í—˜í•©ë‹ˆë‹¤.`;
            }
            
            if (isAboutAmount) {
                return `ğŸ’µ **íˆ¬ì ê¸ˆì•¡ ì„¤ì •ì— ëŒ€í•´ ì•ˆë‚´ë“œë¦´ê²Œìš”!**
        
        **íˆ¬ì ê¸ˆì•¡ ê²°ì • ì›ì¹™:**
        â€¢ ìƒí™œë¹„ 6ê°œì›”ë¶„ì€ ë¹„ìƒê¸ˆìœ¼ë¡œ ë³´ê´€
        â€¢ ë‹¨ê¸° ì‚¬ìš© ì˜ˆì • ìê¸ˆì€ íˆ¬ì ê¸ˆì§€
        â€¢ ìƒì–´ë„ ìƒí™œì— ì§€ì¥ ì—†ëŠ” ê¸ˆì•¡ë§Œ íˆ¬ì
        
        **íˆ¬ì ë¹„ì¤‘ ê°€ì´ë“œ:**
        â€¢ ì´ˆë³´ì: ì´ ìì‚°ì˜ 10-30%
        â€¢ ê²½í—˜ì: ì´ ìì‚°ì˜ 30-70%
        â€¢ ë‚˜ì´ë³„: (100 - ë‚˜ì´)% ë¥¼ ì£¼ì‹ì— íˆ¬ì
        
        **ë‹¨ê³„ë³„ ì ‘ê·¼:**
        1. ì†Œì•¡ìœ¼ë¡œ ì‹œì‘ (ì›” 10-50ë§Œì›)
        2. íˆ¬ì ê²½í—˜ ìŒ“ê¸°
        3. ì ì§„ì ìœ¼ë¡œ íˆ¬ì ë¹„ì¤‘ í™•ëŒ€
        ${personalizedAdvice}
        
        ğŸ’¡ **íŒ:** ì²˜ìŒì—ëŠ” ì ê²Œ ì‹œì‘í•´ì„œ ê²½í—˜ì„ ìŒ“ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤!
        
        âš ï¸ ë¹šì„ ë‚´ì„œ íˆ¬ìí•˜ê±°ë‚˜ ìƒí™œë¹„ë¥¼ íˆ¬ìí•˜ëŠ” ê²ƒì€ ì ˆëŒ€ ê¸ˆë¬¼ì…ë‹ˆë‹¤.`;
            }
            
            if (isAboutSpecificStock) {
                return `ğŸ“Š **ê°œë³„ ì¢…ëª©ì— ëŒ€í•´ ë§ì”€ë“œë¦´ê²Œìš”!**
        
        **ì¢…ëª© ë¶„ì„ ì‹œ ê³ ë ¤ì‚¬í•­:**
        â€¢ ê¸°ì—…ì˜ ì¬ë¬´ ìƒíƒœ (ë§¤ì¶œ, ì´ìµ, ë¶€ì±„)
        â€¢ ì—…ì¢… ì „ë§ê³¼ ê²½ìŸë ¥
        â€¢ ê²½ì˜ì§„ì˜ ëŠ¥ë ¥ê³¼ ë¹„ì „
        â€¢ ë°¸ë¥˜ì—ì´ì…˜ (PER, PBR ë“±)
        
        **í•œêµ­ ëŒ€í‘œ ê¸°ì—…ë“¤:**
        â€¢ ì‚¼ì„±ì „ì: ë°˜ë„ì²´, ìŠ¤ë§ˆíŠ¸í° ê¸€ë¡œë²Œ 1ìœ„
        â€¢ ë„¤ì´ë²„: êµ­ë‚´ IT í”Œë«í¼ ëŒ€í‘œ ê¸°ì—…
        â€¢ ì¹´ì¹´ì˜¤: ëª¨ë°”ì¼ ìƒíƒœê³„ êµ¬ì¶•
        
        **ì£¼ì˜ì‚¬í•­:**
        â€¢ í•œ ì¢…ëª©ì— ê³¼ë„í•œ ì§‘ì¤‘ íˆ¬ì í”¼í•˜ê¸°
        â€¢ ë‰´ìŠ¤ë‚˜ ì†Œë¬¸ë³´ë‹¤ëŠ” ê¸°ì—… ì‹¤ì  ì¤‘ì‹¬ìœ¼ë¡œ íŒë‹¨
        â€¢ ì •ê¸°ì ì¸ ì‹¤ì  ë°œí‘œ ëª¨ë‹ˆí„°ë§
        ${personalizedAdvice}
        
        ğŸ’¡ **ì¡°ì–¸:** ê°œë³„ ì¢…ëª©ë³´ë‹¤ëŠ” ETFë¡œ ì‹œì‘í•´ì„œ ê²½í—˜ì„ ìŒ“ì•„ë³´ì„¸ìš”!
        
        âš ï¸ íŠ¹ì • ì¢…ëª© ì¶”ì²œì€ ë¶ˆê°€ëŠ¥í•˜ë©°, íˆ¬ì ê²°ì •ì€ ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.`;
            }
            
            if (isAboutStrategy) {
                return `ğŸ¯ **íˆ¬ì ì „ëµì— ëŒ€í•´ ì•Œë ¤ë“œë¦´ê²Œìš”!**
        
        **ì´ˆë³´ì ì¶”ì²œ ì „ëµ:**
        â€¢ ì¸ë±ìŠ¤ í€ë“œ/ETF ì¤‘ì‹¬ íˆ¬ì
        â€¢ ë‹¬ëŸ¬ ì½”ìŠ¤íŠ¸ ì• ë²„ë¦¬ì§•
        â€¢ ë¶„ì‚°íˆ¬ì (êµ­ë‚´ì™¸, ì—…ì¢…ë³„)
        
        **ì¤‘ê¸‰ì ì „ëµ:**
        â€¢ ì½”ì–´-ì‚¬í…”ë¼ì´íŠ¸ ì „ëµ
        â€¢ ë¦¬ë°¸ëŸ°ì‹± (ë¶„ê¸°ë³„/ë°˜ê¸°ë³„)
        â€¢ ê°€ì¹˜íˆ¬ì vs ì„±ì¥íˆ¬ì ì¡°í•©
        
        **ê³ ê¸‰ì ì „ëµ:**
        â€¢ ì„¹í„° ë¡œí…Œì´ì…˜
        â€¢ ê¸€ë¡œë²Œ ìì‚° ë°°ë¶„
        â€¢ ëŒ€ì•ˆíˆ¬ì í¬í•¨ (REITs, ì›ìì¬ ë“±)
        
        **ê³µí†µ ì›ì¹™:**
        â€¢ ì¥ê¸° íˆ¬ì ê´€ì  ìœ ì§€
        â€¢ ê°ì •ì  íˆ¬ì ë°°ì œ
        â€¢ ê¾¸ì¤€í•œ í•™ìŠµê³¼ ëª¨ë‹ˆí„°ë§
        ${personalizedAdvice}
        
        ğŸ’¡ **í•µì‹¬:** ë³µì¡í•œ ì „ëµë³´ë‹¤ëŠ” ë‹¨ìˆœí•˜ê³  ê¾¸ì¤€í•œ ì „ëµì´ ë” íš¨ê³¼ì ì…ë‹ˆë‹¤!
        
        âš ï¸ ì „ëµì€ ê°œì¸ì˜ ìƒí™©ì— ë§ê²Œ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤.`;
            }
            
            // ê¸°ë³¸ ì‘ë‹µ (ì§ˆë¬¸ ìœ í˜•ì„ íŒŒì•…í•˜ì§€ ëª»í•œ ê²½ìš°)
            return `ğŸ’¬ **íˆ¬ì ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!**
        
        ì§ˆë¬¸í•´ì£¼ì‹  ë‚´ìš©ì— ëŒ€í•´ ë„ì›€ì„ ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤. ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì´ ê¶ê¸ˆí•˜ì‹ ì§€ ì•Œë ¤ì£¼ì‹œë©´ ë” ì •í™•í•œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”!
        
        **ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ë“¤:**
        â€¢ ğŸ“ˆ "íˆ¬ì ìˆ˜ìµë¥ ì€ ì–´ëŠ ì •ë„ ê¸°ëŒ€í•  ìˆ˜ ìˆë‚˜ìš”?"
        â€¢ ğŸ›¡ï¸ "ì•ˆì „í•œ íˆ¬ì ë°©ë²•ì´ ìˆì„ê¹Œìš”?"
        â€¢ â° "ì–¸ì œ íˆ¬ìë¥¼ ì‹œì‘í•˜ëŠ” ê²Œ ì¢‹ì„ê¹Œìš”?"
        â€¢ ğŸ’µ "ì–¼ë§ˆ ì •ë„ íˆ¬ìí•˜ëŠ” ê²Œ ì ë‹¹í•œê°€ìš”?"
        â€¢ ğŸ“Š "ì–´ë–¤ ì¢…ëª©ì„ ì„ íƒí•´ì•¼ í• ê¹Œìš”?"
        â€¢ ğŸ¯ "íˆ¬ì ì „ëµì€ ì–´ë–»ê²Œ ì„¸ì›Œì•¼ í•˜ë‚˜ìš”?"
        
        **í˜„ì¬ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥:**
        â€¢ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ë„êµ¬
        â€¢ AI ë¦¬ë°¸ëŸ°ì‹± ì œì•ˆ
        â€¢ ì‹¤í–‰ ê³„íš ìƒì„±
        â€¢ PDF/JSON ë‹¤ìš´ë¡œë“œ
        ${personalizedAdvice}
        
        ğŸ’¡ **íŒ:** ìœ„ì˜ ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ë“¤ì„ í™œìš©í•´ë³´ì„¸ìš”!
        
        âš ï¸ ëª¨ë“  íˆ¬ì ì¡°ì–¸ì€ ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ê²°ì •ì€ ë³¸ì¸ì˜ íŒë‹¨ê³¼ ì±…ì„ì…ë‹ˆë‹¤.`;
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.style.marginBottom = '15px';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px; justify-content: flex-end;">
                        <div style="background: #03C75A; color: white; padding: 12px 15px; border-radius: 15px 15px 5px 15px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                            ${message}
                        </div>
                        <div style="width: 35px; height: 35px; background: #6c757d; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                            ğŸ‘¤
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                            ğŸ¤–
                        </div>
                        <div style="background: #f8f9fa; padding: 14px 16px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.6; font-size: 14px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            ${markdownToHtml(message)}
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
            const chatBody = document.getElementById('chatbot-body');
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addLoadingMessage() {
            const chatMessages = document.getElementById('chat-messages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message ai-message';
            loadingDiv.style.marginBottom = '15px';
            
            loadingDiv.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                        ğŸ¤–
                    </div>
                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 8px; height: 8px; background: #03C75A; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                            <div style="width: 8px; height: 8px; background: #03C75A; border-radius: 50%; animation: pulse 1.5s infinite 0.2s;"></div>
                            <div style="width: 8px; height: 8px; background: #03C75A; border-radius: 50%; animation: pulse 1.5s infinite 0.4s;"></div>
                            <span style="margin-left: 5px; color: #6c757d;">AIê°€ ìƒê°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(loadingDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
            const chatBody = document.getElementById('chatbot-body');
            chatBody.scrollTop = chatBody.scrollHeight;
            
            return loadingId;
        }
        
        // ë¡œë”© ë©”ì‹œì§€ ì œê±° í•¨ìˆ˜
        function removeLoadingMessage(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™” í•¨ìˆ˜
        function clearChatHistory() {
            if (confirm('ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                chatHistory = [];
                
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = `
                    <div class="message ai-message" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <div style="width: 35px; height: 35px; background: #03C75A; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0;">
                                ğŸ¤–
                            </div>
                            <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 15px 15px 15px 5px; max-width: 80%; line-height: 1.5; font-size: 14px;">
                                ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë§ˆì´ë°ì´í„° ë„¤ì´ë²„í˜ì´ AI íˆ¬ì ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸ¯<br><br>
                                íˆ¬ì ëª©í‘œ, ìœ„í—˜ ì„±í–¥, í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± ë“± ì–´ë–¤ ê²ƒì´ë“  í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!<br><br>
                                <strong>ì˜ˆì‹œ ì§ˆë¬¸:</strong><br>
                                ğŸ’¡ "ì•ˆì „í•œ íˆ¬ì ë°©ë²•ì´ ë­ê°€ ìˆì„ê¹Œìš”?"<br>
                                ğŸ’¡ "ì›” 100ë§Œì› ì ê¸ˆ vs ì£¼ì‹ íˆ¬ì ì–´ë–¤ê²Œ ì¢‹ì„ê¹Œìš”?"<br>
                                ğŸ’¡ "ì‚¼ì„±ì „ì ì£¼ê°€ ì „ë§ì€ ì–´ë–¤ê°€ìš”?"
                            </div>
                        </div>
                    </div>
                `;
                
                showQuickNotification('ğŸ—‘ï¸ ëŒ€í™” ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }
        
        // ì±—ë´‡ ìµœì†Œí™”/ìµœëŒ€í™” í•¨ìˆ˜
        function toggleChatbot() {
            const chatBody = document.getElementById('chatbot-body');
            const toggleButton = document.getElementById('chatbot-toggle');
            
            if (isChatbotMinimized) {
                chatBody.style.display = 'block';
                toggleButton.textContent = 'â– ìµœì†Œí™”';
                isChatbotMinimized = false;
            } else {
                chatBody.style.display = 'none';
                toggleButton.textContent = 'â• í¼ì¹˜ê¸°';
                isChatbotMinimized = true;
            }
        }
        
        // ì—”í„° í‚¤ ì²˜ë¦¬ í•¨ìˆ˜
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ê¸°ë³¸ê°’ ì œê±°)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… í˜ì´ì§€ ë¡œë”© ì™„ë£Œ - ê¸°ë³¸ê°’ ì—†ì´ ì‹œì‘');
            
            // ë©´ì±…ì¡°í•­ ë‚ ì§œ ì—…ë°ì´íŠ¸
            const disclaimerDate = document.getElementById('disclaimer-date');
            if (disclaimerDate) {
                disclaimerDate.textContent = new Date().toLocaleDateString('ko-KR');
                console.log('ğŸ“… ë©´ì±…ì¡°í•­ ë‚ ì§œ ì—…ë°ì´íŠ¸:', disclaimerDate.textContent);
            }
            
            // ì±—ë´‡ íˆìŠ¤í† ë¦¬ëŠ” ì„¸ì…˜ ë©”ëª¨ë¦¬ë§Œ ì‚¬ìš© (ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”)
            
            // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸ ì œê±°ë¨ (ê³ ê°ìš© ì¸í„°í˜ì´ìŠ¤ì— ë¶ˆí•„ìš”)
            
            // ê°œë°œì ë„êµ¬ ê¸°ëŠ¥ ì œê±°ë¨ (ì‚¬ìš©ì ì¹œí™”ì  ì¸í„°í˜ì´ìŠ¤)
        });
    </script>
    
    <!-- PWA ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ -->
    <script>
        // PWA ì„¤ì¹˜ ê¸°ëŠ¥
        let deferredPrompt;
        let installButton;

        // PWA ì„¤ì¹˜ ë²„íŠ¼ ìƒì„±
        function createInstallButton() {
            if (installButton) return;
            
            installButton = document.createElement('button');
            installButton.className = 'btn npay-button pwa-install-btn';
            installButton.innerHTML = '<span class="npay-logo">ğŸ“±</span>ì•±ìœ¼ë¡œ ì„¤ì¹˜';
            installButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3);
                border-radius: 25px;
                font-size: 14px;
                padding: 12px 20px;
            `;
            
            installButton.addEventListener('click', installPWA);
            document.body.appendChild(installButton);
        }

        // PWA ì„¤ì¹˜ ì‹¤í–‰
        async function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('ì‚¬ìš©ìê°€ PWA ì„¤ì¹˜ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.');
                showNotification('ì•± ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í™ˆ í™”ë©´ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
            } else {
                console.log('ì‚¬ìš©ìê°€ PWA ì„¤ì¹˜ë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.');
            }
            
            deferredPrompt = null;
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        }

        // ì„¤ì¹˜ ê°€ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            createInstallButton();
        });

        // ì•± ì„¤ì¹˜ ì™„ë£Œ ì´ë²¤íŠ¸
        window.addEventListener('appinstalled', () => {
            console.log('PWAê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            showNotification('ë§ˆì´ë°ì´í„° íˆ¬ì ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        });

        // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë¹„í™œì„±í™”)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì„œë¹„ìŠ¤ ì›Œì»¤ ìºì‹œ ë°©ì§€
                if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                    console.log('ğŸ”„ ê°œë°œ í™˜ê²½: ì„œë¹„ìŠ¤ ì›Œì»¤ ë¹„í™œì„±í™” (ìºì‹œ ë°©ì§€)');
                    
                    // ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ ì œê±°
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        registrations.forEach(registration => {
                            registration.unregister();
                            console.log('ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ ì œê±°ë¨');
                        });
                    } catch (error) {
                        console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ì œê±° ì‹¤íŒ¨:', error);
                    }
                    return;
                }
                
                // í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œë§Œ ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', registration.scope);
                    
                    // ì„œë¹„ìŠ¤ ì›Œì»¤ ì—…ë°ì´íŠ¸ í™•ì¸
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                } catch (error) {
                    console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', error);
                }
            });
        }

        // ì—…ë°ì´íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showUpdateNotification() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'update-banner';
            updateBanner.innerHTML = `
                <div style="background: var(--npay-green); color: white; padding: 12px 20px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;">
                    <span>ìƒˆ ì—…ë°ì´íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤!</span>
                    <button onclick="refreshApp()" style="background: white; color: var(--npay-green); border: none; padding: 4px 12px; margin-left: 12px; border-radius: 4px; cursor: pointer;">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 4px 12px; margin-left: 8px; border-radius: 4px; cursor: pointer;">
                        ë‚˜ì¤‘ì—
                    </button>
                </div>
            `;
            document.body.appendChild(updateBanner);
        }

        // ì•± ìƒˆë¡œê³ ì¹¨
        function refreshApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.waiting?.postMessage({ type: 'SKIP_WAITING' });
                });
                window.location.reload();
            }
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--npay-green)' : 'var(--info)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .pwa-install-btn {
                transition: all 0.3s ease;
            }
            .pwa-install-btn:hover {
                transform: scale(1.05);
            }
        `;
        document.head.appendChild(style);

        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        window.addEventListener('online', () => {
            showNotification('ì¸í„°ë„· ì—°ê²°ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('ì˜¤í”„ë¼ì¸ ëª¨ë“œì…ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        });

        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            let html = markdown
                // í—¤ë” ë³€í™˜ (ì ì ˆí•œ ìŠ¤íƒ€ì¼ë§)
                .replace(/^### (.*$)/gim, '<h3 style="color: #333; font-size: 1.1em; font-weight: 600; margin: 12px 0 8px 0;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="color: #03C75A; font-size: 1.2em; font-weight: 600; margin: 15px 0 10px 0;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="color: #03C75A; font-size: 1.4em; font-weight: 700; margin: 18px 0 12px 0;">$1</h1>')
                // ë³¼ë“œ í…ìŠ¤íŠ¸ ë³€í™˜
                .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #333;">$1</strong>')
                // ì´íƒ¤ë¦­ í…ìŠ¤íŠ¸ ë³€í™˜
                .replace(/\*(.*?)\*/g, '<em style="font-style: italic; color: #666;">$1</em>')
                // ë¦¬ìŠ¤íŠ¸ ë³€í™˜
                .replace(/^\* (.*$)/gim, '<li style="margin: 3px 0;">$1</li>')
                .replace(/^- (.*$)/gim, '<li style="margin: 3px 0;">$1</li>')
                // ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ë³€í™˜
                .replace(/^\d+\. (.*$)/gim, '<li style="margin: 3px 0;">$1</li>')
                // ë§í¬ ë³€í™˜
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #03C75A; text-decoration: none;">$1</a>')
                // ì¤„ë°”ê¿ˆ ë³€í™˜
                .replace(/\n/g, '<br>');
            
            // ì—°ì†ëœ <li> íƒœê·¸ë¥¼ <ul>ë¡œ ê°ì‹¸ê¸°
            html = html.replace(/(<li[^>]*>.*?<\/li>)(\s*<br>\s*<li[^>]*>.*?<\/li>)*/g, function(match) {
                const listItems = match.replace(/<br>\s*/g, '');
                return `<ul style="margin: 8px 0; padding-left: 16px; list-style-type: disc;">${listItems}</ul>`;
            });
            
            // ì—°ì†ëœ <br> íƒœê·¸ ì •ë¦¬ (3ê°œ ì´ìƒì„ 2ê°œë¡œ)
            html = html.replace(/(<br>\s*){3,}/g, '<br><br>');
            
            return html;
        }

        // ì•± ë²„ì „ ì²´í¬
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                const channel = new MessageChannel();
                channel.port1.onmessage = event => {
                    console.log('ì•± ë²„ì „:', event.data.version);
                };
                registration.active?.postMessage({ type: 'GET_VERSION' }, [channel.port2]);
            });
        }
    </script>
</body>
</html>
