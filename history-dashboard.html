<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투자 히스토리 대시보드 - 마이데이터</title>
    
    <!-- PWA 메타 태그 -->
    <meta name="description" content="포트폴리오 히스토리 및 투자 성과 분석 대시보드">
    <meta name="theme-color" content="#03C75A">
    <link rel="manifest" href="manifest.json">
    
    <!-- 스타일시트 -->
    <link rel="stylesheet" href="style.css">
    
    <!-- 차트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }
        
        .stat-value.positive {
            color: var(--npay-green);
        }
        
        .stat-value.negative {
            color: var(--error);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .chart-section {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
        }
        
        .chart-controls button {
            padding: 6px 12px;
            border: 1px solid var(--gray-200);
            background: var(--white);
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chart-controls button.active {
            background: var(--npay-green);
            color: var(--white);
            border-color: var(--npay-green);
        }
        
        .portfolio-list {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            transition: background 0.2s ease;
        }
        
        .portfolio-item:hover {
            background: var(--gray-100);
        }
        
        .portfolio-item:last-child {
            border-bottom: none;
        }
        
        .portfolio-info {
            flex: 1;
        }
        
        .portfolio-date {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }
        
        .portfolio-summary {
            font-size: 0.9rem;
            color: var(--gray-600);
        }
        
        .portfolio-performance {
            text-align: right;
        }
        
        .portfolio-return {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .portfolio-amount {
            font-size: 0.9rem;
            color: var(--gray-600);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-600);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
        
        .data-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-200);
            border-top: 2px solid var(--npay-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .chart-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .data-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1>📊 투자 히스토리 대시보드</h1>
            <div class="naverpay-logo">
                <div class="logo-placeholder">Npay 데이터</div>
            </div>
        </header>

        <!-- 데이터 제어 버튼 -->
        <div class="data-controls">
            <button class="btn secondary" onclick="loadDashboardData()">
                <span id="refresh-icon">🔄</span> 데이터 새로고침
            </button>
            <button class="btn secondary" onclick="exportData()">📤 데이터 내보내기</button>
            <button class="btn secondary" onclick="importData()">📥 데이터 가져오기</button>
            <button class="btn secondary" onclick="clearAllData()">🗑️ 모든 데이터 삭제</button>
            <button class="btn primary" onclick="goToMainApp()">🚀 메인 앱으로</button>
        </div>

        <!-- 통계 카드 -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-portfolios">-</div>
                <div class="stat-label">총 포트폴리오 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-return">-</div>
                <div class="stat-label">평균 수익률</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="best-performance">-</div>
                <div class="stat-label">최고 수익률</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-investment">-</div>
                <div class="stat-label">총 투자금액</div>
            </div>
        </div>

        <!-- 성과 차트 -->
        <div class="chart-section">
            <div class="chart-header">
                <h2 class="chart-title">포트폴리오 성과 추이</h2>
                <div class="chart-controls">
                    <button class="active" onclick="changeChartPeriod('7d')">7일</button>
                    <button onclick="changeChartPeriod('30d')">30일</button>
                    <button onclick="changeChartPeriod('90d')">90일</button>
                    <button onclick="changeChartPeriod('1y')">1년</button>
                </div>
            </div>
            <canvas id="performanceChart" width="400" height="200"></canvas>
        </div>

        <!-- 포트폴리오 히스토리 -->
        <div class="portfolio-list">
            <h2 class="section-title">포트폴리오 히스토리</h2>
            <div id="portfolio-history">
                <div class="empty-state">
                    <div class="empty-state-icon">📈</div>
                    <p>저장된 포트폴리오가 없습니다.</p>
                    <p>메인 앱에서 포트폴리오를 분석하고 저장해보세요!</p>
                </div>
            </div>
        </div>

        <!-- 파일 입력 (숨김) -->
        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleFileImport(event)">
    </div>

    <!-- 데이터베이스 및 메인 스크립트 -->
    <script src="database.js"></script>
    <script>
        let db;
        let performanceChart;
        let currentPeriod = '7d';

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeApp();
            } catch (error) {
                console.error('앱 초기화 실패:', error);
                showError('데이터베이스 초기화에 실패했습니다.');
            }
        });

        // 앱 초기화
        async function initializeApp() {
            showLoading('refresh-icon');
            
            // 데이터베이스 초기화
            db = await initializeDatabase();
            
            // 대시보드 데이터 로드
            await loadDashboardData();
            
            // 성과 차트 초기화
            initializeChart();
            
            hideLoading('refresh-icon');
        }

        // 대시보드 데이터 로드
        async function loadDashboardData() {
            try {
                showLoading('refresh-icon');
                
                // 통계 정보 로드
                const stats = await db.getStatistics();
                updateStatsDisplay(stats);
                
                // 포트폴리오 히스토리 로드
                const portfolios = await db.getPortfolios('default', 50);
                updatePortfolioHistory(portfolios);
                
                // 성과 차트 업데이트
                await updatePerformanceChart();
                
                hideLoading('refresh-icon');
                
                if (portfolios.length === 0) {
                    showInfo('아직 저장된 포트폴리오가 없습니다. 메인 앱에서 포트폴리오를 분석해보세요!');
                }
                
            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
                showError('데이터 로드 중 오류가 발생했습니다.');
                hideLoading('refresh-icon');
            }
        }

        // 통계 표시 업데이트
        function updateStatsDisplay(stats) {
            document.getElementById('total-portfolios').textContent = stats.totalPortfolios;
            
            const avgReturn = document.getElementById('avg-return');
            avgReturn.textContent = stats.avgReturnRate.toFixed(2) + '%';
            avgReturn.className = 'stat-value ' + (stats.avgReturnRate >= 0 ? 'positive' : 'negative');
            
            const bestPerf = document.getElementById('best-performance');
            bestPerf.textContent = stats.bestPerformance.toFixed(2) + '%';
            bestPerf.className = 'stat-value ' + (stats.bestPerformance >= 0 ? 'positive' : 'negative');
            
            document.getElementById('total-investment').textContent = 
                (stats.totalInvestment / 10000).toFixed(0) + '만원';
        }

        // 포트폴리오 히스토리 업데이트
        function updatePortfolioHistory(portfolios) {
            const container = document.getElementById('portfolio-history');
            
            if (portfolios.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📈</div>
                        <p>저장된 포트폴리오가 없습니다.</p>
                        <p>메인 앱에서 포트폴리오를 분석하고 저장해보세요!</p>
                    </div>
                `;
                return;
            }

            const itemsHtml = portfolios.map(portfolio => {
                const date = new Date(portfolio.timestamp).toLocaleDateString('ko-KR');
                const time = new Date(portfolio.timestamp).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const stockCount = Object.keys(portfolio.stocks || {}).length;
                const performance = portfolio.performance;
                const returnClass = performance.returnRate >= 0 ? 'positive' : 'negative';
                
                return `
                    <div class="portfolio-item" onclick="viewPortfolioDetail(${portfolio.id})">
                        <div class="portfolio-info">
                            <div class="portfolio-date">${date} ${time}</div>
                            <div class="portfolio-summary">
                                ${stockCount}개 종목 • ${(performance.totalInvestment / 10000).toFixed(0)}만원 투자
                            </div>
                        </div>
                        <div class="portfolio-performance">
                            <div class="portfolio-return ${returnClass}">
                                ${performance.returnRate >= 0 ? '+' : ''}${performance.returnRate.toFixed(2)}%
                            </div>
                            <div class="portfolio-amount">
                                ${(performance.totalValue / 10000).toFixed(0)}만원
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = itemsHtml;
        }

        // 성과 차트 초기화
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '포트폴리오 가치',
                        data: [],
                        borderColor: '#03C75A',
                        backgroundColor: 'rgba(3, 199, 90, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }, {
                        label: '수익률',
                        data: [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '날짜'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '포트폴리오 가치 (원)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value / 10000).toFixed(0) + '만원';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '수익률 (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return '포트폴리오 가치: ' + (context.raw / 10000).toFixed(0) + '만원';
                                    } else {
                                        return '수익률: ' + context.raw.toFixed(2) + '%';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 성과 차트 업데이트
        async function updatePerformanceChart() {
            try {
                const portfolios = await db.getPortfolios('default', 100);
                
                if (portfolios.length === 0) {
                    performanceChart.data.labels = [];
                    performanceChart.data.datasets[0].data = [];
                    performanceChart.data.datasets[1].data = [];
                    performanceChart.update();
                    return;
                }

                // 기간별 필터링
                const days = periodToDays(currentPeriod);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                const filteredPortfolios = portfolios.filter(p => 
                    new Date(p.timestamp) >= cutoffDate
                ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const labels = filteredPortfolios.map(p => 
                    new Date(p.timestamp).toLocaleDateString('ko-KR', { 
                        month: 'short', 
                        day: 'numeric' 
                    })
                );
                
                const values = filteredPortfolios.map(p => p.performance.totalValue);
                const returns = filteredPortfolios.map(p => p.performance.returnRate);

                performanceChart.data.labels = labels;
                performanceChart.data.datasets[0].data = values;
                performanceChart.data.datasets[1].data = returns;
                performanceChart.update();
                
            } catch (error) {
                console.error('차트 업데이트 실패:', error);
            }
        }

        // 차트 기간 변경
        async function changeChartPeriod(period) {
            currentPeriod = period;
            
            // 버튼 상태 업데이트
            document.querySelectorAll('.chart-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 차트 업데이트
            await updatePerformanceChart();
        }

        // 기간을 일수로 변환
        function periodToDays(period) {
            switch (period) {
                case '7d': return 7;
                case '30d': return 30;
                case '90d': return 90;
                case '1y': return 365;
                default: return 30;
            }
        }

        // 포트폴리오 상세 보기
        function viewPortfolioDetail(portfolioId) {
            // 상세 모달 또는 새 페이지로 이동 (구현 예정)
            alert(`포트폴리오 상세 보기 (ID: ${portfolioId})\n\n이 기능은 다음 버전에서 구현됩니다.`);
        }

        // 데이터 내보내기
        async function exportData() {
            try {
                showLoading('export');
                const exportData = await db.exportData();
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mydata-investment-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('데이터 내보내기가 완료되었습니다.');
                hideLoading('export');
                
            } catch (error) {
                console.error('데이터 내보내기 실패:', error);
                showError('데이터 내보내기 중 오류가 발생했습니다.');
                hideLoading('export');
            }
        }

        // 데이터 가져오기
        function importData() {
            document.getElementById('import-file').click();
        }

        // 파일 가져오기 처리
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importData = JSON.parse(text);
                
                const count = await db.importData(importData);
                showSuccess(`${count}개의 포트폴리오를 가져왔습니다.`);
                
                // 대시보드 새로고침
                await loadDashboardData();
                
            } catch (error) {
                console.error('데이터 가져오기 실패:', error);
                showError('유효하지 않은 파일 형식입니다.');
            }
            
            // 파일 입력 리셋
            event.target.value = '';
        }

        // 모든 데이터 삭제
        async function clearAllData() {
            if (!confirm('정말로 모든 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            try {
                await db.clearStore('portfolios');
                await db.clearStore('performanceHistory');
                await db.clearStore('investmentAdvice');
                await db.clearStore('marketData');
                
                showSuccess('모든 데이터가 삭제되었습니다.');
                await loadDashboardData();
                
            } catch (error) {
                console.error('데이터 삭제 실패:', error);
                showError('데이터 삭제 중 오류가 발생했습니다.');
            }
        }

        // 메인 앱으로 이동
        function goToMainApp() {
            window.location.href = 'market-data-integration.html';
        }

        // 유틸리티 함수들
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '<span class="loading-spinner"></span>';
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element && elementId === 'refresh-icon') {
                element.innerHTML = '🔄';
            }
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showInfo(message) {
            showNotification(message, 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--npay-green)' : 
                             type === 'error' ? 'var(--error)' : 'var(--info)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
