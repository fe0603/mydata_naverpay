<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>κ°„λ‹¨ν• ν¬νΈν΄λ¦¬μ¤ ν…μ¤νΈ</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn { 
            background: #03C75A; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 15px 10px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
        }
        .btn:hover { background: #02a049; }
        .input-group {
            margin: 20px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .result { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid #dee2e6; 
            min-height: 100px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
        }
        .notification.success { background: #03C75A; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #000; }
        .notification.info { background: #17a2b8; }
        h1 { color: #03C75A; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 6px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>π€ κ°„λ‹¨ν• ν¬νΈν΄λ¦¬μ¤ ν…μ¤νΈ</h1>
        
        <div class="input-group">
            <label for="portfolio-input">ν¬νΈν΄λ¦¬μ¤ μ…λ ¥:</label>
            <input type="text" id="portfolio-input" 
                   value="μ‚Όμ„±μ „μ 10μ£Ό, μΉ΄μΉ΄μ¤ 5" 
                   placeholder="μ: μ‚Όμ„±μ „μ 10μ£Ό, μΉ΄μΉ΄μ¤ 5">
        </div>
        
        <div class="input-group">
            <label for="amount-input">μ΄ ν¬μκΈμ•΅:</label>
            <input type="number" id="amount-input" 
                   value="10000000" 
                   placeholder="10000000">
        </div>
        
        <div style="text-align: center;">
            <button class="btn" onclick="testPortfolioAnalysis()">ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ ν…μ¤νΈ</button>
            <button class="btn" onclick="testAPIConnection()">API μ—°κ²° ν…μ¤νΈ</button>
            <button class="btn" onclick="clearResults()">κ²°κ³Ό μ§€μ°κΈ°</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        <div id="result" class="result">
            <h4>π” ν…μ¤νΈ κ²°κ³Ό</h4>
            <p>μ„ λ²„νΌμ„ ν΄λ¦­ν•΄μ„ ν…μ¤νΈλ¥Ό μ‹μ‘ν•μ„Έμ”.</p>
        </div>
    </div>

    <script>
        // π“ ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ ν…μ¤νΈ
        async function testPortfolioAnalysis() {
            console.log('π” ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ ν…μ¤νΈ μ‹μ‘');
            
            try {
                showStatus('ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ μ¤‘...', 'info');
                
                const portfolioText = document.getElementById('portfolio-input').value;
                const amount = parseInt(document.getElementById('amount-input').value);
                
                console.log('π“ μ…λ ¥κ°’:', { portfolioText, amount });
                
                if (!portfolioText || !amount) {
                    throw new Error('ν¬νΈν΄λ¦¬μ¤μ™€ ν¬μκΈμ•΅μ„ λ¨λ‘ μ…λ ¥ν•΄μ£Όμ„Έμ”.');
                }
                
                // 1λ‹¨κ³„: ν¬νΈν΄λ¦¬μ¤ νμ‹±
                const portfolio = parsePortfolioSimple(portfolioText);
                console.log('π“ νμ‹±λ ν¬νΈν΄λ¦¬μ¤:', portfolio);
                
                // 2λ‹¨κ³„: μ‹¤μ  API νΈμ¶ ν…μ¤νΈ
                const apiResults = await Promise.all(
                    Object.keys(portfolio).map(async (stockName) => {
                        try {
                            const response = await fetch(`/api/yahoo-finance/${encodeURIComponent(stockName)}`);
                            const data = await response.json();
                            return { stockName, data, success: data.success };
                        } catch (error) {
                            return { stockName, error: error.message, success: false };
                        }
                    })
                );
                
                // 3λ‹¨κ³„: κ²°κ³Ό κ³„μ‚°
                let totalValue = 0;
                let results = [];
                
                apiResults.forEach(({ stockName, data, success }) => {
                    const shares = portfolio[stockName];
                    const price = success ? data.price : 50000;
                    const value = shares * price;
                    totalValue += value;
                    
                    results.push({
                        stockName,
                        shares,
                        price,
                        value,
                        success,
                        demoMode: data?.demoMode || false
                    });
                });
                
                // 4λ‹¨κ³„: κ²°κ³Ό ν‘μ‹
                displayResults(results, totalValue, amount);
                showStatus('β… ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ μ™„λ£!', 'success');
                showNotification('ν¬νΈν΄λ¦¬μ¤ λ¶„μ„μ΄ μ™„λ£λμ—μµλ‹λ‹¤!', 'success');
                
            } catch (error) {
                console.error('β ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ μ¤λ¥:', error);
                showStatus('β μ¤λ¥: ' + error.message, 'error');
                showNotification('μ¤λ¥: ' + error.message, 'error');
            }
        }
        
        // π“ API μ—°κ²° ν…μ¤νΈ
        async function testAPIConnection() {
            console.log('π”— API μ—°κ²° ν…μ¤νΈ μ‹μ‘');
            
            try {
                showStatus('API μ—°κ²° ν…μ¤νΈ μ¤‘...', 'info');
                
                // 1. μ„λ²„ μƒνƒ ν™•μΈ
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                
                // 2. Yahoo Finance API ν…μ¤νΈ
                const yahooResponse = await fetch('/api/yahoo-finance/μ‚Όμ„±μ „μ');
                const yahooData = await yahooResponse.json();
                
                const resultHtml = `
                    <h4>π”— API μ—°κ²° ν…μ¤νΈ κ²°κ³Ό</h4>
                    <div style="margin: 15px 0;">
                        <strong>1οΈβƒ£ μ„λ²„ μƒνƒ:</strong><br>
                        β€Ά μƒνƒ: ${healthData.status}<br>
                        β€Ά ν™κ²½: ${healthData.environment}<br>
                        β€Ά ν¬νΈ: ${healthData.port}<br>
                        β€Ά Gemini API: ${healthData.apis.gemini ? 'β… μ„¤μ •λ¨' : 'β λ―Έμ„¤μ •'}<br>
                        β€Ά KIS API: ${healthData.apis.kis ? 'β… μ„¤μ •λ¨' : 'β λ―Έμ„¤μ •'}
                    </div>
                    <div style="margin: 15px 0;">
                        <strong>2οΈβƒ£ Yahoo Finance API:</strong><br>
                        β€Ά μ„±κ³µ: ${yahooData.success ? 'β…' : 'β'}<br>
                        β€Ά μ‚Όμ„±μ „μ κ°€κ²©: ${formatNumber(yahooData.price)}μ›<br>
                        β€Ά λ³€λ™: ${yahooData.change}μ› (${yahooData.changePercent}%)<br>
                        β€Ά λ°λ¨ λ¨λ“: ${yahooData.demoMode ? 'β…' : 'β'}<br>
                        ${yahooData.message ? `β€Ά λ©”μ‹μ§€: ${yahooData.message}` : ''}
                    </div>
                `;
                
                document.getElementById('result').innerHTML = resultHtml;
                showStatus('β… API μ—°κ²° ν…μ¤νΈ μ™„λ£!', 'success');
                showNotification('API μ—°κ²°μ΄ μ •μƒμ…λ‹λ‹¤!', 'success');
                
            } catch (error) {
                console.error('β API μ—°κ²° μ¤λ¥:', error);
                showStatus('β API μ—°κ²° μ‹¤ν¨: ' + error.message, 'error');
                showNotification('API μ—°κ²° μ‹¤ν¨: ' + error.message, 'error');
            }
        }
        
        // π“ κ°„λ‹¨ν• ν¬νΈν΄λ¦¬μ¤ νμ‹±
        function parsePortfolioSimple(text) {
            const portfolio = {};
            const lines = text.split(',');
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    // "μ‚Όμ„±μ „μ 10μ£Ό" λλ” "μ‚Όμ„±μ „μ 10" ν•νƒ
                    const match = trimmed.match(/(.+?)\s*(\d+)(?:μ£Ό)?/);
                    if (match) {
                        const stockName = match[1].trim();
                        const shares = parseInt(match[2]);
                        portfolio[stockName] = shares;
                    }
                }
            });
            
            return portfolio;
        }
        
        // π“ κ²°κ³Ό ν‘μ‹
        function displayResults(results, totalValue, investmentAmount) {
            const profit = totalValue - investmentAmount;
            const profitRate = ((profit / investmentAmount) * 100).toFixed(2);
            
            let html = '<h4>π“ ν¬νΈν΄λ¦¬μ¤ λ¶„μ„ κ²°κ³Ό</h4>';
            
            results.forEach(({ stockName, shares, price, value, success, demoMode }) => {
                const statusIcon = success ? (demoMode ? 'π΅' : 'πΆ') : 'π”΄';
                html += `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 6px;">
                        <strong>${statusIcon} ${stockName}</strong><br>
                        β€Ά λ³΄μ : ${formatNumber(shares)}μ£Ό<br>
                        β€Ά ν„μ¬κ°€: ${formatNumber(price)}μ›<br>
                        β€Ά ν‰κ°€κΈμ•΅: ${formatNumber(value)}μ›<br>
                        β€Ά μƒνƒ: ${success ? (demoMode ? 'λ°λ¨ λ°μ΄ν„°' : 'μ‹¤μ‹κ°„ λ°μ΄ν„°') : 'μ¤λ¥'}
                    </div>
                `;
            });
            
            html += `
                <div style="background: #e7f3ff; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #b6d7ff;">
                    <h4>π’° ν¬μ μ”μ•½</h4>
                    β€Ά μ΄ ν¬μκΈμ•΅: ${formatNumber(investmentAmount)}μ›<br>
                    β€Ά ν„μ¬ ν‰κ°€κΈμ•΅: ${formatNumber(totalValue)}μ›<br>
                    β€Ά μ†μµ: ${formatNumber(profit)}μ›<br>
                    β€Ά μμµλ¥ : ${profitRate}%
                </div>
            `;
            
            document.getElementById('result').innerHTML = html;
        }
        
        // π’΅ μ ν‹Έλ¦¬ν‹° ν•¨μλ“¤
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function clearResults() {
            document.getElementById('result').innerHTML = `
                <h4>π” ν…μ¤νΈ κ²°κ³Ό</h4>
                <p>μ„ λ²„νΌμ„ ν΄λ¦­ν•΄μ„ ν…μ¤νΈλ¥Ό μ‹μ‘ν•μ„Έμ”.</p>
            `;
            document.getElementById('status').style.display = 'none';
            console.clear();
        }
        
        // νμ΄μ§€ λ΅λ“ μ™„λ£
        document.addEventListener('DOMContentLoaded', () => {
            console.log('β… κ°„λ‹¨ν• ν¬νΈν΄λ¦¬μ¤ ν…μ¤νΈ νμ΄μ§€ λ΅λ”© μ™„λ£');
            showNotification('νμ΄μ§€ λ΅λ”© μ™„λ£ - ν…μ¤νΈλ¥Ό μ‹μ‘ν•μ„Έμ”!', 'info');
        });
        
        // μ „μ—­ μ¤λ¥ ν•Έλ“¤λ¬
        window.addEventListener('error', (e) => {
            console.error('β JavaScript μ¤λ¥:', e.message, e.filename, e.lineno);
            showStatus(`β JavaScript μ¤λ¥: ${e.message}`, 'error');
        });
    </script>
</body>
</html>
